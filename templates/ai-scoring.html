<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‡ªåŠ¨è¯„åˆ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5em;
        }

        .back-btn {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* åˆ†é¡µæ§ä»¶æ ·å¼ä¼˜åŒ–ï¼ˆç½®é¡¶åï¼‰ */
        .pagination {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .pagination button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination .page-info {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #667eea;
            min-width: 150px;
            text-align: center;
        }

        .pagination .jump-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination .jump-input {
            width: 80px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .pagination .jump-btn {
            min-width: 80px;
        }

        .student-info {
            padding: 20px 30px;
            background: #fff9e6;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info h2 {
            color: #764ba2;
            font-size: 1.5em;
        }

        /* ä½œæ–‡å±•ç¤ºåŒºåŸŸ - æ¨ªå‘å¸ƒå±€ */
        .essay-display {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px 20px 0;
            align-items: stretch;
        }

        /* æ ¸å¿ƒä¿®æ”¹ï¼šä½œæ–‡å†…å®¹åˆ†æ æ ·å¼ */
        .essay-content-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .essay-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
            align-items: start;
        }

        /* ç­”å·å›¾ç‰‡å®¹å™¨ */
        .essay-image-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .essay-image-container:hover {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .image-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .essay-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }

        .no-image-text {
            color: #999;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        /* æ–‡æœ¬å†…å®¹å®¹å™¨ */
        .essay-text-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            height: 100%;
        }

        /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9); /* é»‘è‰²èƒŒæ™¯å¸¦é€æ˜åº¦ */
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoom 0.4s;
        }

        @keyframes zoom {
            from {transform: scale(0.1)}
            to {transform: scale(1)}
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .essay-requirement-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .essay-content-section h3,
        .essay-requirement-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .essay-requirement-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .essay-requirement-section .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .essay-requirement-section .form-group textarea {
            flex: 1;
            min-height: 0;
            resize: none;
        }

        /* åˆ†æå’Œè¯„åˆ†åŒºåŸŸ - ç«–å‘å·¦å³åˆ†æ  */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .text-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            font-size: 15px;
            height: 100%;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 300px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .version-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .version-control label {
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }

        .version-control select {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        .version-control button {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .version-control button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* è¯„ä»·/è¯„åˆ†è®°å½•é€‰æ‹©å™¨æ ·å¼ */
        .record-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 15px 0; /* è°ƒæ•´marginï¼Œé€‚é…ç»“æœåŒºåŸŸå†…çš„å¸ƒå±€ */
            flex-wrap: wrap;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
        }

        .record-selector label {
            font-weight: bold;
            color: #333;
            min-width: 80px;
        }

        .record-selector select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .record-info {
            font-size: 13px;
            color: #666;
            margin: 0 0 15px 0; /* è°ƒæ•´marginï¼Œé€‚é…ç»“æœåŒºåŸŸå†…çš„å¸ƒå±€ */
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .score-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .score-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .score-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .scores-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .score-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .score-column {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .score-column h4 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1em;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .score-column.original h4 {
            color: #ff9800;
        }

        .score-column.ai h4 {
            color: #4caf50;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .score-item.total {
            background: #fff9e6;
            border-left-color: #ff9800;
            font-weight: bold;
            font-size: 1.05em;
        }

        .score-item.ai-total {
            background: #e8f5e9;
            border-left-color: #4caf50;
            font-weight: bold;
            font-size: 1.05em;
        }

        .score-label {
            color: #333;
            font-size: 14px;
        }

        .score-value {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        .score-item.total .score-value {
            color: #ff9800;
        }

        .score-item.ai-total .score-value {
            color: #4caf50;
        }

        .empty-result {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 15px;
        }

        .empty-result .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .analysis-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .analysis-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-title {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-badge {
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .analysis-list {
            list-style: none;
            padding-left: 0;
        }

        .analysis-list li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: 14px;
        }

        .error-item {
            border-left-color: #f44336;
        }

        .highlight-item {
            border-left-color: #4caf50;
        }

        .suggestion-item {
            border-left-color: #ff9800;
        }

        .overall-quality {
            display: inline-block;
            padding: 6px 16px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1400px) {
            .essay-display {
                grid-template-columns: 1fr;
            }

            .essay-content-grid {
                grid-template-columns: 1fr; /* å°å±å¹•ä¸‹å›¾ç‰‡å’Œæ–‡æœ¬ç«–å‘æ’åˆ— */
                gap: 15px;
            }
            
            .essay-image-container {
                min-height: 300px;
            }
            
            .essay-image {
                max-height: 300px;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .score-comparison {
                grid-template-columns: 1fr;
            }

            .record-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination {
                padding: 15px 20px;
                gap: 10px;
            }
            
            .pagination .page-info {
                min-width: 120px;
                padding: 8px 15px;
            }
            
            .pagination button {
                min-width: 80px;
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIè‡ªåŠ¨è¯„åˆ†</h1>
            <button class="back-btn" onclick="goBack()">â† è¿”å›ä¸»é¡µ</button>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ï¼ˆç½®é¡¶ï¼‰ -->
        <div class="pagination">
            <button id="prevBtn" onclick="previousEssay()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <div class="page-info">
                <span id="pageInfo">1 / 934</span>
            </div>
            <button id="nextBtn" onclick="nextEssay()">ä¸‹ä¸€é¡µ â¡ï¸</button>
            <div class="jump-group">
                <label>è·³è½¬åˆ°:</label>
                <input type="number" class="jump-input" id="jumpInput" min="1" max="934" placeholder="é¡µç ">
                <button class="jump-btn" onclick="jumpToPage()">è·³è½¬</button>
            </div>
        </div>

        <div class="student-info" id="studentInfo">
            <h2 id="studentName">å­¦ç”Ÿå§“å</h2>
            <span id="directoryName" style="color: #666;"></span>
        </div>

        <!-- ä½œæ–‡å±•ç¤ºåŒºåŸŸ(æ¨ªå‘å¸ƒå±€) -->
        <div class="essay-display">
            <!-- ä½œæ–‡å†…å®¹ (2/3å®½åº¦) - æ ¸å¿ƒä¿®æ”¹ï¼šæ‹†åˆ†ä¸ºå›¾ç‰‡+æ–‡æœ¬ä¸¤æ  -->
            <div class="section essay-content-section">
                <h3>ğŸ“– ä½œæ–‡å†…å®¹ <span id="wordCount" style="color: #ff9800; font-size: 0.9em; font-weight: normal;"></span></h3>
                <div class="essay-content-grid">
                    <!-- å·¦è¾¹ï¼šç­”å·å›¾ç‰‡ -->
                    <div class="essay-image-container">
                        <div class="image-wrapper" id="essayImageWrapper">
                            <img id="essayImage" src="" alt="ä½œæ–‡ç­”å·å›¾ç‰‡" class="essay-image" style="display: none;">
                            <div class="no-image-text" id="noImageText">æš‚æ— ç­”å·å›¾ç‰‡</div>
                        </div>
                    </div>
                    <!-- å³è¾¹ï¼šæ–‡æœ¬å†…å®¹ -->
                    <div class="essay-text-container">
                        <div class="text-content" id="essayContent"></div>
                    </div>
                </div>
            </div>

            <!-- ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚ (1/3å®½åº¦) -->
            <div class="section essay-requirement-section">
                <h3>ğŸ“ ä½œæ–‡é¢˜ç›®ä¸è¦æ±‚</h3>
                <div class="form-group">
                    <label>ä½œæ–‡é¢˜ç›®ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="essayTitle" placeholder="è¾“å…¥ä½œæ–‡é¢˜ç›®ï¼ˆå¯é€‰ï¼‰&#10;ä¾‹å¦‚ï¼šç§‹å¤©çš„æ•…äº‹"></textarea>
                </div>
                <div class="form-group">
                    <label>ä½œæ–‡è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="essayRequirement" placeholder="è¾“å…¥ä½œæ–‡è¦æ±‚ï¼ˆå¯é€‰ï¼‰&#10;ä¾‹å¦‚ï¼š&#10;1. æ–‡ä½“è‡ªé€‰ï¼ˆè¯—æ­Œé™¤å¤–ï¼‰ï¼Œä¸å°‘äº500å­—&#10;2. æ–‡ä¸­ä¸å¾—å‡ºç°çœŸå®çš„äººåã€æ ¡åã€åœ°å&#10;3. å·é¢æ¸…æ¥šï¼Œå­—è¿¹æ¸…æ™°"></textarea>
                </div>
            </div>
        </div>

        <!-- åˆ†æå’Œè¯„åˆ†åŒºåŸŸ(ç«–å‘å·¦å³åˆ†æ ) -->
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šåˆ†æåŒºåŸŸ -->
            <div class="left-column">
                <!-- åˆ†ææç¤ºè¯ç®¡ç† -->
                <div class="section">
                    <h3>ğŸ” ä½œæ–‡è¯„ä»·æç¤ºè¯</h3>
                    <div class="version-control">
                        <label>ç‰ˆæœ¬é€‰æ‹©:</label>
                        <select id="analyzePromptSelect" onchange="onAnalyzeVersionChange()">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <button onclick="saveAnalyzeVersion()">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="setAnalyzeDefault()">â­ è®¾ä¸ºé»˜è®¤</button>
                    </div>
                    <div class="form-group">
                        <textarea id="analyzePromptContent" placeholder="ä½œæ–‡è¯„ä»·æç¤ºè¯å†…å®¹"></textarea>
                    </div>
                    <button class="score-btn" id="analyzeBtn" onclick="performAnalysis()">
                        ğŸ” ç¬¬ä¸€æ­¥:åˆ†æä½œæ–‡
                    </button>
                </div>

                <!-- ä½œæ–‡åˆ†æç»“æœï¼ˆè¯„ä»·è®°å½•ç§»åˆ°æ­¤å¤„ï¼‰ -->
                <div class="section" id="analysisSection" style="display: none;">
                    <!-- è¯„ä»·è®°å½•é€‰æ‹©å™¨ï¼ˆæ ¸å¿ƒè°ƒæ•´ï¼šç§»åˆ°ç»“æœåŒºåŸŸå†…ï¼‰ -->
                    <div class="record-selector">
                        <label>è¯„ä»·è®°å½•:</label>
                        <select id="evaluationRecordSelect" onchange="onEvaluationRecordChange()">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="record-info" id="evaluationRecordInfo">
                        æš‚æ— è¯„ä»·è®°å½• | ç‚¹å‡»"ç¬¬ä¸€æ­¥:åˆ†æä½œæ–‡"åˆ›å»ºæ–°è¯„ä»·
                    </div>
                    
                    <h3>ğŸ“‹ ä½œæ–‡åˆ†æç»“æœ</h3>
                    <div class="analysis-content" id="analysisContent">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯„åˆ†åŒºåŸŸ -->
            <div class="right-column">
                <!-- è¯„åˆ†æç¤ºè¯ç®¡ç† -->
                <div class="section">
                    <h3>ğŸ¯ ä½œæ–‡è¯„åˆ†æç¤ºè¯</h3>
                    <div class="version-control">
                        <label>ç‰ˆæœ¬é€‰æ‹©:</label>
                        <select id="scorePromptSelect" onchange="onScoreVersionChange()">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <button onclick="saveScoreVersion()">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="setScoreDefault()">â­ è®¾ä¸ºé»˜è®¤</button>
                    </div>
                    <div class="form-group">
                        <textarea id="scorePromptContent" placeholder="ä½œæ–‡è¯„åˆ†æç¤ºè¯å†…å®¹"></textarea>
                    </div>
                    <button class="score-btn" id="scoreBtn" onclick="performScoring()" disabled>
                        ğŸ¯ ç¬¬äºŒæ­¥:AIè¯„åˆ†
                    </button>
                </div>

                <!-- è¯„åˆ†ç»“æœå¯¹æ¯”ï¼ˆè¯„åˆ†è®°å½•ç§»åˆ°æ­¤å¤„ï¼‰ -->
                <div class="section">
                    <!-- è¯„åˆ†è®°å½•é€‰æ‹©å™¨ï¼ˆæ ¸å¿ƒè°ƒæ•´ï¼šç§»åˆ°ç»“æœåŒºåŸŸå†…ï¼‰ -->
                    <div class="record-selector">
                        <label>è¯„åˆ†è®°å½•:</label>
                        <select id="scoreRecordSelect" onchange="onScoreRecordChange()">
                            <option value="">è¯·å…ˆé€‰æ‹©è¯„ä»·è®°å½•</option>
                        </select>
                    </div>
                    <div class="record-info" id="scoreRecordInfo">
                        æš‚æ— è¯„åˆ†è®°å½• | å®Œæˆåˆ†æåå¯è¿›è¡Œè¯„åˆ†
                    </div>
                    
                    <h3>ğŸ“Š è¯„åˆ†ç»“æœå¯¹æ¯”</h3>
                    <div class="scores-section">
                        <div class="score-comparison">
                            <!-- åŸå§‹è¯„åˆ† -->
                            <div class="score-column original">
                                <h4>ğŸ“‹ åŸå§‹è¯„åˆ†</h4>
                                <div id="originalScores">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <!-- AIè¯„åˆ† -->
                            <div class="score-column ai">
                                <h4>ğŸ¤– AIè¯„åˆ†</h4>
                                <div id="aiScores">
                                    <div class="empty-result">
                                        <div class="icon">ğŸ¯</div>
                                        <div>å®Œæˆåˆ†æå<br>ç‚¹å‡»è¯„åˆ†æŒ‰é’®</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- æ–°å¢ï¼šè¯„åˆ†å¯¹æ¯”åé¦ˆæ¨¡å— -->
                        <div class="feedback-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“ è¯„åˆ†å¯¹æ¯”åé¦ˆ</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="margin-right: 15px;">
                                    <input type="radio" name="whichAccurate" value="original" checked> åŸå§‹è¯„åˆ†æ›´å‡†ç¡®
                                </label>
                                <label>
                                    <input type="radio" name="whichAccurate" value="ai"> AIè¯„åˆ†æ›´å‡†ç¡®
                                </label>
                            </div>
                            <!-- æ–°å¢ï¼šä¸ªäººè®¤ä¸ºåˆé€‚çš„è¯„åˆ†è¾“å…¥æ¡† -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>ä¸ªäººè®¤ä¸ºåˆé€‚çš„è¯„åˆ†ï¼ˆæ•´æ•°ï¼‰</label>
                                <input type="number" id="userScore" min="0" step="1" placeholder="è¯·è¾“å…¥æ•´æ•°è¯„åˆ†ï¼ˆå¦‚40ï¼‰" 
                                       style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;">
                            </div>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>åé¦ˆç†ç”±ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea id="feedbackReason" placeholder="è¯·è¾“å…¥åé¦ˆç†ç”±ï¼ˆä¾‹å¦‚ï¼šåŸå§‹è¯„åˆ†æ›´è´´åˆé¢˜ç›®è¦æ±‚ï¼‰..." style="min-height: 100px;"></textarea>
                            </div>
                            <button id="submitFeedbackBtn" onclick="submitComparisonFeedback()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                æäº¤åé¦ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="message" id="message"></div>

    <script>
        const API_BASE = 'http://localhost:8008/api';
        const TOTAL_PAGES = 934; // å›ºå®šæ€»é¡µæ•°
        const scoreDimensionMap = {
            'theme_and_intent': 'ä¸­å¿ƒç«‹æ„',
            'language_expression': 'è¯­è¨€è¡¨è¾¾',
            'structure': 'ç¯‡ç« ç»“æ„',
            'content_selection': 'æ–‡ç« é€‰æ',
            'emotion_and_content': 'å†…å®¹æƒ…æ„Ÿ'
        };
        let currentEssay = null;      // å½“å‰ä½œæ–‡è¯¦æƒ…
        let currentEssayId = null;    // å½“å‰ä½œæ–‡IDï¼ˆä¸é¡µæ•°ä¸€è‡´ï¼‰
        let currentPage = 1;          // å½“å‰é¡µ
        let analyzePromptsData = [];  // ä½œæ–‡è¯„ä»·æç¤ºè¯åˆ—è¡¨
        let scorePromptsData = [];    // ä½œæ–‡è¯„åˆ†æç¤ºè¯åˆ—è¡¨
        let currentAnalysis = null;   // å­˜å‚¨å½“å‰ä½œæ–‡çš„åˆ†æç»“æœ
        let currentEvaluationId = null; // å­˜å‚¨åˆ†ææ¥å£è¿”å›çš„è¯„ä»·ID
        let evaluationRecords = [];   // ä½œæ–‡è¯„ä»·è®°å½•åˆ—è¡¨
        let scoreRecords = [];        // å½“å‰è¯„ä»·å¯¹åº”çš„è¯„åˆ†è®°å½•åˆ—è¡¨

        // ä»URLè·å–å½“å‰é¡µï¼ˆessay_idå³é¡µæ•°ï¼‰
        function getEssayIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            const essayId = parseInt(params.get('essay_id')) || 1;
            // é™åˆ¶é¡µæ•°åœ¨1~934ä¹‹é—´
            return Math.max(1, Math.min(essayId, TOTAL_PAGES));
        }

        // æ›´æ–°URLä¸­çš„ä½œæ–‡IDï¼ˆé¡µæ•°ï¼‰
        function updateURL() {
            const newURL = `${window.location.pathname}?essay_id=${currentPage}`;
            window.history.pushState({}, '', newURL);
        }

        // è¯»å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ‰‹æœºå·
        function getCurrentUserPhone() {
            const phone = localStorage.getItem('userPhone');
            if (!phone) {
                showMessage('âš ï¸ æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€,è¯·é‡æ–°ç™»å½•', 'error');
                // å¯é€‰ï¼šè·³å›ç™»å½•é¡µ
                // setTimeout(() => window.location.href = 'login.html', 2000);
                return null;
            }
            return phone;
        }

        // åŠ è½½æŒ‡å®šIDçš„ä½œæ–‡è¯¦æƒ…ï¼ˆID=é¡µæ•°ï¼‰
        async function loadEssayDetail(essayId) {
            currentPage = essayId; // åŒæ­¥å½“å‰é¡µ
            currentEssayId = essayId;

            if (!essayId || essayId < 1 || essayId > TOTAL_PAGES) {
                showMessage('âš ï¸ æ— æ•ˆçš„ä½œæ–‡IDï¼ˆé¡µæ•°ï¼‰', 'error');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('essayContent').textContent = 'åŠ è½½ä¸­...';
                document.getElementById('studentName').textContent = 'åŠ è½½ä¸­...';

                const response = await fetch(`${API_BASE}/essays/${essayId}`);
                
                if (response.status === 404) {
                    showMessage('âŒ è¯¥é¡µä½œæ–‡ä¸å­˜åœ¨', 'error');
                    document.getElementById('essayContent').textContent = 'è¯¥é¡µä½œæ–‡ä¸å­˜åœ¨';
                    return;
                }

                const essay = await response.json();
                currentEssay = essay;

                // æ¸²æŸ“ä½œæ–‡æ•°æ®
                renderEssayData(essay);
                
                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                updatePagination();
                
                // æ›´æ–°URL
                updateURL();

                // åŠ è½½è¯„ä»·è®°å½•
                await loadEvaluationRecords();

                showMessage('âœ… ä½œæ–‡è¯¦æƒ…åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                showMessage('âŒ åŠ è½½ä½œæ–‡è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
                console.error('åŠ è½½ä½œæ–‡è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä½œæ–‡è¯„ä»·è®°å½•
        async function loadEvaluationRecords() {
            if (!currentEssayId) return;

            try {
                const response = await fetch(`${API_BASE}/essays/${currentEssayId}/evaluations`);
                const data = await response.json();
                evaluationRecords = data.evaluations || [];
                
                // æ¸²æŸ“è¯„ä»·è®°å½•ä¸‹æ‹‰æ¡†
                renderEvaluationRecords();
                
                // å¦‚æœæœ‰è¯„ä»·è®°å½•ï¼Œé»˜è®¤é€‰ä¸­æœ€æ–°çš„ + æ˜¾ç¤ºåˆ†æåŒºåŸŸ
                if (evaluationRecords.length > 0) {
                    const latestEval = evaluationRecords.find(item => item.is_latest) || evaluationRecords[0];
                    currentEvaluationId = latestEval.evaluation_id;
                    document.getElementById('evaluationRecordSelect').value = currentEvaluationId;
                    // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
                    document.getElementById('analysisSection').style.display = 'block';
                    // åŠ è½½è¯¥è¯„ä»·çš„åˆ†æç»“æœ
                    onEvaluationRecordChange();
                } else {
                    // æ— è®°å½•åˆ™éšè—åˆ†æåŒºåŸŸ
                    document.getElementById('analysisSection').style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½è¯„ä»·è®°å½•å¤±è´¥:', error);
                showMessage('âŒ åŠ è½½è¯„ä»·è®°å½•å¤±è´¥: ' + error.message, 'error');
                evaluationRecords = [];
                renderEvaluationRecords();
                document.getElementById('analysisSection').style.display = 'none';
            }
        }

        // æ¸²æŸ“è¯„ä»·è®°å½•ä¸‹æ‹‰æ¡†
        function renderEvaluationRecords() {
            const evalSelect = document.getElementById('evaluationRecordSelect');
            const evalInfo = document.getElementById('evaluationRecordInfo');

            if (evaluationRecords.length === 0) {
                evalSelect.innerHTML = '<option value="">æš‚æ— è¯„ä»·è®°å½•</option>';
                evalInfo.textContent = 'æš‚æ— è¯„ä»·è®°å½• | ç‚¹å‡»"ç¬¬ä¸€æ­¥:åˆ†æä½œæ–‡"åˆ›å»ºæ–°è¯„ä»·';
                return;
            }

            // æ„å»ºä¸‹æ‹‰æ¡†é€‰é¡¹
            evalSelect.innerHTML = evaluationRecords.map((evalItem, index) => {
                const createTime = new Date(evalItem.create_date).toLocaleString();
                const isLatest = evalItem.is_latest ? ' [æœ€æ–°]' : '';
                const label = `è¯„ä»·${index + 1} (${createTime}) ${isLatest}`;
                return `<option value="${evalItem.evaluation_id}">${label}</option>`;
            }).join('');

            // æ›´æ–°ä¿¡æ¯æç¤º
            const latestEval = evaluationRecords.find(item => item.is_latest) || evaluationRecords[0];
            const latestTime = new Date(latestEval.create_date).toLocaleString();
            evalInfo.innerHTML = `
                å…± ${evaluationRecords.length} æ¡è¯„ä»·è®°å½• | 
                æœ€æ–°è¯„ä»·: ${latestTime} | 
                è¯„ä»·äºº: ${latestEval.user_phone} | 
                æ–‡ä½“: ${latestEval.confirmed_genre_name} | 
                å¹´çº§: ${latestEval.confirmed_grade_name}
            `;
        }

        // è¯„ä»·è®°å½•åˆ‡æ¢äº‹ä»¶
        function onEvaluationRecordChange() {
            const evalId = document.getElementById('evaluationRecordSelect').value;
            if (!evalId) {
                // éšè—åˆ†æç»“æœ
                document.getElementById('analysisSection').style.display = 'none';
                currentAnalysis = null;
                currentEvaluationId = null;
                // æ¸…ç©ºè¯„åˆ†è®°å½•
                scoreRecords = [];
                renderScoreRecords();
                document.getElementById('scoreBtn').disabled = true;
                return;
            }

            // æŸ¥æ‰¾é€‰ä¸­çš„è¯„ä»·è®°å½•
            const selectedEval = evaluationRecords.find(item => item.evaluation_id == evalId);
            if (!selectedEval) return;

            currentEvaluationId = evalId;
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            if (selectedEval.evaluation_result) {
                currentAnalysis = selectedEval.evaluation_result;
                displayAnalysis(currentAnalysis);
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('scoreBtn').disabled = false;
            }

            // åŠ è½½è¯¥è¯„ä»·çš„è¯„åˆ†è®°å½•
            scoreRecords = selectedEval.scores || [];
            renderScoreRecords();
            
            // å¦‚æœæœ‰è¯„åˆ†è®°å½•ï¼Œé»˜è®¤é€‰ä¸­
            if (scoreRecords.length > 0) {
                const defaultScore = scoreRecords.find(item => item.is_default) || scoreRecords[0];
                document.getElementById('scoreRecordSelect').value = defaultScore.score_id;
                onScoreRecordChange();
            }
        }

        // æ¸²æŸ“è¯„åˆ†è®°å½•ä¸‹æ‹‰æ¡†
        function renderScoreRecords() {
            const scoreSelect = document.getElementById('scoreRecordSelect');
            const scoreInfo = document.getElementById('scoreRecordInfo');

            if (scoreRecords.length === 0) {
                scoreSelect.innerHTML = '<option value="">æš‚æ— è¯„åˆ†è®°å½•</option>';
                scoreInfo.textContent = 'æš‚æ— è¯„åˆ†è®°å½• | ç‚¹å‡»"ç¬¬äºŒæ­¥:AIè¯„åˆ†"åˆ›å»ºæ–°è¯„åˆ†';
                return;
            }

            // æ„å»ºä¸‹æ‹‰æ¡†é€‰é¡¹
            scoreSelect.innerHTML = scoreRecords.map((scoreItem, index) => {
                const createTime = new Date(scoreItem.create_date).toLocaleString();
                const scoreType = scoreItem.score_type === 'ai' ? 'AIè¯„åˆ†' : 'äººå·¥è¯„åˆ†';
                const isDefault = scoreItem.is_default ? ' [é»˜è®¤]' : '';
                const label = `${scoreType}${index + 1} (${createTime}) æ€»åˆ†: ${scoreItem.total_score}${isDefault}`;
                return `<option value="${scoreItem.score_id}">${label}</option>`;
            }).join('');

            // æ›´æ–°ä¿¡æ¯æç¤º
            const defaultScore = scoreRecords.find(item => item.is_default) || scoreRecords[0];
            const defaultTime = new Date(defaultScore.create_date).toLocaleString();
            scoreInfo.innerHTML = `
                å…± ${scoreRecords.length} æ¡è¯„åˆ†è®°å½• | 
                é»˜è®¤è¯„åˆ†: ${defaultScore.total_score}åˆ† | 
                è¯„åˆ†ç±»å‹: ${defaultScore.score_type === 'ai' ? 'AIè¯„åˆ†' : 'äººå·¥è¯„åˆ†'} | 
                åˆ›å»ºæ—¶é—´: ${defaultTime} | 
                è¯„åˆ†æ¨¡æ¿: ${defaultScore.score_prompt_version}
            `;
        }

        // è¯„åˆ†è®°å½•åˆ‡æ¢äº‹ä»¶
        function onScoreRecordChange() {
            const scoreId = document.getElementById('scoreRecordSelect').value;
            if (!scoreId) {
                // é‡ç½®AIè¯„åˆ†åŒºåŸŸ
                document.getElementById('aiScores').innerHTML = `
                    <div class="empty-result">
                        <div class="icon">ğŸ¯</div>
                        <div>æš‚æ— è¯„åˆ†æ•°æ®<br>ç‚¹å‡»"ç¬¬äºŒæ­¥:AIè¯„åˆ†"æŒ‰é’®è·å–</div>
                    </div>
                `;
                return;
            }

            // æŸ¥æ‰¾é€‰ä¸­çš„è¯„åˆ†è®°å½•
            const selectedScore = scoreRecords.find(item => item.score_id == scoreId);
            if (!selectedScore) return;

            // æ˜¾ç¤ºè¯„åˆ†ç»“æœ
            displayAIScores({
                total_score: selectedScore.total_score,
                dimensions: selectedScore.dimension_scores
            });

            // æ›´æ–°è¯„åˆ†ä¿¡æ¯æç¤º
            const scoreInfo = document.getElementById('scoreRecordInfo');
            const scoreType = selectedScore.score_type === 'ai' ? 'AIè¯„åˆ†' : 'äººå·¥è¯„åˆ†';
            const createTime = new Date(selectedScore.create_date).toLocaleString();
            scoreInfo.innerHTML = `
                é€‰ä¸­: ${scoreType} | 
                åˆ›å»ºæ—¶é—´: ${createTime} | 
                è¯„åˆ†äºº: ${selectedScore.user_phone} | 
                è¯„åˆ†æ¨¡æ¿: ${selectedScore.score_prompt_version} | 
                ${selectedScore.is_default ? 'é»˜è®¤è¯„åˆ†' : 'éé»˜è®¤è¯„åˆ†'}
            `;
        }

        // æ¸²æŸ“ä½œæ–‡æ•°æ®åˆ°é¡µé¢
        function renderEssayData(essay) {
            // æ˜¾ç¤ºå­¦ç”Ÿä¿¡æ¯
            document.getElementById('studentName').textContent = `å­¦ç”Ÿ: ${essay.student_name || 'æœªçŸ¥'}`;
            document.getElementById('directoryName').textContent = essay.batch?.id || 'æœªçŸ¥æ‰¹æ¬¡';

            // æ˜¾ç¤ºä½œæ–‡å†…å®¹
            document.getElementById('essayContent').textContent = essay.essay_content || 'æ— ä½œæ–‡å†…å®¹';

            // æ¸²æŸ“ä½œæ–‡å›¾ç‰‡
            const essayImage = document.getElementById('essayImage');
            const noImageText = document.getElementById('noImageText');
            if (essay.essay_image_path) {
                // å¤„ç†å›¾ç‰‡URLï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™æ‹¼æ¥API_BASEï¼ˆå»æ‰/apiåç¼€ï¼‰
                let imageUrl = essay.essay_image_path;
                if (!imageUrl.startsWith('http')) {
                    const baseUrl = API_BASE.replace(/\/api$/, '');
                    imageUrl = `${baseUrl}${imageUrl}`;
                }
                essayImage.src = imageUrl;
                essayImage.style.display = 'block';
                noImageText.style.display = 'none';
            } else {
                essayImage.src = '';
                essayImage.style.display = 'none';
                noImageText.style.display = 'block';
            }

            // ç»Ÿè®¡å¹¶æ˜¾ç¤ºå­—æ•°ï¼ˆä¼˜å…ˆç”¨æ¥å£è¿”å›çš„word_countï¼Œæ²¡æœ‰åˆ™è®¡ç®—ï¼‰
            const wordCount = essay.word_count || (essay.essay_content ? essay.essay_content.replace(/\s/g, '').length : 0);
            document.getElementById('wordCount').textContent = `(å…± ${wordCount} å­—)`;

            // è‡ªåŠ¨å¡«å……ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚ï¼ˆä»æ‰¹æ¬¡ä¿¡æ¯ï¼‰
            document.getElementById('essayTitle').value = essay.batch?.essay_title || '';
            document.getElementById('essayRequirement').value = essay.batch?.essay_requirement || '';

            // æ˜¾ç¤ºåŸå§‹è¯„åˆ†
            if (essay.original_score_data) {
                displayOriginalScores(essay.original_score_data);
                // è‡ªåŠ¨æ£€æµ‹åˆ†åˆ¶å¹¶é€‰æ‹©è¯„åˆ†æç¤ºè¯
                const scale = detectScoreScale(essay.original_score_data);
                autoSelectScorePrompt(scale);
            } else {
                document.getElementById('originalScores').innerHTML = `
                    <div class="empty-result">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— åŸå§‹è¯„åˆ†æ•°æ®</div>
                    </div>
                `;
            }

            // é‡ç½®AIè¯„åˆ†å’Œåˆ†æç»“æœï¼ˆä½†ä¿ç•™è¯„ä»·è®°å½•ï¼‰
            resetAIScores(false);
        }

        // æ£€æµ‹è¯„åˆ†åˆ†åˆ¶(æ ¹æ®åŸå§‹è¯„åˆ†åˆ¤æ–­)
        function detectScoreScale(scoreData) {
            if (!scoreData || !scoreData.dimensions) return '40';
            
            // æ£€æŸ¥æ‰€æœ‰ç»´åº¦çš„æœ€å¤§åˆ†å€¼
            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                if (dimData.max_score < 10) {
                    return '10'; // 10åˆ†åˆ¶
                }
            }
            return '40'; // 40åˆ†åˆ¶(é»˜è®¤)
        }

        // è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¯„åˆ†æç¤ºè¯
        function autoSelectScorePrompt(scale) {
            if (!scorePromptsData || scorePromptsData.length === 0) return;

            // æŸ¥æ‰¾åŒ…å«å¯¹åº”åˆ†åˆ¶çš„æç¤ºè¯ç‰ˆæœ¬
            const appropriatePrompts = scorePromptsData.filter(p =>
                p.version_name.includes(scale + 'åˆ†åˆ¶')
            );

            if (appropriatePrompts.length > 0) {
                // ä¼˜å…ˆé€‰æ‹©é»˜è®¤ç‰ˆæœ¬,å¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
                const selectedPrompt = appropriatePrompts.find(p => p.is_default) || appropriatePrompts[0];
                document.getElementById('scorePromptSelect').value = selectedPrompt.id;
                onScoreVersionChange();
                console.log(`è‡ªåŠ¨é€‰æ‹© ${scale}åˆ†åˆ¶ æç¤ºè¯: ${selectedPrompt.version_name}`);
            }
        }

        // æ˜¾ç¤ºåŸå§‹è¯„åˆ†
        function displayOriginalScores(scoreData) {
            const container = document.getElementById('originalScores');
            
            if (!scoreData || !scoreData.dimensions) {
                container.innerHTML = `
                    <div class="empty-result">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— åŸå§‹è¯„åˆ†æ•°æ®</div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="score-item total">
                    <span class="score-label">æ€»åˆ†</span>
                    <span class="score-value">${scoreData.total_score || 0}</span>
                </div>
            `;

            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                html += `
                    <div class="score-item">
                        <span class="score-label">${dimName}</span>
                        <span class="score-value">${dimData.score || 0} / ${dimData.max_score || 0}</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // é‡ç½®AIè¯„åˆ†åŒºåŸŸ
        function resetAIScores(clearEval = true) {
            document.getElementById('aiScores').innerHTML = `
                <div class="empty-result">
                    <div class="icon">ğŸ¯</div>
                    <div>ç‚¹å‡»"ç¬¬äºŒæ­¥:AIè¯„åˆ†"æŒ‰é’®<br>è·å–AIè¯„åˆ†ç»“æœ</div>
                </div>
            `;
            
            if (clearEval) {
                // éšè—åˆ†æç»“æœ
                document.getElementById('analysisSection').style.display = 'none';
                currentAnalysis = null;
                currentEvaluationId = null;
                // æ¸…ç©ºè¯„åˆ†è®°å½•
                scoreRecords = [];
                renderScoreRecords();
            }
            
            // ç¦ç”¨è¯„åˆ†æŒ‰é’®
            document.getElementById('scoreBtn').disabled = true;
        }

        // ä¸Šä¸€é¡µ
        function previousEssay() {
            if (currentPage <= 1) return;
            currentPage--;
            loadEssayDetail(currentPage);
        }

        // ä¸‹ä¸€é¡µ
        function nextEssay() {
            if (currentPage >= TOTAL_PAGES) return;
            currentPage++;
            loadEssayDetail(currentPage);
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function jumpToPage() {
            const input = document.getElementById('jumpInput');
            let pageNum = parseInt(input.value);

            if (isNaN(pageNum)) {
                showMessage('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ', 'error');
                return;
            }

            // é™åˆ¶é¡µæ•°èŒƒå›´
            pageNum = Math.max(1, Math.min(pageNum, TOTAL_PAGES));

            currentPage = pageNum;
            loadEssayDetail(currentPage);
            input.value = '';
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `${currentPage} / ${TOTAL_PAGES}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= TOTAL_PAGES;
            document.getElementById('jumpInput').max = TOTAL_PAGES; // é™åˆ¶è·³è½¬æœ€å¤§å€¼
        }

        // æ”¯æŒå›è½¦é”®è·³è½¬
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jumpInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });
        });

        // åŠ è½½æç¤ºè¯åˆ—è¡¨ï¼ˆé€‚é…æ–°æ¥å£ï¼‰
        async function loadPrompts() {
            try {
                // åŠ è½½ä½œæ–‡è¯„ä»·æç¤ºè¯ (analyzeç±»å‹, grade_id=1, genre_id=1)
                const analyzeResponse = await fetch(`${API_BASE}/prompts?grade_id=1&genre_id=1&prompt_type=analyze`);
                const analyzeData = await analyzeResponse.json();
                analyzePromptsData = analyzeData.prompts || [];

                // åŠ è½½ä½œæ–‡è¯„åˆ†æç¤ºè¯ (scoreç±»å‹, grade_id=1, genre_id=1)
                const scoreResponse = await fetch(`${API_BASE}/prompts?grade_id=1&genre_id=1&prompt_type=score`);
                const scoreData = await scoreResponse.json();
                scorePromptsData = scoreData.prompts || [];

                console.log('åŠ è½½è¯„ä»·æç¤ºè¯:', analyzePromptsData.length, 'æ¡');
                console.log('åŠ è½½è¯„åˆ†æç¤ºè¯:', scorePromptsData.length, 'æ¡');

                // å¡«å……ä½œæ–‡è¯„ä»·æç¤ºè¯é€‰æ‹©å™¨
                const analyzeSelect = document.getElementById('analyzePromptSelect');
                analyzeSelect.innerHTML = analyzePromptsData.map(p => {
                    const label = p.version_name + (p.is_default ? ' (é»˜è®¤)' : '');
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');

                // é€‰æ‹©é»˜è®¤è¯„ä»·æç¤ºè¯
                if (analyzePromptsData.length > 0) {
                    const defaultAnalyze = analyzePromptsData.find(p => p.is_default) || analyzePromptsData[0];
                    analyzeSelect.value = defaultAnalyze.id;
                    onAnalyzeVersionChange();
                }

                // å¡«å……ä½œæ–‡è¯„åˆ†æç¤ºè¯é€‰æ‹©å™¨
                const scoreSelect = document.getElementById('scorePromptSelect');
                scoreSelect.innerHTML = scorePromptsData.map(p => {
                    const label = p.version_name + (p.is_default ? ' (é»˜è®¤)' : '');
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');

                // é€‰æ‹©é»˜è®¤è¯„åˆ†æç¤ºè¯
                if (scorePromptsData.length > 0) {
                    const defaultScore = scorePromptsData.find(p => p.is_default) || scorePromptsData[0];
                    scoreSelect.value = defaultScore.id;
                    onScoreVersionChange();
                }

            } catch (error) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', error);
                showMessage('âŒ åŠ è½½æç¤ºè¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä½œæ–‡è¯„ä»·æç¤ºè¯ç‰ˆæœ¬å˜æ›´
        function onAnalyzeVersionChange() {
            const promptId = parseInt(document.getElementById('analyzePromptSelect').value);
            const prompt = analyzePromptsData.find(p => p.id === promptId);
            if (prompt) {
                document.getElementById('analyzePromptContent').value = prompt.prompt_content || '';
            } else {
                document.getElementById('analyzePromptContent').value = '';
            }
        }

        // ä½œæ–‡è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬å˜æ›´
        function onScoreVersionChange() {
            const promptId = parseInt(document.getElementById('scorePromptSelect').value);
            const prompt = scorePromptsData.find(p => p.id === promptId);
            if (prompt) {
                document.getElementById('scorePromptContent').value = prompt.prompt_content || '';
            } else {
                document.getElementById('scorePromptContent').value = '';
            }
        }

        // ä¿å­˜ä½œæ–‡è¯„ä»·æç¤ºè¯ç‰ˆæœ¬ï¼ˆè°ƒç”¨åˆ›å»ºæ¥å£ï¼‰
        async function saveAnalyzeVersion() {
            const content = document.getElementById('analyzePromptContent').value.trim();
            if (!content) {
                showMessage('âš ï¸ è¯·è¾“å…¥ä½œæ–‡è¯„ä»·æç¤ºè¯å†…å®¹', 'error');
                return;
            }

            const versionName = prompt('è¯·è¾“å…¥ä½œæ–‡è¯„ä»·æç¤ºè¯ç‰ˆæœ¬åç§°:');
            if (!versionName) return;

            try {
                const response = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade_id: 1,          // é»˜è®¤å¡«1
                        genre_id: 1,          // é»˜è®¤å¡«1
                        prompt_type: 'analyze',// ä½œæ–‡è¯„ä»·ç±»å‹
                        version_name: versionName,
                        prompt_content: content,
                        is_default: false,     // é»˜è®¤ä¸è®¾ä¸ºé»˜è®¤
                        created_by: getCurrentUserPhone() || 'admin'    // ä½¿ç”¨å½“å‰ç”¨æˆ·æ‰‹æœºå·
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('âœ… ä½œæ–‡è¯„ä»·æç¤ºè¯ä¿å­˜æˆåŠŸ!', 'success');
                    // é‡æ–°åŠ è½½æç¤ºè¯åˆ—è¡¨
                    await loadPrompts();
                    // é€‰ä¸­æ–°åˆ›å»ºçš„æç¤ºè¯
                    document.getElementById('analyzePromptSelect').value = result.id;
                    onAnalyzeVersionChange();
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®ä½œæ–‡è¯„ä»·æç¤ºè¯ä¸ºé»˜è®¤ï¼ˆè°ƒç”¨æ›´æ–°æ¥å£ï¼‰
        async function setAnalyzeDefault() {
            const promptId = parseInt(document.getElementById('analyzePromptSelect').value);
            if (isNaN(promptId)) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${promptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        is_default: true  // è®¾ç½®ä¸ºé»˜è®¤
                    })
                });

                if (response.ok) {
                    showMessage('âœ… å·²è®¾ç½®ä¸ºé»˜è®¤ä½œæ–‡è¯„ä»·æç¤ºè¯', 'success');
                    // é‡æ–°åŠ è½½æç¤ºè¯åˆ—è¡¨
                    await loadPrompts();
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜ä½œæ–‡è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬ï¼ˆè°ƒç”¨åˆ›å»ºæ¥å£ï¼‰
        async function saveScoreVersion() {
            const content = document.getElementById('scorePromptContent').value.trim();
            if (!content) {
                showMessage('âš ï¸ è¯·è¾“å…¥ä½œæ–‡è¯„åˆ†æç¤ºè¯å†…å®¹', 'error');
                return;
            }

            const versionName = prompt('è¯·è¾“å…¥ä½œæ–‡è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬åç§°:');
            if (!versionName) return;

            try {
                const response = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade_id: 1,         // é»˜è®¤å¡«1
                        genre_id: 1,         // é»˜è®¤å¡«1
                        prompt_type: 'score', // ä½œæ–‡è¯„åˆ†ç±»å‹
                        version_name: versionName,
                        prompt_content: content,
                        is_default: false,    // é»˜è®¤ä¸è®¾ä¸ºé»˜è®¤
                        created_by: getCurrentUserPhone() || 'admin'   // ä½¿ç”¨å½“å‰ç”¨æˆ·æ‰‹æœºå·
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('âœ… ä½œæ–‡è¯„åˆ†æç¤ºè¯ä¿å­˜æˆåŠŸ!', 'success');
                    // é‡æ–°åŠ è½½æç¤ºè¯åˆ—è¡¨
                    await loadPrompts();
                    // é€‰ä¸­æ–°åˆ›å»ºçš„æç¤ºè¯
                    document.getElementById('scorePromptSelect').value = result.id;
                    onScoreVersionChange();
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®ä½œæ–‡è¯„åˆ†æç¤ºè¯ä¸ºé»˜è®¤ï¼ˆè°ƒç”¨æ›´æ–°æ¥å£ï¼‰
        async function setScoreDefault() {
            const promptId = parseInt(document.getElementById('scorePromptSelect').value);
            if (isNaN(promptId)) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${promptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        is_default: true  // è®¾ç½®ä¸ºé»˜è®¤
                    })
                });

                if (response.ok) {
                    showMessage('âœ… å·²è®¾ç½®ä¸ºé»˜è®¤ä½œæ–‡è¯„åˆ†æç¤ºè¯', 'success');
                    // é‡æ–°åŠ è½½æç¤ºè¯åˆ—è¡¨
                    await loadPrompts();
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡Œä½œæ–‡åˆ†æ(ç¬¬ä¸€æ­¥)
        async function performAnalysis() {
            if (!currentEssay) {
                showMessage('âš ï¸ ä½œæ–‡æ•°æ®æœªåŠ è½½', 'error');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ‰‹æœºå·
            const userPhone = getCurrentUserPhone();
            if (!userPhone) {
                showMessage('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            // è·å–åˆ†ææç¤ºè¯ID
            const analyzePromptId = parseInt(document.getElementById('analyzePromptSelect').value);
            if (isNaN(analyzePromptId)) {
                showMessage('âš ï¸ è¯·é€‰æ‹©æœ‰æ•ˆçš„è¯„ä»·æç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }
        
            const title = document.getElementById('essayTitle').value.trim();
            const requirement = document.getElementById('essayRequirement').value.trim();
        
            // ä½¿ç”¨åˆ†ææç¤ºè¯è¾“å…¥æ¡†çš„å†…å®¹
            const promptContent = document.getElementById('analyzePromptContent').value.trim();
            if (!promptContent) {
                showMessage('âš ï¸ è¯·è¾“å…¥ä½œæ–‡è¯„ä»·æç¤ºè¯', 'error');
                return;
            }
        
            const btn = document.getElementById('analyzeBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> AIåˆ†æä¸­...';
        
            try {
                const response = await fetch(`${API_BASE}/evaluations/ai-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        essay_content: currentEssay.essay_content,
                        essay_title: title,
                        essay_requirement: requirement,
                        prompt: promptContent,
                        // æ–°å¢ï¼šæ·»åŠ ä¸‰ä¸ªå¿…å¡«å‚æ•°
                        essay_id: currentEssayId,
                        analyze_prompt_id: analyzePromptId,
                        user_phone: userPhone
                    })
                });
            
                const result = await response.json();
            
                if (result.success) {
                    currentAnalysis = result.analysis;
                    currentEvaluationId = result.evaluation_id; // ä¿å­˜è¯„ä»·ID
                    displayAnalysis(result.analysis);
                    // å¯ç”¨è¯„åˆ†æŒ‰é’®
                    document.getElementById('scoreBtn').disabled = false;
                    
                    // é‡æ–°åŠ è½½è¯„ä»·è®°å½•
                    await loadEvaluationRecords();
                    
                    showMessage('âœ… ä½œæ–‡åˆ†æå®Œæˆ! ç°åœ¨å¯ä»¥è¿›è¡Œè¯„åˆ†äº†', 'success');
                } else {
                    showMessage('âŒ AIåˆ†æå¤±è´¥: ' + result.error, 'error');
                    console.error('AIè¿”å›:', result.raw_response);
                }
            } catch (error) {
                showMessage('âŒ AIåˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysis(analysis) {
            const section = document.getElementById('analysisSection');
            const container = document.getElementById('analysisContent');
        
            let html = '';
        
            // ç»¼åˆè¯„ä»·ï¼ˆæ›¿æ¢ä¸ºoverall_evaluationï¼‰
            if (analysis.overall_evaluation) {
                const overall = analysis.overall_evaluation;
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ“Š ç»¼åˆè¯„ä»·
                            <span class="overall-quality">${overall.quality_level || ''}</span>
                        </div>
                        ${overall.summary ? `<p style="line-height: 1.8; margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">${overall.summary}</p>` : ''}
                        <p style="margin-bottom: 8px;"><strong>ä¸»è¦ä¼˜ç‚¹:</strong></p>
                        <ul class="analysis-list">
                            ${(overall.main_strengths || []).map(item => `<li class="highlight-item">${item}</li>`).join('')}
                        </ul>
                        <p style="margin-bottom: 8px; margin-top: 12px;"><strong>ä¸»è¦é—®é¢˜:</strong></p>
                        <ul class="analysis-list">
                            ${(overall.main_issues || []).map(item => `<li class="error-item">${item}</li>`).join('')}
                        </ul>
                        <p style="margin-top: 12px;"><strong>æ€»ä½“å»ºè®®:</strong> ${overall.general_advice || ''}</p>
                    </div>
                `;
            }
        
            // ä½œæ–‡è¦æ±‚è¯„ä»·ï¼ˆæ›¿æ¢ä¸ºrequirement_evaluationï¼‰
            if (analysis.requirement_evaluation && analysis.requirement_evaluation.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ“‹ ä½œæ–‡è¦æ±‚è¯„ä»·
                        </div>
                        ${analysis.requirement_evaluation.map(item => `
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-weight: bold; color: #333;">${item.requirement}</span>
                                    <span style="color: #667eea; font-weight: bold; font-size: 16px;">${item.score} / ${item.max_score}åˆ†</span>
                                </div>
                                <div style="background: #e0e0e0; height: 6px; border-radius: 3px; margin-bottom: 6px;">
                                    <div style="background: linear-gradient(90deg, #4caf50, #667eea); height: 100%; width: ${(item.score / item.max_score) * 100}%; border-radius: 3px;"></div>
                                </div>
                                <p style="color: #666; font-size: 13px;">${item.comment}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        
            // æ—æ‰¹ç‚¹è¯„ï¼ˆæ›¿æ¢ä¸ºmargin_commentsï¼‰
            if (analysis.margin_comments) {
                const pangpi = analysis.margin_comments;
                let pangpiHtml = '';
            
                // äº®ç‚¹å¥å­ï¼ˆhighlight_sentencesï¼‰
                if (pangpi.highlight_sentences && pangpi.highlight_sentences.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #ffd700; margin-bottom: 8px;">ğŸŒŸ äº®ç‚¹å¥å­ (${pangpi.highlight_sentences.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.highlight_sentences.map(item =>
                                    `<li class="highlight-item">
                                        <span style="color: #666; font-style: italic;">"${item.content}"</span><br>
                                        <span style="color: #4caf50;">${item.comment}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }
            
                // æ­é…æå‡ï¼ˆcollocation_improvementsï¼‰
                if (pangpi.collocation_improvements && pangpi.collocation_improvements.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px;">ğŸ”§ æ­é…æå‡ (${pangpi.collocation_improvements.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.collocation_improvements.map(item =>
                                    `<li class="suggestion-item">
                                        "${item.original}" â†’ "${item.suggestion}"<br>
                                        <span style="color: #666; font-size: 13px;">${item.reason}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }
            
                // å­—è¯çº é”™ï¼ˆword_correctionsï¼‰
                if (pangpi.word_corrections && pangpi.word_corrections.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #2196f3; margin-bottom: 8px;">âœï¸ å­—è¯çº é”™ (${pangpi.word_corrections.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.word_corrections.map(item =>
                                    `<li class="error-item">
                                        ${item.error}: åº”æ”¹ä¸º "${item.correction}"
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }
            
                if (pangpiHtml) {
                    html += `
                        <div class="analysis-item">
                            <div class="analysis-title">
                                ğŸ“Œ æ—æ‰¹ç‚¹è¯„
                            </div>
                            ${pangpiHtml}
                        </div>
                    `;
                }
            }
        
            // é”™åˆ«å­—ç»Ÿè®¡ï¼ˆtypos + typo_countï¼‰
            if (analysis.typo_count !== undefined) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âŒ é”™åˆ«å­—ç»Ÿè®¡
                            <span class="analysis-badge">${analysis.typo_count} ä¸ª</span>
                        </div>
                        <ul class="analysis-list">
                            ${(analysis.typos || []).map(item =>
                                `<li class="error-item">${item.location}: "${item.error}" â†’ "${item.correction}"</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // è¯­ç—…æ ‡æ³¨ï¼ˆgrammar_errors + grammar_error_countï¼‰
            if (analysis.grammar_error_count !== undefined) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âš ï¸ è¯­ç—…æ ‡æ³¨
                            <span class="analysis-badge">${analysis.grammar_error_count} å¤„</span>
                        </div>
                        <ul class="analysis-list">
                            ${(analysis.grammar_errors || []).map(item =>
                                `<li class="error-item">
                                    <strong>${item.location}:</strong> ${item.description}<br>
                                    <span style="color: #999;">åŸå¥: ${item.original_sentence}</span><br>
                                    <span style="color: #4caf50;">å»ºè®®: ${item.suggestion}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // ä¼˜ç‚¹äº®ç‚¹ï¼ˆstrengthsï¼‰
            if (analysis.strengths && analysis.strengths.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âœ¨ ä¼˜ç‚¹äº®ç‚¹
                            <span class="analysis-badge">${analysis.strengths.length} å¤„</span>
                        </div>
                        <ul class="analysis-list">
                            ${analysis.strengths.map(item =>
                                `<li class="highlight-item">
                                    <strong>${item.location}:</strong> ${item.comment}<br>
                                    <span style="color: #666; font-style: italic;">"${item.content}"</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // æ”¹è¿›å»ºè®®ï¼ˆimprovement_suggestionsï¼‰
            if (analysis.improvement_suggestions && analysis.improvement_suggestions.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ’¡ æ”¹è¿›å»ºè®®
                            <span class="analysis-badge">${analysis.improvement_suggestions.length} æ¡</span>
                        </div>
                        <ul class="analysis-list">
                            ${analysis.improvement_suggestions.map(item =>
                                `<li class="suggestion-item">
                                    <strong>${item.aspect}:</strong> ${item.suggestion}
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
        
            container.innerHTML = html || '<p style="color: #999; text-align: center;">æš‚æ— åˆ†æç»“æœ</p>';
            section.style.display = 'block';
        }

        // æ‰§è¡ŒAIè¯„åˆ†(ç¬¬äºŒæ­¥)
        async function performScoring() {
            if (!currentAnalysis || !currentEvaluationId) {
                showMessage('âš ï¸ è¯·å…ˆå®Œæˆä½œæ–‡åˆ†æ', 'error');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ‰‹æœºå·
            const userPhone = getCurrentUserPhone();
            if (!userPhone) {
                showMessage('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            // è·å–è¯„åˆ†æç¤ºè¯ID
            const scorePromptId = parseInt(document.getElementById('scorePromptSelect').value);
            if (isNaN(scorePromptId)) {
                showMessage('âš ï¸ è¯·é€‰æ‹©æœ‰æ•ˆçš„è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }

            const title = document.getElementById('essayTitle').value.trim();
            const requirement = document.getElementById('essayRequirement').value.trim();

            // ä½¿ç”¨è¯„åˆ†æç¤ºè¯è¾“å…¥æ¡†çš„å†…å®¹
            const promptContent = document.getElementById('scorePromptContent').value.trim();
            if (!promptContent) {
                showMessage('âš ï¸ è¯·è¾“å…¥ä½œæ–‡è¯„åˆ†æç¤ºè¯', 'error');
                return;
            }

            const btn = document.getElementById('scoreBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> AIè¯„åˆ†ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/evaluations/ai-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        essay_content: currentEssay.essay_content,
                        essay_title: title,
                        essay_requirement: requirement,
                        analysis: currentAnalysis,
                        prompt: promptContent,
                        // æ–°å¢å¿…å¡«å‚æ•°
                        evaluation_id: currentEvaluationId,
                        score_prompt_id: scorePromptId,
                        user_phone: userPhone
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayAIScores(result.scores);
                    // é‡æ–°åŠ è½½è¯„ä»·è®°å½•ï¼ˆåŒæ­¥è¯„åˆ†è®°å½•ï¼‰
                    await loadEvaluationRecords();
                    showMessage('âœ… AIè¯„åˆ†å®Œæˆ!', 'success');
                } else {
                    showMessage('âŒ AIè¯„åˆ†å¤±è´¥: ' + result.error, 'error');
                    console.error('AIè¿”å›:', result.raw_response);
                }
            } catch (error) {
                showMessage('âŒ AIè¯„åˆ†å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // æ˜¾ç¤ºAIè¯„åˆ†ç»“æœ
        function displayAIScores(scoreData) {
            const container = document.getElementById('aiScores');
        
            if (!scoreData || !scoreData.dimensions) {
                container.innerHTML = `
                    <div class="empty-result">
                        <div class="icon">ğŸ¯</div>
                        <div>æš‚æ— AIè¯„åˆ†æ•°æ®</div>
                    </div>
                `;
                return;
            }
        
            let html = `
                <div class="score-item ai-total">
                    <span class="score-label">AIæ€»åˆ†</span>
                    <span class="score-value">${scoreData.total_score || 0}</span>
                </div>
            `;
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ˜ å°„è¡¨è½¬æ¢è‹±æ–‡keyä¸ºä¸­æ–‡æ˜¾ç¤º
            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                // å–ä¸­æ–‡åç§°ï¼Œæ— æ˜ å°„åˆ™æ˜¾ç¤ºåŸkey
                const displayName = scoreDimensionMap[dimName] || dimName;
                html += `
                    <div class="score-item">
                        <span class="score-label">${displayName}</span>
                        <span class="score-value">${dimData.score || 0} / ${dimData.max_score || 0}</span>
                    </div>
                `;
            }
        
            container.innerHTML = html;
        }

        // æäº¤è¯„åˆ†å¯¹æ¯”åé¦ˆ
        async function submitComparisonFeedback() {
            if (!currentEvaluationId) {
                showMessage('âš ï¸ è¯·å…ˆå®Œæˆä½œæ–‡è¯„ä»·', 'error');
                return;
            }

            // è·å–åé¦ˆæ•°æ®
            const whichAccurate = document.querySelector('input[name="whichAccurate"]:checked')?.value || 'original';
            const userScore = parseInt(document.getElementById('userScore').value);
            const feedbackReason = document.getElementById('feedbackReason').value.trim();

            if (isNaN(userScore)) {
                showMessage('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„è¯„åˆ†', 'error');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ‰‹æœºå·
            const userPhone = getCurrentUserPhone();
            if (!userPhone) {
                showMessage('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/evaluations/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evaluation_id: currentEvaluationId,
                        user_phone: userPhone,
                        which_accurate: whichAccurate,
                        user_score: userScore,
                        feedback_reason: feedbackReason,
                        essay_id: currentEssayId
                    })
                });

                if (response.ok) {
                    showMessage('âœ… åé¦ˆæäº¤æˆåŠŸ!', 'success');
                    // æ¸…ç©ºåé¦ˆè¡¨å•
                    document.getElementById('userScore').value = '';
                    document.getElementById('feedbackReason').value = '';
                    document.querySelector('input[name="whichAccurate"][value="original"]').checked = true;
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showMessage('âŒ åé¦ˆæäº¤å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ åé¦ˆæäº¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const imgContainer = document.querySelector('.essay-image-container');
            const closeBtn = document.querySelector('.close-modal');

            // ç‚¹å‡»å›¾ç‰‡å®¹å™¨æ”¾å¤§å›¾ç‰‡
            imgContainer.addEventListener('click', function() {
                const essayImage = document.getElementById('essayImage');
                if (essayImage.src && essayImage.style.display !== 'none') {
                    modal.style.display = 'block';
                    modalImg.src = essayImage.src;
                }
            });

            // å…³é—­æ¨¡æ€æ¡†
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // åˆå§‹åŒ–é¡µé¢
            initPage();
        });

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'success') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.style.display = 'block';
            message.style.background = type === 'error' ? '#f44336' : '#4caf50';

            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = 'index.html'; // æ ¹æ®å®é™…ä¸»é¡µè·¯å¾„è°ƒæ•´
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            // åŠ è½½æç¤ºè¯
            await loadPrompts();
            // ä»URLè·å–ä½œæ–‡IDï¼ˆé¡µæ•°ï¼‰å¹¶åŠ è½½ä½œæ–‡
            const essayId = getEssayIdFromURL();
            await loadEssayDetail(essayId);
        }
    </script>
</body>
</html>