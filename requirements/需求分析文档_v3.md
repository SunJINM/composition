# 作文评分系统重构需求分析文档 v3.0

## 版本更新说明
- **版本**: v3.0
- **更新日期**: 2025-12-18
- **v3.0主要调整**:
  1. 作文表增加`score_system`字段(10分制/40分制)
  2. 作文要求表简化,移除最小/最大字数字段
  3. 引入"批次"概念,通过`directory_name`关联作文和要求
  4. 主页重新设计为作文列表展示页面
  5. 数据迁移逻辑优化(处理批次关联关系)

---

## 一、项目背景

### 1.1 当前系统概况
- **技术栈**: FastAPI + JSON文件存储
- **核心功能**: 作文评价 → 作文评分(两步流程)
- **数据组织**:
  - 1082篇作文,分属17个批次(directory_name)
  - 每个批次共享同一个作文题目和要求
- **评分体系**: 10分制和40分制两种

### 1.2 重构目标
1. 数据持久化方案从JSON迁移到MySQL数据库
2. 提示词管理更精细化,支持年级+文体+版本三层维度
3. 评分流程优化,增加文体判断中间步骤
4. 完善评价/评分历史记录管理
5. 增加用户系统和多用户评分功能
6. 支持用户反馈和评分对比功能
7. 主页重新设计为作文列表展示

---

## 二、核心业务逻辑

### 2.1 批次(Batch)概念

**定义**: 一批学生基于同一个作文题目和要求完成的作文集合

**关键字段**: `directory_name` (批次唯一标识)

**数据统计**:
- 总作文数: 1082篇
- 总批次数: 17个
- 平均每批: 约63篇作文

**业务关系**:
```
作文批次(Batch)
├── 作文题目(essay_title)
├── 作文要求(essay_requirement)
└── 关联的多篇作文(Essays)
    ├── 作文1
    ├── 作文2
    └── ...
```

**示例**:
- 批次ID: `72455C9E4D5F4A193C7CX7UY`
- 题目: "成长路上的阳光"
- 要求: "在我们成长过程中,有过许多撩拨心弦的记忆..."
- 作文数: 约60篇

---

### 2.2 评分体系

**两种分制**:
1. **10分制**: total_score ≤ 10
2. **40分制**: total_score > 10

**分制判断逻辑**:
```python
# 从原始评分数据判断分制
if original_score_data and original_score_data.get('total_score'):
    if original_score_data['total_score'] <= 10:
        score_system = 10  # 10分制
    else:
        score_system = 40  # 40分制
else:
    score_system = 40  # 默认40分制
```

**评分转换**:
- AI评分始终基于100分计算各维度分数
- 根据作文的`score_system`字段转换为对应分制
- 10分制: `total_score = (dimensions_sum / 100) * 10`
- 40分制: `total_score = (dimensions_sum / 100) * 40`

---

### 2.3 作文题目和要求

**数据来源**:
- 用户可以手动输入作文题目和要求
- 批量导入时从`essays_require.json`读取

**字段说明**:
- `essay_title`: 作文题目(可能很长,包含完整说明)
- `essay_requirement`: 作文要求(纯文本,包含所有要求描述)
- 不单独记录字数要求,包含在`essay_requirement`文本中

**示例**:
```json
{
  "essay_title": "写作实践三作文内容：你有勇气去访问你所在地区的一位名人...",
  "essay_requirement": "不少于600字；不得出现真实的人名、校名、地名"
}
```

---

## 三、数据库设计

### 3.1 表字段统一规范

**所有表必须包含以下字段**:
- `id` INT PRIMARY KEY AUTO_INCREMENT - 自增主键
- `status` TINYINT DEFAULT 1 - 状态(1:正常, 0:删除)
- `create_date` DATETIME DEFAULT CURRENT_TIMESTAMP - 创建时间
- `update_date` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - 更新时间

**数据类型规范**:
- 主键ID: INT
- JSON数据: TEXT (存储JSON字符串)
- 小数: FLOAT
- 禁止使用: BIGINT, JSON类型

---

### 3.2 数据库表结构(规范化设计)

#### 3.2.1 用户表(composition_users)
```sql
CREATE TABLE composition_users (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  phone VARCHAR(11) UNIQUE NOT NULL COMMENT '手机号',
  first_login_at DATETIME NOT NULL COMMENT '首次登录时间',
  last_login_at DATETIME NOT NULL COMMENT '最后登录时间',
  login_count INT DEFAULT 1 COMMENT '登录次数',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 3.2.2 年级表(composition_grades)
```sql
CREATE TABLE composition_grades (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '年级ID',
  grade_name VARCHAR(50) NOT NULL COMMENT '年级名称(7年级/8年级/9年级)',
  grade_code VARCHAR(20) NOT NULL COMMENT '年级编码(grade_7/grade_8/grade_9)',
  grade_level VARCHAR(20) NOT NULL COMMENT '学段(初中)',
  sort_order INT NOT NULL COMMENT '排序',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_grade_code (grade_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='年级表';
```

#### 3.2.3 文体表(composition_genres)
```sql
CREATE TABLE composition_genres (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '文体ID',
  genre_name VARCHAR(50) NOT NULL COMMENT '文体名称(记叙文/议论文)',
  genre_code VARCHAR(20) NOT NULL COMMENT '文体编码(narrative/argumentative)',
  description VARCHAR(200) COMMENT '文体描述',
  sort_order INT NOT NULL COMMENT '排序',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_genre_code (genre_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文体表';
```

#### 3.2.4 提示词表(composition_prompts)
```sql
CREATE TABLE composition_prompts (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '提示词ID',
  grade_id INT NOT NULL COMMENT '年级ID',
  genre_id INT NOT NULL COMMENT '文体ID',
  prompt_type VARCHAR(20) NOT NULL COMMENT '提示词类型(analyze/score)',
  version_name VARCHAR(50) NOT NULL COMMENT '版本名称',
  prompt_content TEXT NOT NULL COMMENT '提示词内容',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认(1:是,0:否)',
  created_by VARCHAR(11) COMMENT '创建人手机号',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_grade_genre (grade_id, genre_id, prompt_type),
  INDEX idx_created_by (created_by),
  FOREIGN KEY (grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (genre_id) REFERENCES composition_genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='提示词表';
```

#### 3.2.5 作文批次表(composition_batches) ⭐新增
```sql
CREATE TABLE composition_batches (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '批次ID',
  directory_name VARCHAR(100) UNIQUE NOT NULL COMMENT '批次目录名(唯一标识)',
  essay_title TEXT NOT NULL COMMENT '作文题目',
  essay_requirement TEXT COMMENT '作文要求(纯文本)',
  grade_id INT COMMENT '年级ID(从要求中提取或手动指定)',
  suggested_genre_id INT COMMENT '建议文体ID',
  essay_count INT DEFAULT 0 COMMENT '该批次作文数量',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_directory (directory_name),
  INDEX idx_grade (grade_id),
  FOREIGN KEY (grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (suggested_genre_id) REFERENCES composition_genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文批次表';
```

#### 3.2.6 作文表(composition_essays) ⭐增加score_system字段
```sql
CREATE TABLE composition_essays (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '作文ID',
  batch_id INT NOT NULL COMMENT '批次ID',
  student_name VARCHAR(100) COMMENT '学生姓名',
  essay_content TEXT NOT NULL COMMENT '作文内容',
  essay_image_path VARCHAR(500) COMMENT '作文图片路径',
  analysis_report_path VARCHAR(500) COMMENT '分析报告路径',
  word_count INT NOT NULL COMMENT '字数统计',
  score_system TINYINT NOT NULL DEFAULT 40 COMMENT '分制(10:10分制, 40:40分制)',
  original_score FLOAT COMMENT '原始评分',
  original_score_data TEXT COMMENT '原始评分详情(JSON字符串)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_batch (batch_id),
  INDEX idx_student (student_name),
  INDEX idx_score_system (score_system),
  FOREIGN KEY (batch_id) REFERENCES composition_batches(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文表';
```

#### 3.2.7 评价表(composition_evaluations)
```sql
CREATE TABLE composition_evaluations (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评价ID',
  essay_id INT NOT NULL COMMENT '作文ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评价人手机号',
  analyze_prompt_id INT NOT NULL COMMENT '使用的评价提示词ID',
  detected_genre_id INT COMMENT 'AI判断的文体ID',
  detected_grade_id INT COMMENT 'AI判断的年级ID',
  confirmed_genre_id INT NOT NULL COMMENT '用户确认的文体ID',
  confirmed_grade_id INT NOT NULL COMMENT '用户确认的年级ID',
  genre_confidence FLOAT COMMENT 'AI判断文体的置信度(0-1)',
  evaluation_result TEXT NOT NULL COMMENT '评价结果(JSON字符串)',
  is_latest TINYINT(1) DEFAULT 1 COMMENT '是否最新评价(1:是,0:否)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_essay (essay_id),
  INDEX idx_user (user_phone),
  INDEX idx_latest (essay_id, is_latest),
  FOREIGN KEY (essay_id) REFERENCES composition_essays(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone),
  FOREIGN KEY (analyze_prompt_id) REFERENCES composition_prompts(id),
  FOREIGN KEY (detected_genre_id) REFERENCES composition_genres(id),
  FOREIGN KEY (confirmed_genre_id) REFERENCES composition_genres(id),
  FOREIGN KEY (detected_grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (confirmed_grade_id) REFERENCES composition_grades(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

#### 3.2.8 评分表(composition_scores)
```sql
CREATE TABLE composition_scores (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评分ID',
  evaluation_id INT NOT NULL COMMENT '评价ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评分人手机号(system表示AI)',
  score_prompt_id INT NOT NULL COMMENT '使用的评分提示词ID',
  score_type VARCHAR(20) NOT NULL COMMENT '评分类型(ai/user)',
  total_score FLOAT NOT NULL COMMENT '总分',
  dimension_scores TEXT NOT NULL COMMENT '各维度分数(JSON字符串)',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认评分(1:是,0:否)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES composition_evaluations(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone),
  FOREIGN KEY (score_prompt_id) REFERENCES composition_prompts(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评分表';
```

#### 3.2.9 用户反馈表(composition_user_feedbacks)
```sql
CREATE TABLE composition_user_feedbacks (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '反馈ID',
  evaluation_id INT NOT NULL COMMENT '评价ID',
  score_id INT COMMENT '评分ID(针对评分的反馈)',
  user_phone VARCHAR(11) NOT NULL COMMENT '反馈人手机号',
  feedback_type VARCHAR(50) NOT NULL COMMENT '反馈类型(comparison/custom_score/comment/issue_mark)',
  feedback_data TEXT NOT NULL COMMENT '反馈数据(JSON字符串)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_score (score_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES composition_evaluations(id),
  FOREIGN KEY (score_id) REFERENCES composition_scores(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

---

### 3.3 数据库初始化数据

#### 3.3.1 年级初始化数据
```sql
INSERT INTO composition_grades (grade_name, grade_code, grade_level, sort_order, status) VALUES
('7年级', 'grade_7', '初中', 7, 1),
('8年级', 'grade_8', '初中', 8, 1),
('9年级', 'grade_9', '初中', 9, 1);
```

#### 3.3.2 文体初始化数据
```sql
INSERT INTO composition_genres (genre_name, genre_code, description, sort_order, status) VALUES
('记叙文', 'narrative', '以记人、叙事、写景、状物为主的文章', 1, 1),
('议论文', 'argumentative', '以议论为主要表达方式的文章', 2, 1);
```

---

## 四、数据迁移方案

### 4.1 迁移逻辑详解

#### 4.1.1 essays_require.json → composition_batches

**迁移逻辑**:
```python
# 读取essays_require.json
with open('essays_require.json', 'r', encoding='utf-8') as f:
    requirements = json.load(f)

for req in requirements:
    directory_name = req['directory_name']

    # 从作文要求中提取年级
    grade_id = extract_grade_from_text(req.get('essay_requirement', ''))

    # 插入批次表
    batch = Batch(
        directory_name=directory_name,
        essay_title=req['essay_title'],
        essay_requirement=req.get('essay_requirement', ''),
        grade_id=grade_id,
        status=1
    )
    db.add(batch)

db.commit()
```

#### 4.1.2 essays_data.json → composition_essays

**迁移逻辑**:
```python
# 读取essays_data.json
with open('essays_data.json', 'r', encoding='utf-8') as f:
    essays = json.load(f)

for essay in essays:
    # 根据directory_name查找对应的batch_id
    directory_name = essay.get('directory_name')
    batch = db.query(Batch).filter_by(directory_name=directory_name).first()

    if not batch:
        print(f"Warning: Batch not found for {directory_name}")
        continue

    # 判断分制
    original_score_data = essay.get('score_data', {})
    total_score = original_score_data.get('total_score', 0)
    score_system = 10 if total_score <= 10 else 40

    # 插入作文表
    essay_record = Essay(
        batch_id=batch.id,
        student_name=essay.get('student_name'),
        essay_content=essay.get('essay_content'),
        essay_image_path=essay.get('essay_image_path'),
        analysis_report_path=essay.get('analysis_report_path'),
        word_count=len(essay.get('essay_content', '')),
        score_system=score_system,
        original_score=total_score,
        original_score_data=json.dumps(original_score_data, ensure_ascii=False),
        status=1
    )
    db.add(essay_record)

db.commit()

# 更新批次的作文数量
for batch in db.query(Batch).all():
    essay_count = db.query(Essay).filter_by(batch_id=batch.id).count()
    batch.essay_count = essay_count
db.commit()
```

#### 4.1.3 提示词迁移

**analyze_prompts.json + score_prompts.json → composition_prompts**:
```python
# 迁移评价提示词
with open('analyze_prompts.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

for prompt in data.get('prompts', []):
    # 默认分配到7年级+记叙文
    prompt_record = Prompt(
        grade_id=1,  # 7年级
        genre_id=1,  # 记叙文
        prompt_type='analyze',
        version_name=prompt['version'],
        prompt_content=prompt['prompt'],
        is_default=prompt.get('is_default', False),
        status=1
    )
    db.add(prompt_record)

# 迁移评分提示词(同理)
```

---

### 4.2 迁移验证

**验证项**:
1. 批次数量: 17个
2. 作文总数: 1082篇
3. 每个批次的作文数量统计是否正确
4. 分制判断是否正确(10分制 vs 40分制)
5. 批次和作文的关联关系是否正确

**验证SQL**:
```sql
-- 检查批次数量
SELECT COUNT(*) FROM composition_batches;  -- 应为17

-- 检查作文总数
SELECT COUNT(*) FROM composition_essays;   -- 应为1082

-- 检查每个批次的作文数量
SELECT
  b.directory_name,
  b.essay_title,
  b.essay_count,
  COUNT(e.id) as actual_count
FROM composition_batches b
LEFT JOIN composition_essays e ON b.id = e.batch_id
GROUP BY b.id;

-- 检查分制分布
SELECT
  score_system,
  COUNT(*) as count
FROM composition_essays
GROUP BY score_system;
```

---

## 五、前端界面设计

### 5.1 新页面设计

#### 5.1.1 登录页面(login.html)
- 输入框: 手机号输入(11位数字)
- 按钮: 登录按钮
- 校验: 前端校验手机号格式
- 跳转: 登录成功后跳转到主页(作文列表页)

#### 5.1.2 主页 - 作文列表页面(index.html) ⭐重新设计
**布局设计**:
```
┌─────────────────────────────────────┐
│  顶部导航栏                          │
│  [用户: 138****0000] [退出登录]      │
├─────────────────────────────────────┤
│  筛选区域                            │
│  批次筛选: [下拉框]  年级: [下拉框]  │
│  搜索: [学生姓名搜索框]              │
├─────────────────────────────────────┤
│  作文列表(可上下滑动)                │
│  ┌───────────────────────────────┐  │
│  │ 作文#1                        │  │
│  │ 题目: 成长路上的阳光           │  │
│  │ 学生: 张三 | 批次: 72455...   │  │
│  │ 字数: 650 | 分制: 40分制      │  │
│  │ 原始分: 32/40                 │  │
│  │ 评价次数: 2 | 最新评价时间    │  │
│  │              [进入评分 →]     │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 作文#2                        │  │
│  │ ...                           │  │
│  └───────────────────────────────┘  │
│  ...                                │
│  [分页: 1 2 3 ... 55]               │
└─────────────────────────────────────┘
```

**核心功能**:
1. **作文列表展示**:
   - 显示所有作文(分页展示,每页20条)
   - 每条记录显示: 题目、学生姓名、批次、字数、分制、原始分、评价次数
   - 支持上下滚动浏览

2. **筛选功能**:
   - 按批次筛选(下拉框列出所有批次题目)
   - 按年级筛选(7/8/9)
   - 按学生姓名搜索

3. **点击进入**:
   - 点击"进入评分"按钮 → 跳转到评分页面(ai-scoring.html)
   - 传递作文ID参数

#### 5.1.3 提示词管理页面(prompts-management.html)
- 年级选择器(7/8/9)
- 文体选择器(记叙文/议论文)
- 提示词类型切换(评价/评分)
- 提示词列表(显示所有版本+创建人)
- 新增/编辑/删除提示词功能

---

### 5.2 修改现有页面

#### 5.2.1 AI评分页面(ai-scoring.html)

**页面入口**: 从主页作文列表点击进入,携带essay_id参数

**页面加载逻辑**:
```javascript
// 1. 获取URL参数中的essay_id
const essayId = new URLSearchParams(window.location.search).get('essay_id');

// 2. 加载作文详情
fetch(`/api/essays/${essayId}`)
  .then(res => res.json())
  .then(data => {
    // 显示作文内容、题目、要求等
    // 根据score_system显示分制
  });

// 3. 加载历史评价记录
fetch(`/api/essays/${essayId}/evaluations`)
  .then(res => res.json())
  .then(data => {
    // 显示历史评价列表
  });
```

**新增元素**:
1. **作文信息区域**:
   - 显示批次信息(题目、要求)
   - 显示学生姓名、字数
   - 显示分制(10分制/40分制)
   - 显示原始评分

2. **文体判断区域**:
   - AI判断结果展示(文体+置信度)
   - 年级判断结果
   - 用户确认/修改下拉框
   - 确认按钮

3. **提示词选择区域**:
   - 评价提示词选择器(根据年级+文体筛选)
   - 评分提示词选择器(根据年级+文体筛选)
   - 显示提示词版本和创建人

4. **历史记录区域**:
   - 评价历史列表(时间倒序)
   - 点击评价展开对应的评分列表
   - 显示评价人、评分人、时间、使用的提示词

5. **用户反馈区域**:
   - 评分对比按钮
   - 自定义评分输入
   - 文字点评
   - 问题标注

**修改流程**:
```
原流程: 评价 → 评分
新流程: 评价 → 文体判断(用户确认) → 评分(根据分制转换)
```

---

## 六、API接口设计(JSON key统一使用英文)

### 6.1 作文批次相关接口

#### 6.1.1 获取所有批次列表
```
GET /api/batches
Response: {
  "batches": [
    {
      "id": 1,
      "directory_name": "72455C9E4D5F4A193C7CX7UY",
      "essay_title": "成长路上的阳光",
      "essay_requirement": "在我们成长过程中...",
      "grade_name": "7年级",
      "essay_count": 63,
      "create_date": "2025-12-18 10:00:00"
    }
  ],
  "total": 17
}
```

#### 6.1.2 获取批次详情
```
GET /api/batches/{batch_id}
Response: {
  "id": 1,
  "directory_name": "72455C9E4D5F4A193C7CX7UY",
  "essay_title": "成长路上的阳光",
  "essay_requirement": "在我们成长过程中...",
  "grade_id": 1,
  "grade_name": "7年级",
  "essay_count": 63,
  "create_date": "2025-12-18 10:00:00"
}
```

---

### 6.2 作文相关接口

#### 6.2.1 获取作文列表(支持筛选)
```
GET /api/essays?page=1&page_size=20&batch_id=1&grade_id=1&student_name=张三
Response: {
  "essays": [
    {
      "id": 100,
      "batch_id": 1,
      "batch_title": "成长路上的阳光",
      "student_name": "张三",
      "word_count": 650,
      "score_system": 40,
      "original_score": 32.0,
      "evaluation_count": 2,
      "latest_evaluation_date": "2025-12-18 10:00:00",
      "create_date": "2025-12-01 10:00:00"
    }
  ],
  "total": 1082,
  "page": 1,
  "page_size": 20,
  "total_pages": 55
}
```

#### 6.2.2 获取作文详情
```
GET /api/essays/{essay_id}
Response: {
  "id": 100,
  "batch": {
    "id": 1,
    "essay_title": "成长路上的阳光",
    "essay_requirement": "在我们成长过程中..."
  },
  "student_name": "张三",
  "essay_content": "作文正文内容...",
  "word_count": 650,
  "score_system": 40,
  "original_score": 32.0,
  "original_score_data": {
    "total_score": 32.0,
    "dimensions": {...}
  },
  "essay_image_path": "http://...",
  "create_date": "2025-12-01 10:00:00"
}
```

---

### 6.3 评价评分接口

#### 6.3.1 步骤1: 作文评价
```
POST /api/evaluations/analyze
Request: {
  "essay_id": 100,
  "analyze_prompt_id": 50,
  "user_phone": "13800138000"
}
Response: {
  "success": true,
  "evaluation_id": 200,
  "evaluation_result": {
    "overall_evaluation": {...},
    "typos": [...],
    "grammar_errors": [...],
    "highlights": [...],
    "improvement_suggestions": [...]
  }
}
```

#### 6.3.2 步骤2: 文体判断
```
POST /api/evaluations/detect-genre
Request: {
  "essay_id": 100,
  "essay_requirement": "作文要求内容",
  "essay_content": "学生作文内容"
}
Response: {
  "success": true,
  "detected_genre": {
    "genre_id": 1,
    "genre_name": "记叙文",
    "genre_code": "narrative",
    "confidence": 0.92
  },
  "detected_grade": {
    "grade_id": 1,
    "grade_name": "7年级"
  }
}
```

#### 6.3.3 步骤3: 作文评分(支持分制转换)
```
POST /api/scores/create
Request: {
  "evaluation_id": 200,
  "score_prompt_id": 60,
  "user_phone": "13800138000",
  "confirmed_genre_id": 1,
  "confirmed_grade_id": 1
}
Response: {
  "success": true,
  "score_id": 300,
  "score_system": 40,
  "score_data": {
    "total_score": 32.0,  # 已根据分制转换
    "dimensions": {
      "central_idea": {"score": 15.0, "max_score": 20},
      "language_expression": {"score": 18.0, "max_score": 25},
      "structure": {"score": 12.0, "max_score": 15},
      "material_selection": {"score": 11.0, "max_score": 15},
      "content_emotion": {"score": 19.0, "max_score": 25}
    }
  }
}
```

---

### 6.4 历史记录接口

#### 6.4.1 获取作文的所有评价记录
```
GET /api/essays/100/evaluations
Response: {
  "evaluations": [
    {
      "evaluation_id": 200,
      "user_phone": "13800138000",
      "genre_name": "记叙文",
      "grade_name": "7年级",
      "analyze_prompt_version": "v1.0",
      "is_latest": true,
      "create_date": "2025-12-18 10:00:00"
    }
  ]
}
```

#### 6.4.2 获取某次评价的所有评分记录
```
GET /api/evaluations/200/scores
Response: {
  "scores": [
    {
      "score_id": 300,
      "user_phone": "system",
      "score_type": "ai",
      "total_score": 32.0,
      "score_system": 40,
      "is_default": true,
      "score_prompt_version": "v2.0",
      "create_date": "2025-12-18 10:05:00"
    }
  ]
}
```

---

## 七、关键技术点

### 7.1 分制判断和转换

```python
def get_score_system(original_score_data):
    """从原始评分数据判断分制"""
    if original_score_data and 'total_score' in original_score_data:
        total_score = original_score_data['total_score']
        return 10 if total_score <= 10 else 40
    return 40  # 默认40分制

def convert_score(dimensions_sum, score_system):
    """将百分制的维度总分转换为对应分制"""
    if score_system == 10:
        return round((dimensions_sum / 100) * 10, 1)
    else:
        return round((dimensions_sum / 100) * 40, 1)
```

### 7.2 批次关联查询

```python
def get_essay_with_batch(essay_id):
    """获取作文及其批次信息"""
    essay = db.query(Essay).filter_by(id=essay_id).first()
    batch = db.query(Batch).filter_by(id=essay.batch_id).first()

    return {
        "essay": {
            "id": essay.id,
            "student_name": essay.student_name,
            "essay_content": essay.essay_content,
            "word_count": essay.word_count,
            "score_system": essay.score_system,
            "original_score": essay.original_score
        },
        "batch": {
            "id": batch.id,
            "essay_title": batch.essay_title,
            "essay_requirement": batch.essay_requirement
        }
    }
```

### 7.3 年级提取逻辑

```python
import re

def extract_grade_from_text(text):
    """从文本中提取年级(7/8/9)"""
    if not text:
        return None

    patterns = {
        1: [r'7年级', r'七年级', r'初一'],
        2: [r'8年级', r'八年级', r'初二'],
        3: [r'9年级', r'九年级', r'初三']
    }

    for grade_id, pattern_list in patterns.items():
        for pattern in pattern_list:
            if re.search(pattern, text):
                return grade_id

    return None  # 未匹配到年级
```

---

## 八、实施计划

### 8.1 开发阶段

#### 阶段1: 数据库设计与迁移(3天)
- [ ] 创建数据库配置文件(config.json)
- [ ] 编写数据库初始化脚本(建表+初始数据)
- [ ] 编写数据迁移脚本(处理批次关联)
- [ ] 执行迁移并验证(重点验证批次关联和分制判断)

#### 阶段2: 后端API开发(5天)
- [ ] 用户登录接口
- [ ] 批次管理接口(列表、详情)
- [ ] 作文管理接口(列表、详情、筛选)
- [ ] 提示词管理接口(CRUD)
- [ ] 文体判断接口
- [ ] 评价评分接口(支持分制转换)
- [ ] 历史记录接口
- [ ] 用户反馈接口

#### 阶段3: 前端界面开发(5天)
- [ ] 登录页面
- [ ] 主页重新设计(作文列表展示)
- [ ] 作文列表筛选功能
- [ ] AI评分页面重构(增加批次信息展示)
- [ ] 提示词管理页面
- [ ] 历史记录展示功能
- [ ] 用户反馈功能界面

#### 阶段4: 集成测试(2天)
- [ ] 完整流程测试(登录→浏览→评分)
- [ ] 批次关联测试
- [ ] 分制转换测试
- [ ] 多用户并发测试
- [ ] 数据一致性测试

#### 阶段5: 优化与部署(2天)
- [ ] 性能优化(列表加载、分页)
- [ ] 代码审查
- [ ] 文档编写
- [ ] 部署上线

---

## 九、配置文件示例

### 9.1 config.json
```json
{
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "your_password",
    "database": "essay_scoring",
    "charset": "utf8mb4"
  },
  "openai": {
    "base_url": "https://api.chatanywhere.tech/v1",
    "api_key": "your_api_key",
    "model": "gpt-4"
  },
  "system": {
    "page_size": 20,
    "max_history": 100,
    "session_timeout": 3600
  }
}
```

---

## 十、总结

### 10.1 核心变更点

**v3.0关键调整**:
1. ⭐ 新增`composition_batches`表,管理作文批次
2. ⭐ `composition_essays`表增加`score_system`字段(10/40分制)
3. ⭐ 作文和批次通过`batch_id`关联
4. ⭐ 主页重新设计为作文列表展示页面
5. ⭐ 评分流程支持分制自动转换

**数据规模**:
- 批次数: 17个
- 作文数: 1082篇
- 平均每批: 约63篇

**技术要点**:
- 分制判断: 原始分 ≤ 10 → 10分制, > 10 → 40分制
- 分制转换: AI评分(百分制) → 自动转换为对应分制
- 批次关联: directory_name作为唯一标识关联作文和要求

预计开发周期: **17个工作日**

---

**文档版本**: v3.0
**编写日期**: 2025-12-18
**最后更新**: 2025-12-18
