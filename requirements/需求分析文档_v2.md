# 作文评分系统重构需求分析文档 v2.0

## 版本更新说明
- **版本**: v2.0
- **更新日期**: 2025-12-18
- **主要调整**:
  1. 年级范围调整为7/8/9年级
  2. 文体类型调整为记叙文和议论文
  3. 表名增加前缀 `composition_`
  4. 统一表字段规范(id, status, create_date, update_date)
  5. JSON字段使用TEXT类型存储,不使用JSON类型
  6. 所有ID使用INT类型,小数使用FLOAT类型
  7. API接口JSON key统一使用英文
  8. 提示词全局共享,所有用户可见可用

---

## 一、项目背景

### 1.1 当前系统概况
- **技术栈**: FastAPI + JSON文件存储
- **核心功能**: 作文评价 → 作文评分(两步流程)
- **提示词管理**: 评价提示词和评分提示词分别管理,支持多版本
- **数据存储**: 所有数据存储在本地JSON文件中

### 1.2 重构目标
1. 数据持久化方案从JSON迁移到MySQL数据库
2. 提示词管理更精细化,支持年级+文体+版本三层维度
3. 评分流程优化,增加文体判断中间步骤
4. 完善评价/评分历史记录管理
5. 增加用户系统和多用户评分功能
6. 支持用户反馈和评分对比功能

---

## 二、核心需求详解

### 2.1 数据库迁移需求

#### 2.1.1 迁移范围
- ✅ 现有JSON文件数据全部迁移到MySQL
- ✅ 包括:
  - `essays_data.json` → `composition_essays` 表
  - `essays_require.json` → `composition_essay_requirements` 表
  - `analyze_prompts.json` → `composition_prompts` 表
  - `score_prompts.json` → `composition_prompts` 表
- ✅ 编写自动化迁移脚本

#### 2.1.2 配置管理
- **配置方式**: 使用配置文件(config.json)
- **配置内容**:
  - 数据库连接信息(host, port, user, password, database)
  - OpenAI API配置
  - 系统参数配置

---

### 2.2 提示词分层管理需求

#### 2.2.1 提示词组织结构(三层)
```
年级(Grade)
├── 文体(Genre)
│   ├── 版本1(Version)
│   ├── 版本2
│   └── 版本3
└── ...
```

**示例**:
- 7年级 → 记叙文 → v1.0标准版
- 7年级 → 记叙文 → v2.0严格版
- 7年级 → 议论文 → v1.0标准版
- 8年级 → 记叙文 → v1.0标准版

#### 2.2.2 提示词类型
1. **评价提示词**(analyze): 用于作文分析(第一步)
2. **评分提示词**(score): 用于作文评分(第二步)

#### 2.2.3 支持的年级范围
- **7年级**(初一)
- **8年级**(初二)
- **9年级**(初三)

#### 2.2.4 支持的文体类型
- **记叙文**(narrative)
- **议论文**(argumentative)

#### 2.2.5 提示词共享机制
- 所有用户创建的提示词对全局可见
- 任何用户可以使用任何提示词进行评价或评分
- 提示词列表显示创建人信息,但不限制使用权限

---

### 2.3 文体判断需求

#### 2.3.1 文体判断流程
```
作文要求 + 学生作文 → AI文体判断 → 用户确认/修改 → 选择对应提示词
```

#### 2.3.2 判断逻辑(混合模式)
1. **AI自动判断**:
   - 优先基于作文要求判断文体(记叙文/议论文)
   - 分析学生作文内容进行辅助判断
   - 返回判断结果和置信度

2. **用户确认机制**:
   - 展示AI判断结果(推荐文体)
   - 用户可以接受或手动修改文体选择(记叙文/议论文)
   - 用户确认后进入评分流程

#### 2.3.3 年级确定方式
- **主要方式**: 从作文要求中提取年级信息
- **提取逻辑**:
  - 使用正则表达式匹配"七年级"、"初一"、"8年级"、"初二"等关键词
  - AI辅助提取年级信息
- **兜底方案**: 如果无法提取,提供年级选择器让用户手动选择(7/8/9)

---

### 2.4 评价评分流程重构

#### 2.4.1 新评分流程(三步)
```
步骤1: 作文评价(AI分析)
  ↓
步骤2: 文体判断(AI判断 + 用户确认)
  ↓
步骤3: 作文评分(基于评价结果 + 对应提示词)
```

#### 2.4.2 评价结果结构(JSON格式,key使用英文)
```json
{
  "overall_evaluation": {
    "quality_level": "good",
    "main_strengths": ["strength1", "strength2"],
    "main_issues": ["issue1", "issue2"],
    "general_suggestion": "suggestion content"
  },
  "typos": [
    {
      "position": "paragraph 2, sentence 3",
      "wrong": "的地",
      "correct": "的"
    }
  ],
  "typo_count": 5,
  "grammar_errors": [
    {
      "position": "paragraph 1, sentence 2",
      "issue_type": "subject-verb agreement",
      "original": "我和小明去公园玩。",
      "suggestion": "我和小明去公园玩耍。"
    }
  ],
  "grammar_error_count": 3,
  "highlights": [
    {
      "position": "paragraph 3",
      "content": "vivid detail description",
      "comment": "shows character through action"
    }
  ],
  "improvement_suggestions": [
    {
      "aspect": "language",
      "suggestion": "use more rhetorical devices"
    }
  ]
}
```

#### 2.4.3 评分结果结构(JSON格式,key使用英文)
```json
{
  "total_score": 75.0,
  "dimensions": {
    "central_idea": {"score": 15.0, "max_score": 20},
    "language_expression": {"score": 18.0, "max_score": 25},
    "structure": {"score": 12.0, "max_score": 15},
    "material_selection": {"score": 11.0, "max_score": 15},
    "content_emotion": {"score": 19.0, "max_score": 25}
  }
}
```

---

### 2.5 历史记录管理需求

#### 2.5.1 评价评分关系模型
```
一次评价(Evaluation)
├── 评价结果(完整JSON,TEXT存储)
├── 评价时间
├── 评价人(手机号)
├── 使用的评价提示词
└── 关联的多次评分(Scores)
    ├── 评分1(默认AI评分)
    │   ├── 评分结果(各维度分数)
    │   ├── 评分时间
    │   ├── 评分人(system/手机号)
    │   ├── 使用的评分提示词
    │   └── 用户反馈
    ├── 评分2(用户A的评分)
    └── 评分3(用户B的评分)
```

#### 2.5.2 业务逻辑说明
- **同一评价,不同用户可多次评分**:
  - 用户A执行评价后,基于该评价结果生成默认AI评分
  - 用户B可以基于用户A的评价结果,使用自己选择的提示词重新评分
  - 用户C也可以基于同一评价结果进行评分
  - 每个用户的评分独立存储,互不影响

#### 2.5.3 存储内容清单
- [x] 完整评价内容(错别字/语病/优点/建议) - TEXT格式存储
- [x] 评分详情(各维度分数) - TEXT格式存储JSON
- [x] 使用的提示词信息(评价提示词+评分提示词)
- [x] 时间戳和操作人(手机号)
- [x] 判断的文体和年级信息

#### 2.5.4 展示需求
- **默认展示**: 最新的评价和评分结果
- **历史查看**:
  - 查看所有历史评价记录(时间倒序)
  - 点击某次评价,查看基于该评价的所有评分记录
  - 每条记录显示: 评价人/评分人、时间、使用的提示词版本

---

### 2.6 用户系统需求

#### 2.6.1 登录功能
- **登录方式**: 简单手机号登录(无验证码)
- **登录流程**:
  1. 用户输入11位手机号
  2. 系统校验格式
  3. 如果是新手机号,自动注册并登录
  4. 如果是已注册手机号,直接登录
  5. 登录成功后跳转到主页面

#### 2.6.2 用户信息存储
- 手机号(唯一标识)
- 首次登录时间
- 最后登录时间
- 登录次数

#### 2.6.3 用户权限
- 所有用户权限相同
- 可以查看所有作文和历史记录
- 可以对任意作文进行评价和评分
- 可以使用任何用户创建的提示词
- 评价和评分会关联用户手机号

---

### 2.7 用户评价功能需求

#### 2.7.1 功能清单
- [x] **AI评分 vs 原始评分对比**: 用户可以标记哪个评分更准确
- [x] **用户自定义评分**: 用户可以输入自己认为的各维度分数
- [x] **文字点评**: 用户可以对本次AI评价进行文字反馈
- [x] **问题标注**: 用户可以标注AI评价中的错误项(如误判的错别字/语病)

#### 2.7.2 用户反馈数据结构(JSON格式,key使用英文,TEXT存储)
```json
{
  "evaluation_id": 123,
  "score_id": 456,
  "user_phone": "13800138000",
  "feedback_type": "comparison|custom_score|comment|issue_mark",
  "feedback_data": {
    "preferred_score": "ai|original",
    "custom_scores": {
      "central_idea": 16.0,
      "language_expression": 20.0,
      "structure": 12.0,
      "material_selection": 11.0,
      "content_emotion": 19.0
    },
    "comment_text": "评价文字",
    "marked_issues": [
      {
        "type": "typo|grammar_error",
        "position": "paragraph 2, sentence 3",
        "reason": "这不是错别字,是方言用法"
      }
    ]
  },
  "create_date": "2025-12-18 10:30:00"
}
```

---

## 三、数据库设计

### 3.1 表字段统一规范

**所有表必须包含以下字段**:
- `id` INT PRIMARY KEY AUTO_INCREMENT - 自增主键
- `status` TINYINT DEFAULT 1 - 状态(1:正常, 0:删除)
- `create_date` DATETIME DEFAULT CURRENT_TIMESTAMP - 创建时间
- `update_date` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - 更新时间

**数据类型规范**:
- 主键ID: INT
- JSON数据: TEXT (存储JSON字符串)
- 小数: FLOAT
- 禁止使用: BIGINT, JSON类型

---

### 3.2 数据库表结构(规范化设计)

#### 3.2.1 用户表(composition_users)
```sql
CREATE TABLE composition_users (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  phone VARCHAR(11) UNIQUE NOT NULL COMMENT '手机号',
  first_login_at DATETIME NOT NULL COMMENT '首次登录时间',
  last_login_at DATETIME NOT NULL COMMENT '最后登录时间',
  login_count INT DEFAULT 1 COMMENT '登录次数',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 3.2.2 年级表(composition_grades)
```sql
CREATE TABLE composition_grades (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '年级ID',
  grade_name VARCHAR(50) NOT NULL COMMENT '年级名称(7年级/8年级/9年级)',
  grade_code VARCHAR(20) NOT NULL COMMENT '年级编码(grade_7/grade_8/grade_9)',
  grade_level VARCHAR(20) NOT NULL COMMENT '学段(初中)',
  sort_order INT NOT NULL COMMENT '排序',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_grade_code (grade_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='年级表';
```

#### 3.2.3 文体表(composition_genres)
```sql
CREATE TABLE composition_genres (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '文体ID',
  genre_name VARCHAR(50) NOT NULL COMMENT '文体名称(记叙文/议论文)',
  genre_code VARCHAR(20) NOT NULL COMMENT '文体编码(narrative/argumentative)',
  description VARCHAR(200) COMMENT '文体描述',
  sort_order INT NOT NULL COMMENT '排序',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_genre_code (genre_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文体表';
```

#### 3.2.4 提示词表(composition_prompts)
```sql
CREATE TABLE composition_prompts (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '提示词ID',
  grade_id INT NOT NULL COMMENT '年级ID',
  genre_id INT NOT NULL COMMENT '文体ID',
  prompt_type VARCHAR(20) NOT NULL COMMENT '提示词类型(analyze/score)',
  version_name VARCHAR(50) NOT NULL COMMENT '版本名称',
  prompt_content TEXT NOT NULL COMMENT '提示词内容',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认(1:是,0:否)',
  created_by VARCHAR(11) COMMENT '创建人手机号',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_grade_genre (grade_id, genre_id, prompt_type),
  INDEX idx_created_by (created_by),
  FOREIGN KEY (grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (genre_id) REFERENCES composition_genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='提示词表';
```

#### 3.2.5 作文要求表(composition_essay_requirements)
```sql
CREATE TABLE composition_essay_requirements (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '作文要求ID',
  title VARCHAR(200) NOT NULL COMMENT '作文题目',
  requirement_text TEXT NOT NULL COMMENT '作文要求',
  grade_id INT COMMENT '年级ID(从要求中提取)',
  suggested_genre_id INT COMMENT '建议文体ID',
  word_count_min INT COMMENT '最小字数要求',
  word_count_max INT COMMENT '最大字数要求',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_grade (grade_id),
  FOREIGN KEY (grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (suggested_genre_id) REFERENCES composition_genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文要求表';
```

#### 3.2.6 作文表(composition_essays)
```sql
CREATE TABLE composition_essays (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '作文ID',
  requirement_id INT COMMENT '作文要求ID',
  student_name VARCHAR(100) COMMENT '学生姓名',
  essay_content TEXT NOT NULL COMMENT '作文内容',
  essay_image_path VARCHAR(500) COMMENT '作文图片路径',
  analysis_report_path VARCHAR(500) COMMENT '分析报告路径',
  word_count INT NOT NULL COMMENT '字数统计',
  original_score FLOAT COMMENT '原始评分',
  original_score_data TEXT COMMENT '原始评分详情(JSON字符串)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_requirement (requirement_id),
  INDEX idx_student (student_name),
  FOREIGN KEY (requirement_id) REFERENCES composition_essay_requirements(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文表';
```

#### 3.2.7 评价表(composition_evaluations)
```sql
CREATE TABLE composition_evaluations (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评价ID',
  essay_id INT NOT NULL COMMENT '作文ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评价人手机号',
  analyze_prompt_id INT NOT NULL COMMENT '使用的评价提示词ID',
  detected_genre_id INT COMMENT 'AI判断的文体ID',
  detected_grade_id INT COMMENT 'AI判断的年级ID',
  confirmed_genre_id INT NOT NULL COMMENT '用户确认的文体ID',
  confirmed_grade_id INT NOT NULL COMMENT '用户确认的年级ID',
  genre_confidence FLOAT COMMENT 'AI判断文体的置信度(0-1)',
  evaluation_result TEXT NOT NULL COMMENT '评价结果(JSON字符串)',
  is_latest TINYINT(1) DEFAULT 1 COMMENT '是否最新评价(1:是,0:否)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_essay (essay_id),
  INDEX idx_user (user_phone),
  INDEX idx_latest (essay_id, is_latest),
  FOREIGN KEY (essay_id) REFERENCES composition_essays(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone),
  FOREIGN KEY (analyze_prompt_id) REFERENCES composition_prompts(id),
  FOREIGN KEY (detected_genre_id) REFERENCES composition_genres(id),
  FOREIGN KEY (confirmed_genre_id) REFERENCES composition_genres(id),
  FOREIGN KEY (detected_grade_id) REFERENCES composition_grades(id),
  FOREIGN KEY (confirmed_grade_id) REFERENCES composition_grades(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

#### 3.2.8 评分表(composition_scores)
```sql
CREATE TABLE composition_scores (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评分ID',
  evaluation_id INT NOT NULL COMMENT '评价ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评分人手机号(system表示AI)',
  score_prompt_id INT NOT NULL COMMENT '使用的评分提示词ID',
  score_type VARCHAR(20) NOT NULL COMMENT '评分类型(ai/user)',
  total_score FLOAT NOT NULL COMMENT '总分',
  dimension_scores TEXT NOT NULL COMMENT '各维度分数(JSON字符串)',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认评分(1:是,0:否)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES composition_evaluations(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone),
  FOREIGN KEY (score_prompt_id) REFERENCES composition_prompts(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评分表';
```

#### 3.2.9 用户反馈表(composition_user_feedbacks)
```sql
CREATE TABLE composition_user_feedbacks (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '反馈ID',
  evaluation_id INT NOT NULL COMMENT '评价ID',
  score_id INT COMMENT '评分ID(针对评分的反馈)',
  user_phone VARCHAR(11) NOT NULL COMMENT '反馈人手机号',
  feedback_type VARCHAR(50) NOT NULL COMMENT '反馈类型(comparison/custom_score/comment/issue_mark)',
  feedback_data TEXT NOT NULL COMMENT '反馈数据(JSON字符串)',
  status TINYINT DEFAULT 1 COMMENT '状态(1:正常,0:删除)',
  create_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_score (score_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES composition_evaluations(id),
  FOREIGN KEY (score_id) REFERENCES composition_scores(id),
  FOREIGN KEY (user_phone) REFERENCES composition_users(phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

---

### 3.3 数据库初始化数据

#### 3.3.1 年级初始化数据
```sql
INSERT INTO composition_grades (grade_name, grade_code, grade_level, sort_order, status) VALUES
('7年级', 'grade_7', '初中', 7, 1),
('8年级', 'grade_8', '初中', 8, 1),
('9年级', 'grade_9', '初中', 9, 1);
```

#### 3.3.2 文体初始化数据
```sql
INSERT INTO composition_genres (genre_name, genre_code, description, sort_order, status) VALUES
('记叙文', 'narrative', '以记人、叙事、写景、状物为主的文章', 1, 1),
('议论文', 'argumentative', '以议论为主要表达方式的文章', 2, 1);
```

---

## 四、数据迁移方案

### 4.1 迁移范围明细

#### 4.1.1 essays_data.json → composition_essays
**迁移内容**:
- 学生作文内容
- 学生姓名
- 作文图片路径
- 分析报告路径
- 字数统计
- 原始评分数据

**迁移逻辑**:
```python
# 读取essays_data.json
with open('essays_data.json', 'r', encoding='utf-8') as f:
    essays = json.load(f)

for essay in essays:
    # 转换数据格式
    essay_data = {
        'student_name': essay.get('student_name'),
        'essay_content': essay.get('essay_content'),
        'essay_image_path': essay.get('essay_image_path'),
        'analysis_report_path': essay.get('analysis_report_path'),
        'word_count': len(essay.get('essay_content', '')),
        'original_score': essay.get('score_data', {}).get('total_score'),
        'original_score_data': json.dumps(essay.get('score_data'), ensure_ascii=False),
        'status': 1
    }
    # 插入数据库
```

#### 4.1.2 essays_require.json → composition_essay_requirements
**迁移内容**:
- 作文题目
- 作文要求
- 年级信息(需要提取)
- 字数要求(需要提取)

**迁移逻辑**:
```python
# 读取essays_require.json
with open('essays_require.json', 'r', encoding='utf-8') as f:
    requirements = json.load(f)

for req in requirements:
    # 提取年级(7/8/9)
    grade_id = extract_grade_from_text(req['requirement_text'])

    # 提取字数要求
    word_count_min, word_count_max = extract_word_count(req['requirement_text'])

    req_data = {
        'title': req.get('title'),
        'requirement_text': req.get('requirement_text'),
        'grade_id': grade_id,
        'word_count_min': word_count_min,
        'word_count_max': word_count_max,
        'status': 1
    }
    # 插入数据库
```

#### 4.1.3 analyze_prompts.json → composition_prompts
**迁移内容**:
- 评价提示词内容
- 版本名称
- 默认标记

**迁移逻辑**:
```python
# 读取analyze_prompts.json
with open('analyze_prompts.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

for prompt in data.get('prompts', []):
    # 从版本名称中提取年级和文体(如果有)
    # 默认: 7年级 + 记叙文
    grade_id = 1  # 7年级
    genre_id = 1  # 记叙文

    prompt_data = {
        'grade_id': grade_id,
        'genre_id': genre_id,
        'prompt_type': 'analyze',
        'version_name': prompt['version'],
        'prompt_content': prompt['prompt'],
        'is_default': prompt.get('is_default', False),
        'status': 1
    }
    # 插入数据库
```

#### 4.1.4 score_prompts.json → composition_prompts
**迁移内容**:
- 评分提示词内容
- 版本名称
- 默认标记

**迁移逻辑**:
同 analyze_prompts.json,但 `prompt_type='score'`

---

### 4.2 迁移脚本设计

#### 4.2.1 迁移脚本结构
```python
# migrate_data.py

import json
import re
from datetime import datetime
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

class DataMigration:
    def __init__(self, config_path='config.json'):
        # 加载配置
        self.config = self.load_config(config_path)
        # 创建数据库连接
        self.engine = create_engine(self.get_db_url())
        self.Session = sessionmaker(bind=self.engine)

    def migrate_all(self):
        """执行完整迁移"""
        print("开始数据迁移...")

        # 1. 迁移作文要求
        self.migrate_essay_requirements()

        # 2. 迁移作文数据
        self.migrate_essays()

        # 3. 迁移提示词
        self.migrate_prompts()

        # 4. 验证迁移结果
        self.validate_migration()

        print("数据迁移完成!")

    def migrate_essay_requirements(self):
        """迁移作文要求"""
        print("迁移作文要求...")
        # 实现逻辑

    def migrate_essays(self):
        """迁移作文数据"""
        print("迁移作文数据...")
        # 实现逻辑

    def migrate_prompts(self):
        """迁移提示词"""
        print("迁移提示词...")
        # 实现逻辑

    def validate_migration(self):
        """验证迁移结果"""
        print("验证迁移结果...")
        # 统计记录数
        # 验证关键字段

    def extract_grade(self, text):
        """从文本中提取年级"""
        # 7年级/七年级/初一 -> 1
        # 8年级/八年级/初二 -> 2
        # 9年级/九年级/初三 -> 3
        patterns = {
            1: [r'7年级', r'七年级', r'初一'],
            2: [r'8年级', r'八年级', r'初二'],
            3: [r'9年级', r'九年级', r'初三']
        }
        # 返回匹配的年级ID
```

#### 4.2.2 迁移验证
- 记录总数对比
- 关键字段检查
- JSON数据完整性验证
- 提示词内容校验
- 生成迁移报告

---

## 五、API接口设计(JSON key统一使用英文)

### 5.1 用户相关接口

#### 5.1.1 用户登录
```
POST /api/user/login
Request: {
  "phone": "13800138000"
}
Response: {
  "success": true,
  "user": {
    "phone": "13800138000",
    "is_new": false,
    "last_login_at": "2025-12-18T10:00:00"
  }
}
```

---

### 5.2 提示词相关接口

#### 5.2.1 获取年级列表
```
GET /api/grades
Response: {
  "grades": [
    {"id": 1, "name": "7年级", "code": "grade_7"},
    {"id": 2, "name": "8年级", "code": "grade_8"},
    {"id": 3, "name": "9年级", "code": "grade_9"}
  ]
}
```

#### 5.2.2 获取文体列表
```
GET /api/genres
Response: {
  "genres": [
    {"id": 1, "name": "记叙文", "code": "narrative"},
    {"id": 2, "name": "议论文", "code": "argumentative"}
  ]
}
```

#### 5.2.3 获取提示词列表(按年级+文体筛选)
```
GET /api/prompts?grade_id=1&genre_id=1&type=score
Response: {
  "prompts": [
    {
      "id": 123,
      "grade_name": "7年级",
      "genre_name": "记叙文",
      "version_name": "v1.0标准版",
      "is_default": true,
      "created_by": "13800138000",
      "create_date": "2025-12-01 10:00:00"
    }
  ]
}
```

---

### 5.3 作文评价评分接口

#### 5.3.1 步骤1: 作文评价
```
POST /api/evaluations/analyze
Request: {
  "essay_id": 100,
  "analyze_prompt_id": 50,
  "user_phone": "13800138000"
}
Response: {
  "success": true,
  "evaluation_id": 200,
  "evaluation_result": {
    "overall_evaluation": {...},
    "typos": [...],
    "grammar_errors": [...],
    "highlights": [...],
    "improvement_suggestions": [...]
  }
}
```

#### 5.3.2 步骤2: 文体判断
```
POST /api/evaluations/detect-genre
Request: {
  "essay_id": 100,
  "essay_requirement": "作文要求内容",
  "essay_content": "学生作文内容"
}
Response: {
  "success": true,
  "detected_genre": {
    "genre_id": 1,
    "genre_name": "记叙文",
    "genre_code": "narrative",
    "confidence": 0.92
  },
  "detected_grade": {
    "grade_id": 1,
    "grade_name": "7年级",
    "grade_code": "grade_7"
  },
  "suggestion": "根据作文要求,建议使用记叙文提示词"
}
```

#### 5.3.3 步骤3: 作文评分
```
POST /api/scores/create
Request: {
  "evaluation_id": 200,
  "score_prompt_id": 60,
  "user_phone": "13800138000",
  "confirmed_genre_id": 1,
  "confirmed_grade_id": 1
}
Response: {
  "success": true,
  "score_id": 300,
  "score_data": {
    "total_score": 75.0,
    "dimensions": {
      "central_idea": {"score": 15.0, "max_score": 20},
      "language_expression": {"score": 18.0, "max_score": 25},
      "structure": {"score": 12.0, "max_score": 15},
      "material_selection": {"score": 11.0, "max_score": 15},
      "content_emotion": {"score": 19.0, "max_score": 25}
    }
  }
}
```

---

### 5.4 历史记录接口

#### 5.4.1 获取作文的所有评价记录
```
GET /api/essays/100/evaluations
Response: {
  "evaluations": [
    {
      "evaluation_id": 200,
      "user_phone": "13800138000",
      "create_date": "2025-12-18 10:00:00",
      "is_latest": true,
      "genre_name": "记叙文",
      "grade_name": "7年级",
      "analyze_prompt_version": "v1.0"
    }
  ]
}
```

#### 5.4.2 获取某次评价的所有评分记录
```
GET /api/evaluations/200/scores
Response: {
  "scores": [
    {
      "score_id": 300,
      "user_phone": "system",
      "score_type": "ai",
      "total_score": 75.0,
      "is_default": true,
      "create_date": "2025-12-18 10:05:00",
      "score_prompt_version": "v2.0"
    }
  ]
}
```

---

### 5.5 用户反馈接口

#### 5.5.1 提交评分对比反馈
```
POST /api/feedbacks/comparison
Request: {
  "evaluation_id": 200,
  "score_id": 300,
  "user_phone": "13800138000",
  "preferred_score": "ai"
}
Response: {
  "success": true,
  "feedback_id": 400
}
```

#### 5.5.2 提交自定义评分
```
POST /api/feedbacks/custom-score
Request: {
  "evaluation_id": 200,
  "user_phone": "13800138000",
  "custom_scores": {
    "central_idea": 16.0,
    "language_expression": 20.0,
    "structure": 12.0,
    "material_selection": 11.0,
    "content_emotion": 19.0
  }
}
Response: {
  "success": true,
  "feedback_id": 401,
  "total_score": 78.0
}
```

---

## 六、前端界面调整

### 6.1 新增页面

#### 6.1.1 登录页面(login.html)
- 输入框: 手机号输入(11位数字)
- 按钮: 登录按钮
- 校验: 前端校验手机号格式
- 跳转: 登录成功后跳转到主页面

#### 6.1.2 提示词管理页面(prompts-management.html)
- 年级选择器(7/8/9)
- 文体选择器(记叙文/议论文)
- 提示词类型切换(评价/评分)
- 提示词列表(显示所有版本+创建人)
- 新增提示词按钮
- 设置默认提示词功能
- 删除提示词功能

---

### 6.2 修改现有页面

#### 6.2.1 AI评分页面(ai-scoring.html)

**新增元素**:
1. **文体判断区域**:
   - AI判断结果展示(文体名称+置信度)
   - 年级判断结果展示
   - 文体确认/修改下拉框(记叙文/议论文)
   - 年级确认/修改下拉框(7/8/9)
   - 确认按钮

2. **提示词选择区域**:
   - 评价提示词选择器(根据年级+文体筛选)
   - 评分提示词选择器(根据年级+文体筛选)
   - 显示当前选中的提示词版本和创建人

3. **历史记录区域**:
   - 评价历史列表
   - 评分历史列表(点击评价后展开)
   - 每条记录显示: 时间、操作人、使用的提示词

4. **用户反馈区域**:
   - 评分对比按钮(AI评分 vs 原始评分)
   - 自定义评分输入框(5个维度)
   - 文字点评文本框
   - 问题标注功能

---

## 七、实施计划

### 7.1 开发阶段

#### 阶段1: 数据库设计与迁移(3天)
- [ ] 创建数据库配置文件(config.json)
- [ ] 编写数据库初始化脚本(建表+初始数据)
- [ ] 编写数据迁移脚本(essays_data.json + essays_require.json)
- [ ] 执行迁移并验证

#### 阶段2: 后端API开发(5天)
- [ ] 用户登录接口
- [ ] 提示词管理接口(CRUD)
- [ ] 文体判断接口
- [ ] 评价评分接口(重构)
- [ ] 历史记录接口
- [ ] 用户反馈接口

#### 阶段3: 前端界面开发(5天)
- [ ] 登录页面
- [ ] 提示词管理页面
- [ ] AI评分页面重构(增加文体判断步骤)
- [ ] 历史记录展示功能
- [ ] 用户反馈功能界面

#### 阶段4: 集成测试(2天)
- [ ] 完整流程测试
- [ ] 多用户并发测试
- [ ] 数据一致性测试
- [ ] 边界条件测试

#### 阶段5: 优化与部署(2天)
- [ ] 性能优化
- [ ] 代码审查
- [ ] 文档编写
- [ ] 部署上线

---

## 八、关键技术点

### 8.1 数据库连接池
```python
# 使用SQLAlchemy + PyMySQL
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine(
    f"mysql+pymysql://{user}:{password}@{host}:{port}/{database}",
    pool_size=10,
    max_overflow=20,
    pool_recycle=3600
)
SessionLocal = sessionmaker(bind=engine)
```

### 8.2 年级提取逻辑
```python
import re

def extract_grade(text):
    """从文本中提取年级(7/8/9)"""
    patterns = {
        1: [r'7年级', r'七年级', r'初一'],
        2: [r'8年级', r'八年级', r'初二'],
        3: [r'9年级', r'九年级', r'初三']
    }

    for grade_id, pattern_list in patterns.items():
        for pattern in pattern_list:
            if re.search(pattern, text):
                return grade_id

    return None  # 未匹配到年级
```

### 8.3 文体AI判断(仅记叙文/议论文)
```python
def detect_genre(essay_requirement, essay_content):
    prompt = f"""
    根据以下作文要求和学生作文,判断文体类型(记叙文或议论文)。

    作文要求:
    {essay_requirement}

    学生作文:
    {essay_content[:500]}

    请输出JSON格式:
    {{
      "genre": "narrative|argumentative",
      "confidence": 0.92,
      "reason": "判断依据"
    }}
    """
    # 调用OpenAI API
    # 返回判断结果
```

### 8.4 JSON字符串存储与读取
```python
import json

# 存储到数据库
evaluation_result_str = json.dumps(evaluation_result, ensure_ascii=False)
db_record.evaluation_result = evaluation_result_str

# 从数据库读取
evaluation_result = json.loads(db_record.evaluation_result)
```

---

## 九、配置文件示例

### 9.1 config.json
```json
{
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "your_password",
    "database": "essay_scoring",
    "charset": "utf8mb4"
  },
  "openai": {
    "base_url": "https://api.chatanywhere.tech/v1",
    "api_key": "your_api_key",
    "model": "gpt-4"
  },
  "system": {
    "page_size": 20,
    "max_history": 100,
    "session_timeout": 3600
  }
}
```

---

## 十、风险点与注意事项

### 10.1 数据迁移风险
- **风险**: JSON数据结构不一致导致迁移失败
- **应对**: 迁移前数据格式校验,异常数据记录到日志

### 10.2 年级提取准确性
- **风险**: 作文要求中无明确年级信息
- **应对**: 提供手动选择年级的兜底方案

### 10.3 提示词共享
- **风险**: 提示词过多导致选择困难
- **应对**:
  - 合理设置默认提示词
  - 显示创建人信息
  - 支持提示词搜索和筛选

### 10.4 TEXT字段长度
- **风险**: 评价结果或提示词内容过长
- **应对**:
  - TEXT类型最大64KB,足够使用
  - 如需更大,可使用MEDIUMTEXT(16MB)

---

## 十一、总结

本次重构关键点:
- **数据存储**: JSON → MySQL(9张表,统一字段规范)
- **年级范围**: 7/8/9年级(初中)
- **文体范围**: 记叙文/议论文
- **提示词**: 全局共享,所有用户可见可用
- **数据类型**: ID用INT,JSON用TEXT,小数用FLOAT
- **JSON Key**: 统一使用英文
- **数据迁移**: essays_data.json + essays_require.json

预计开发周期: **17个工作日**

---

**文档版本**: v2.0
**编写日期**: 2025-12-18
**最后更新**: 2025-12-18
