<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ–‡è¯„åˆ†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: bold;
            color: #333;
        }

        .controls select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .controls .ai-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            font-weight: bold;
        }

        .controls .ai-btn:hover {
            background: linear-gradient(135deg, #ee5a6f 0%, #c44569 100%);
        }

        .essay-info {
            padding: 20px 30px;
            background: #fff9e6;
            border-bottom: 2px solid #e0e0e0;
        }

        .essay-info h2 {
            color: #764ba2;
            margin-bottom: 10px;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .image-container, .pdf-container {
            width: 100%;
            max-height: 600px;
            overflow: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .image-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .pdf-container iframe {
            width: 100%;
            height: 600px;
            border: none;
        }

        .pdf-container canvas {
            width: 100%;
            height: auto;
            display: block;
            margin-bottom: 10px;
        }

        .pdf-viewer-wrapper {
            width: 100%;
            height: 600px;
            overflow-y: auto;
            background: #525659;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .pdf-loading {
            color: white;
            padding: 20px;
            text-align: center;
        }

        .text-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            white-space: pre-wrap;
            height: 600px;
            overflow-y: auto;
            border: 2px solid #ddd;
        }

        .scores-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-height: 520px;
            overflow-y: auto;
        }

        .score-system-selector {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }

        .score-system-selector label {
            font-weight: bold;
            color: #1976d2;
            margin-right: 10px;
        }

        .score-system-selector select {
            padding: 8px 15px;
            border: 2px solid #2196f3;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            font-weight: bold;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-left: 5px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .warning-box.show {
            display: block;
            animation: shake 0.5s;
        }

        .warning-box .warning-icon {
            color: #ff9800;
            font-size: 20px;
            margin-right: 10px;
        }

        .warning-box .warning-text {
            color: #856404;
            font-weight: bold;
        }

        .warning-box .warning-detail {
            color: #856404;
            margin-top: 5px;
            font-size: 14px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .score-item:hover {
            transform: translateX(5px);
        }

        .score-item.total {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }

        .score-label {
            font-weight: bold;
            color: #333;
            flex: 1;
        }

        .score-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            font-weight: bold;
        }

        .score-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .max-score {
            color: #666;
            font-size: 14px;
        }

        .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .save-btn:hover {
            transform: scale(1.02);
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
        }

        .pagination {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .pagination button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination .page-info {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #667eea;
            min-width: 150px;
            text-align: center;
        }

        .pagination .jump-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination .jump-input {
            width: 80px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .pagination .jump-btn {
            min-width: 80px;
        }


        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }

            .text-content {
                height: 400px;
            }

            .scores-container {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ä½œæ–‡è¯„åˆ†ç³»ç»Ÿ</h1>
            <p>ä½œæ–‡æ‰¹æ”¹ä¸åˆ†æ•°ç®¡ç†å¹³å°</p>
        </div>

        <div class="controls">
            <label for="essaySelect">é€‰æ‹©ä½œæ–‡:</label>
            <select id="essaySelect">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
            <button onclick="loadEssay()">åŠ è½½ä½œæ–‡</button>
            <button class="ai-btn" onclick="goToAIScoring()">ğŸ¤– AIè¯„åˆ†</button>
            <span id="totalCount" style="margin-left: auto; color: #666;"></span>
        </div>

        <div class="essay-info" id="essayInfo" style="display: none;">
            <h2 id="studentName"></h2>
            <p><strong>ç›®å½•:</strong> <span id="directoryName"></span></p>
        </div>

        <div class="content-area" id="contentArea" style="display: none;">
            <!-- ç¬¬ä¸€è¡Œï¼šä½œæ–‡ç­”å· å’Œ ä½œæ–‡å†…å®¹ -->
            <div class="section">
                <h3>ğŸ“· ä½œæ–‡ç­”å·</h3>
                <div class="image-container" id="imageContainer">
                    <img id="essayImage" src="" alt="ä½œæ–‡ç­”å·">
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“– ä½œæ–‡å†…å®¹</h3>
                <div class="text-content" id="essayContent"></div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šåˆ†ææŠ¥å‘Š å’Œ åˆ†æ•°ç®¡ç† -->
            <div class="section">
                <h3>ğŸ“„ åˆ†ææŠ¥å‘Š</h3>
                <div class="pdf-container" id="pdfContainer">
                    <div class="pdf-viewer-wrapper" id="pdfViewerWrapper">
                        <div class="pdf-loading">æ­£åœ¨åŠ è½½PDF...</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“Š åˆ†æ•°ç®¡ç†</h3>
                <div class="scores-container" id="scoresContainer">
                    <!-- åˆ†æ•°é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="save-btn" onclick="saveScores()">ğŸ’¾ ä¿å­˜åˆ†æ•°</button>
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevBtn" onclick="previousEssay()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <div class="page-info">
                <span id="pageInfo">0 / 0</span>
            </div>
            <button id="nextBtn" onclick="nextEssay()">ä¸‹ä¸€é¡µ â¡ï¸</button>
            <div class="jump-group">
                <label>è·³è½¬åˆ°:</label>
                <input type="number" class="jump-input" id="jumpInput" min="1" placeholder="é¡µç ">
                <button class="jump-btn" onclick="jumpToPage()">è·³è½¬</button>
            </div>
        </div>
    </div>

    <div class="message" id="message"></div>

    <!-- PDF.js åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // é…ç½®PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script>
        let essaysData = [];
        let currentIndex = -1;
        const API_BASE = 'http://localhost:8008/api';
        // const API_BASE = 'http://192.168.3.88:8008/api';

        // ä½¿ç”¨PDF.jsåŠ è½½å’Œæ¸²æŸ“PDF
        async function loadPdfWithPdfJs(pdfUrl) {
            const container = document.getElementById('pdfViewerWrapper');
            container.innerHTML = '<div class="pdf-loading">æ­£åœ¨åŠ è½½PDF...</div>';

            try {
                // åŠ è½½PDFæ–‡æ¡£
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;

                container.innerHTML = '';

                // æ¸²æŸ“æ‰€æœ‰é¡µé¢
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);

                    // è®¡ç®—åˆé€‚çš„ç¼©æ”¾æ¯”ä¾‹
                    const viewport = page.getViewport({ scale: 1.5 });

                    // åˆ›å»ºcanvaså…ƒç´ 
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // æ¸²æŸ“PDFé¡µé¢åˆ°canvas
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;
                    container.appendChild(canvas);
                }

                console.log(`PDFåŠ è½½æˆåŠŸ: ${pdf.numPages} é¡µ`);
            } catch (error) {
                console.error('PDFåŠ è½½å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="pdf-loading" style="color: #f44336;">
                        âŒ PDFåŠ è½½å¤±è´¥<br>
                        <small>${error.message}</small><br>
                        <a href="${pdfUrl}" target="_blank" style="color: white; text-decoration: underline;">
                            ç‚¹å‡»ä¸‹è½½PDFæ–‡ä»¶
                        </a>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ‰€æœ‰ä½œæ–‡æ•°æ®
        async function loadAllEssays() {
            try {
                const response = await fetch(`${API_BASE}/essays`);
                const data = await response.json();
                essaysData = data.essays;

                // å¡«å……ä¸‹æ‹‰åˆ—è¡¨
                const select = document.getElementById('essaySelect');
                select.innerHTML = essaysData.map((essay, index) =>
                    `<option value="${index}">${index + 1}. ${essay.student_name}</option>`
                ).join('');

                document.getElementById('totalCount').textContent = `å…± ${data.total} ç¯‡ä½œæ–‡`;

                // é»˜è®¤åŠ è½½ç¬¬ä¸€ç¯‡
                if (essaysData.length > 0) {
                    select.value = 0;
                    loadEssay();
                }
            } catch (error) {
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é€‰ä¸­çš„ä½œæ–‡
        function loadEssay() {
            const select = document.getElementById('essaySelect');
            currentIndex = parseInt(select.value);

            if (currentIndex < 0 || currentIndex >= essaysData.length) {
                return;
            }

            const essay = essaysData[currentIndex];

            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            document.getElementById('essayInfo').style.display = 'block';
            document.getElementById('studentName').textContent = `å­¦ç”Ÿ: ${essay.student_name}`;
            document.getElementById('directoryName').textContent = essay.directory_name;

            // æ˜¾ç¤ºä½œæ–‡å†…å®¹
            document.getElementById('essayContent').textContent = essay.essay_content;

            // åŠ è½½å›¾ç‰‡ - ç›´æ¥ä½¿ç”¨OSSåœ°å€
            const imageUrl = essay.essay_image_path;
            document.getElementById('essayImage').src = imageUrl;

            // åŠ è½½PDF - ä½¿ç”¨PDF.jsæ¸²æŸ“
            const pdfUrl = essay.analysis_report_path;
            loadPdfWithPdfJs(pdfUrl);

            // æ¸²æŸ“åˆ†æ•°
            renderScores(essay.score_data);

            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            document.getElementById('contentArea').style.display = 'grid';

            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePagination();
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
        function updatePagination() {
            if (essaysData.length === 0) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('pagination').style.display = 'flex';

            // æ›´æ–°é¡µé¢ä¿¡æ¯
            document.getElementById('pageInfo').textContent = `${currentIndex + 1} / ${essaysData.length}`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevBtn').disabled = currentIndex <= 0;
            document.getElementById('nextBtn').disabled = currentIndex >= essaysData.length - 1;

            // åŒæ­¥ä¸‹æ‹‰æ¡†
            document.getElementById('essaySelect').value = currentIndex;
        }

        // ä¸Šä¸€é¡µ
        function previousEssay() {
            if (currentIndex > 0) {
                currentIndex--;
                document.getElementById('essaySelect').value = currentIndex;
                loadEssay();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextEssay() {
            if (currentIndex < essaysData.length - 1) {
                currentIndex++;
                document.getElementById('essaySelect').value = currentIndex;
                loadEssay();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function jumpToPage() {
            const input = document.getElementById('jumpInput');
            const pageNum = parseInt(input.value);

            if (isNaN(pageNum)) {
                showMessage('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ', 'error');
                return;
            }

            if (pageNum < 1 || pageNum > essaysData.length) {
                showMessage(`âš ï¸ é¡µç èŒƒå›´: 1-${essaysData.length}`, 'error');
                return;
            }

            currentIndex = pageNum - 1;
            document.getElementById('essaySelect').value = currentIndex;
            loadEssay();
            input.value = '';
        }

        // æ”¯æŒå›è½¦é”®è·³è½¬
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jumpInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });
        });

        // æ¸²æŸ“åˆ†æ•°è¡¨å•
        function renderScores(scoreData) {
            const container = document.getElementById('scoresContainer');
            let html = '';

            // ç¡®å®šåˆ†åˆ¶ï¼šæ€»åˆ† <= 10 ä¸º10åˆ†åˆ¶ï¼Œå¦åˆ™ä¸º40åˆ†åˆ¶
            const scoreSystem = scoreData.total_score <= 10 ? 10 : 40;

            // åˆ†åˆ¶é€‰æ‹©å™¨
            html += `
                <div class="score-system-selector">
                    <label>ğŸ“ åˆ†åˆ¶é€‰æ‹©:</label>
                    <select id="scoreSystemSelect" onchange="updateScoreSystem()">
                        <option value="10" ${scoreSystem === 10 ? 'selected' : ''}>10åˆ†åˆ¶</option>
                        <option value="40" ${scoreSystem === 40 ? 'selected' : ''}>40åˆ†åˆ¶</option>
                    </select>
                </div>
            `;

            // è­¦å‘Šæ¡†
            html += `
                <div class="warning-box" id="warningBox">
                    <div style="display: flex; align-items: center;">
                        <span class="warning-icon">âš ï¸</span>
                        <span class="warning-text" id="warningText"></span>
                    </div>
                    <div class="warning-detail" id="warningDetail"></div>
                </div>
            `;

            // æ€»åˆ†
            const maxTotalScore = scoreSystem;
            html += `
                <div class="score-item total">
                    <span class="score-label">ğŸ† æ€»åˆ†</span>
                    <div class="score-input-group">
                        <input type="number" class="score-input" id="total_score"
                               value="${scoreData.total_score}" step="0.5" min="0" max="${maxTotalScore}"
                               oninput="checkScoreConsistency()">
                        <span class="max-score">/ ${maxTotalScore}</span>
                    </div>
                </div>
            `;

            // å„ç»´åº¦åˆ†æ•°
            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                html += `
                    <div class="score-item">
                        <span class="score-label">${dimName}</span>
                        <div class="score-input-group">
                            <input type="number" class="score-input dimension-score"
                                   data-dimension="${dimName}"
                                   value="${dimData.score}" step="1" min="0" max="${dimData.max_score}"
                                   oninput="checkScoreConsistency()">
                            <span class="max-score">/ ${dimData.max_score}</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // åˆå§‹æ£€æŸ¥åˆ†æ•°ä¸€è‡´æ€§
            checkScoreConsistency();
        }

        // æ›´æ–°åˆ†åˆ¶
        function updateScoreSystem() {
            const scoreSystem = parseInt(document.getElementById('scoreSystemSelect').value);
            const totalScoreInput = document.getElementById('total_score');

            // æ›´æ–°æ€»åˆ†çš„æœ€å¤§å€¼
            totalScoreInput.max = scoreSystem;

            // æ›´æ–°æ€»åˆ†æ˜¾ç¤ºçš„æœ€å¤§å€¼æ–‡æœ¬
            const maxScoreSpan = totalScoreInput.closest('.score-input-group').querySelector('.max-score');
            maxScoreSpan.textContent = `/ ${scoreSystem}`;

            // å¦‚æœå½“å‰æ€»åˆ†è¶…è¿‡æ–°åˆ†åˆ¶ï¼Œè°ƒæ•´ä¸ºæ–°åˆ†åˆ¶çš„æœ€å¤§å€¼
            if (parseFloat(totalScoreInput.value) > scoreSystem) {
                totalScoreInput.value = scoreSystem;
            }

            // é‡æ–°æ£€æŸ¥åˆ†æ•°ä¸€è‡´æ€§
            checkScoreConsistency();
        }

        // æ£€æŸ¥åˆ†æ•°ä¸€è‡´æ€§
        function checkScoreConsistency() {
            const warningBox = document.getElementById('warningBox');
            const warningText = document.getElementById('warningText');
            const warningDetail = document.getElementById('warningDetail');

            // è·å–å½“å‰æ€»åˆ†
            const currentTotalScore = parseFloat(document.getElementById('total_score').value);

            // è·å–å½“å‰åˆ†åˆ¶
            const scoreSystem = parseInt(document.getElementById('scoreSystemSelect').value);

            // è®¡ç®—å„ç»´åº¦å¾—åˆ†ä¹‹å’Œ
            let dimensionsSum = 0;
            document.querySelectorAll('.dimension-score').forEach(input => {
                dimensionsSum += parseFloat(input.value) || 0;
            });

            // è®¡ç®—æœŸæœ›æ€»åˆ†: int((å„ç»´åº¦å¾—åˆ†ä¹‹å’Œ / 100) Ã— åˆ†åˆ¶)
            const expectedTotalScore = Math.floor((dimensionsSum / 100) * scoreSystem);

            // æ£€æŸ¥æ˜¯å¦ä¸€è‡´
            if (Math.abs(currentTotalScore - expectedTotalScore) > 0.01) {
                warningBox.classList.add('show');
                warningText.textContent = 'æ€»åˆ†ä¸ä¸€è‡´è­¦å‘Šï¼';
                warningDetail.innerHTML = `
                    <strong>å½“å‰æ€»åˆ†:</strong> ${currentTotalScore} åˆ†<br>
                    <strong>æœŸæœ›æ€»åˆ†:</strong> ${expectedTotalScore} åˆ†<br>
                    <strong>å„ç»´åº¦å¾—åˆ†ä¹‹å’Œ:</strong> ${dimensionsSum} åˆ†<br>
                    <strong>è®¡ç®—å…¬å¼:</strong> int((${dimensionsSum} / 100) Ã— ${scoreSystem}) = ${expectedTotalScore}
                `;
            } else {
                warningBox.classList.remove('show');
            }
        }

        // ä¿å­˜åˆ†æ•°
        async function saveScores() {
            if (currentIndex < 0) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡ä½œæ–‡', 'error');
                return;
            }

            const essay = essaysData[currentIndex];

            // æ”¶é›†åˆ†æ•°æ•°æ®
            const totalScore = parseFloat(document.getElementById('total_score').value);
            const dimensions = {};

            document.querySelectorAll('.dimension-score').forEach(input => {
                const dimName = input.dataset.dimension;
                const score = parseFloat(input.value);
                dimensions[dimName] = {
                    score: score,
                    max_score: essay.score_data.dimensions[dimName].max_score
                };
            });

            const scoreData = {
                total_score: totalScore,
                dimensions: dimensions
            };

            try {
                const response = await fetch(`${API_BASE}/essays/${currentIndex}/score`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        index: currentIndex,
                        score_data: scoreData
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    essaysData[currentIndex] = result.data;
                    showMessage('âœ… åˆ†æ•°ä¿å­˜æˆåŠŸ!', 'success');
                } else {
                    const error = await response.json();
                    showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.background = type === 'success' ? '#4caf50' : '#f44336';
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // è·³è½¬åˆ°AIè¯„åˆ†é¡µé¢
        function goToAIScoring() {
            if (currentIndex < 0) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ç¯‡ä½œæ–‡', 'error');
                return;
            }
            window.location.href = `ai-scoring.html?index=${currentIndex}`;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadAllEssays();

            // å¦‚æœURLæœ‰indexå‚æ•°ï¼Œè‡ªåŠ¨åŠ è½½è¯¥ä½œæ–‡
            const params = new URLSearchParams(window.location.search);
            const urlIndex = params.get('index');
            if (urlIndex !== null) {
                setTimeout(() => {
                    const index = parseInt(urlIndex);
                    if (index >= 0 && index < essaysData.length) {
                        document.getElementById('essaySelect').value = index;
                        loadEssay();
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>
