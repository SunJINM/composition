# 作文评分系统重构需求分析文档

## 一、项目背景

### 1.1 当前系统概况
- **技术栈**: FastAPI + JSON文件存储
- **核心功能**: 作文评价 → 作文评分(两步流程)
- **提示词管理**: 评价提示词和评分提示词分别管理,支持多版本
- **数据存储**: 所有数据存储在本地JSON文件中

### 1.2 重构目标
1. 数据持久化方案从JSON迁移到MySQL数据库
2. 提示词管理更精细化,支持年级+文体+版本三层维度
3. 评分流程优化,增加文体判断中间步骤
4. 完善评价/评分历史记录管理
5. 增加用户系统和多用户评分功能
6. 支持用户反馈和评分对比功能

---

## 二、核心需求详解

### 2.1 数据库迁移需求

#### 2.1.1 迁移范围
- ✅ 现有JSON文件数据全部迁移到MySQL
- ✅ 包括: 作文数据、评价结果、评分结果、提示词、作文要求
- ✅ 编写自动化迁移脚本

#### 2.1.2 配置管理
- **配置方式**: 使用配置文件(config.py或config.json)
- **配置内容**:
  - 数据库连接信息(host, port, user, password, database)
  - OpenAI API配置
  - 系统参数配置

---

### 2.2 提示词分层管理需求

#### 2.2.1 提示词组织结构(三层)
```
年级(Grade)
├── 文体(Genre)
│   ├── 版本1(Version)
│   ├── 版本2
│   └── 版本3
└── ...
```

**示例**:
- 小学五年级 → 记叙文 → v1.0标准版
- 小学五年级 → 记叙文 → v2.0严格版
- 小学五年级 → 议论文 → v1.0标准版
- 初中二年级 → 记叙文 → v1.0标准版

#### 2.2.2 提示词类型
1. **评价提示词**(analyze_prompt): 用于作文分析(第一步)
2. **评分提示词**(score_prompt): 用于作文评分(第二步)

#### 2.2.3 支持的年级范围
- 小学: 一年级~六年级
- 初中: 七年级~九年级
- 高中: 高一~高三

#### 2.2.4 支持的文体类型
- 记叙文
- 议论文
- 说明文
- 应用文(书信、演讲稿等)
- 其他(自定义)

---

### 2.3 文体判断需求

#### 2.3.1 文体判断流程
```
作文要求 + 学生作文 → AI文体判断 → 用户确认/修改 → 选择对应提示词
```

#### 2.3.2 判断逻辑(混合模式)
1. **AI自动判断**:
   - 优先基于作文要求判断文体
   - 分析学生作文内容进行辅助判断
   - 返回判断结果和置信度

2. **用户确认机制**:
   - 展示AI判断结果(推荐文体)
   - 用户可以接受或手动修改文体选择
   - 用户确认后进入评分流程

#### 2.3.3 年级确定方式
- **主要方式**: 从作文要求中提取年级信息
- **提取逻辑**:
  - 使用正则表达式匹配"五年级"、"初二"等关键词
  - AI辅助提取年级信息
- **兜底方案**: 如果无法提取,提供年级选择器让用户手动选择

---

### 2.4 评价评分流程重构

#### 2.4.1 新评分流程(三步)
```
步骤1: 作文评价(AI分析)
  ↓
步骤2: 文体判断(AI判断 + 用户确认)
  ↓
步骤3: 作文评分(基于评价结果 + 对应提示词)
```

#### 2.4.2 评价结果结构
```json
{
  "综合评价": {
    "整体质量": "良好",
    "主要优点": ["优点1", "优点2"],
    "主要问题": ["问题1", "问题2"],
    "总体建议": "建议内容"
  },
  "错别字": [
    {
      "位置": "第2段第3句",
      "错误": "的地",
      "正确": "的"
    }
  ],
  "错别字总数": 5,
  "语病": [
    {
      "位置": "第1段第2句",
      "问题描述": "主谓不一致",
      "原句": "我和小明去公园玩。",
      "修改建议": "我和小明去公园玩耍。"
    }
  ],
  "语病总数": 3,
  "优点亮点": [
    {
      "位置": "第3段",
      "内容": "细节描写生动",
      "评价": "通过动作描写展现人物性格"
    }
  ],
  "改进建议": [
    {
      "方面": "语言",
      "具体建议": "多使用修辞手法"
    }
  ]
}
```

#### 2.4.3 评分结果结构
```json
{
  "total_score": 75,
  "dimensions": {
    "中心立意": {"score": 15, "max_score": 20},
    "语言表达": {"score": 18, "max_score": 25},
    "篇章结构": {"score": 12, "max_score": 15},
    "文章选材": {"score": 11, "max_score": 15},
    "内容情感": {"score": 19, "max_score": 25}
  }
}
```

---

### 2.5 历史记录管理需求

#### 2.5.1 评价评分关系模型
```
一次评价(Evaluation)
├── 评价结果(完整JSON)
├── 评价时间
├── 评价人(手机号)
├── 使用的评价提示词
└── 关联的多次评分(Scores)
    ├── 评分1(默认AI评分)
    │   ├── 评分结果(各维度分数)
    │   ├── 评分时间
    │   ├── 评分人(系统/手机号)
    │   ├── 使用的评分提示词
    │   └── 用户反馈
    ├── 评分2(用户A的评分)
    └── 评分3(用户B的评分)
```

#### 2.5.2 业务逻辑说明
- **同一评价,不同用户可多次评分**:
  - 用户A执行评价后,基于该评价结果生成默认AI评分
  - 用户B可以基于用户A的评价结果,使用自己选择的提示词重新评分
  - 用户C也可以基于同一评价结果进行评分
  - 每个用户的评分独立存储,互不影响

#### 2.5.3 存储内容清单
- [x] 完整评价内容(错别字/语病/优点/建议)
- [x] 评分详情(各维度分数)
- [x] 使用的提示词信息(评价提示词+评分提示词)
- [x] 时间戳和操作人(手机号)
- [x] 判断的文体和年级信息

#### 2.5.4 展示需求
- **默认展示**: 最新的评价和评分结果
- **历史查看**:
  - 查看所有历史评价记录(时间倒序)
  - 点击某次评价,查看基于该评价的所有评分记录
  - 每条记录显示: 评价人/评分人、时间、使用的提示词版本

---

### 2.6 用户系统需求

#### 2.6.1 登录功能
- **登录方式**: 简单手机号登录(无验证码)
- **登录流程**:
  1. 用户输入11位手机号
  2. 系统校验格式
  3. 如果是新手机号,自动注册并登录
  4. 如果是已注册手机号,直接登录
  5. 登录成功后跳转到主页面

#### 2.6.2 用户信息存储
- 手机号(唯一标识)
- 首次登录时间
- 最后登录时间
- 登录次数

#### 2.6.3 用户权限
- 所有用户权限相同
- 可以查看所有作文和历史记录
- 可以对任意作文进行评价和评分
- 评价和评分会关联用户手机号

---

### 2.7 用户评价功能需求

#### 2.7.1 功能清单
- [x] **AI评分 vs 原始评分对比**: 用户可以标记哪个评分更准确
- [x] **用户自定义评分**: 用户可以输入自己认为的各维度分数
- [x] **文字点评**: 用户可以对本次AI评价进行文字反馈
- [x] **问题标注**: 用户可以标注AI评价中的错误项(如误判的错别字/语病)

#### 2.7.2 用户反馈数据结构
```json
{
  "evaluation_id": "评价ID",
  "score_id": "评分ID",
  "user_phone": "13800138000",
  "feedback_type": "comparison|custom_score|comment|issue_mark",
  "feedback_data": {
    "preferred_score": "ai|original",  // comparison类型
    "custom_scores": {  // custom_score类型
      "中心立意": 16,
      "语言表达": 20,
      ...
    },
    "comment_text": "评价文字",  // comment类型
    "marked_issues": [  // issue_mark类型
      {
        "type": "错别字|语病",
        "position": "第2段第3句",
        "reason": "这不是错别字,是方言用法"
      }
    ]
  },
  "created_at": "2025-12-18T10:30:00"
}
```

---

## 三、数据库设计

### 3.1 数据库表结构(规范化设计)

#### 3.1.1 用户表(users)
```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  phone VARCHAR(11) UNIQUE NOT NULL COMMENT '手机号',
  first_login_at DATETIME NOT NULL COMMENT '首次登录时间',
  last_login_at DATETIME NOT NULL COMMENT '最后登录时间',
  login_count INT DEFAULT 1 COMMENT '登录次数',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 3.1.2 年级表(grades)
```sql
CREATE TABLE grades (
  id INT PRIMARY KEY AUTO_INCREMENT,
  grade_name VARCHAR(50) NOT NULL COMMENT '年级名称',
  grade_level VARCHAR(20) NOT NULL COMMENT '学段:小学/初中/高中',
  sort_order INT NOT NULL COMMENT '排序',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_grade_name (grade_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='年级表';
```

#### 3.1.3 文体表(genres)
```sql
CREATE TABLE genres (
  id INT PRIMARY KEY AUTO_INCREMENT,
  genre_name VARCHAR(50) NOT NULL COMMENT '文体名称',
  genre_code VARCHAR(20) NOT NULL COMMENT '文体编码',
  description VARCHAR(200) COMMENT '文体描述',
  sort_order INT NOT NULL COMMENT '排序',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_genre_code (genre_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文体表';
```

#### 3.1.4 提示词表(prompts)
```sql
CREATE TABLE prompts (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  grade_id INT NOT NULL COMMENT '年级ID',
  genre_id INT NOT NULL COMMENT '文体ID',
  prompt_type ENUM('analyze', 'score') NOT NULL COMMENT '提示词类型',
  version_name VARCHAR(50) NOT NULL COMMENT '版本名称',
  prompt_content TEXT NOT NULL COMMENT '提示词内容',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认',
  created_by VARCHAR(11) COMMENT '创建人手机号',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_grade_genre (grade_id, genre_id, prompt_type),
  FOREIGN KEY (grade_id) REFERENCES grades(id),
  FOREIGN KEY (genre_id) REFERENCES genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='提示词表';
```

#### 3.1.5 作文要求表(essay_requirements)
```sql
CREATE TABLE essay_requirements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(200) NOT NULL COMMENT '作文题目',
  requirement_text TEXT NOT NULL COMMENT '作文要求',
  grade_id INT COMMENT '年级ID(从要求中提取)',
  suggested_genre_id INT COMMENT '建议文体ID',
  word_count_min INT COMMENT '最小字数要求',
  word_count_max INT COMMENT '最大字数要求',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_grade (grade_id),
  FOREIGN KEY (grade_id) REFERENCES grades(id),
  FOREIGN KEY (suggested_genre_id) REFERENCES genres(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文要求表';
```

#### 3.1.6 作文表(essays)
```sql
CREATE TABLE essays (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  requirement_id BIGINT COMMENT '作文要求ID',
  student_name VARCHAR(100) COMMENT '学生姓名',
  essay_content TEXT NOT NULL COMMENT '作文内容',
  essay_image_path VARCHAR(500) COMMENT '作文图片路径',
  analysis_report_path VARCHAR(500) COMMENT '分析报告路径',
  word_count INT NOT NULL COMMENT '字数统计',
  original_score DECIMAL(5,2) COMMENT '原始评分',
  original_score_data JSON COMMENT '原始评分详情',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_requirement (requirement_id),
  FOREIGN KEY (requirement_id) REFERENCES essay_requirements(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='作文表';
```

#### 3.1.7 评价表(evaluations)
```sql
CREATE TABLE evaluations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  essay_id BIGINT NOT NULL COMMENT '作文ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评价人手机号',
  analyze_prompt_id BIGINT NOT NULL COMMENT '使用的评价提示词ID',
  detected_genre_id INT COMMENT 'AI判断的文体ID',
  detected_grade_id INT COMMENT 'AI判断的年级ID',
  confirmed_genre_id INT NOT NULL COMMENT '用户确认的文体ID',
  confirmed_grade_id INT NOT NULL COMMENT '用户确认的年级ID',
  genre_confidence DECIMAL(3,2) COMMENT 'AI判断文体的置信度',
  evaluation_result JSON NOT NULL COMMENT '评价结果(完整JSON)',
  is_latest TINYINT(1) DEFAULT 1 COMMENT '是否最新评价',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_essay (essay_id),
  INDEX idx_user (user_phone),
  INDEX idx_latest (essay_id, is_latest),
  FOREIGN KEY (essay_id) REFERENCES essays(id),
  FOREIGN KEY (user_phone) REFERENCES users(phone),
  FOREIGN KEY (analyze_prompt_id) REFERENCES prompts(id),
  FOREIGN KEY (detected_genre_id) REFERENCES genres(id),
  FOREIGN KEY (confirmed_genre_id) REFERENCES genres(id),
  FOREIGN KEY (detected_grade_id) REFERENCES grades(id),
  FOREIGN KEY (confirmed_grade_id) REFERENCES grades(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

#### 3.1.8 评分表(scores)
```sql
CREATE TABLE scores (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  evaluation_id BIGINT NOT NULL COMMENT '评价ID',
  user_phone VARCHAR(11) NOT NULL COMMENT '评分人手机号(system表示AI)',
  score_prompt_id BIGINT NOT NULL COMMENT '使用的评分提示词ID',
  score_type ENUM('ai', 'user') NOT NULL COMMENT '评分类型',
  total_score DECIMAL(5,2) NOT NULL COMMENT '总分',
  dimension_scores JSON NOT NULL COMMENT '各维度分数',
  is_default TINYINT(1) DEFAULT 0 COMMENT '是否默认评分',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES evaluations(id),
  FOREIGN KEY (user_phone) REFERENCES users(phone),
  FOREIGN KEY (score_prompt_id) REFERENCES prompts(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评分表';
```

#### 3.1.9 用户反馈表(user_feedbacks)
```sql
CREATE TABLE user_feedbacks (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  evaluation_id BIGINT NOT NULL COMMENT '评价ID',
  score_id BIGINT COMMENT '评分ID(针对评分的反馈)',
  user_phone VARCHAR(11) NOT NULL COMMENT '反馈人手机号',
  feedback_type ENUM('comparison', 'custom_score', 'comment', 'issue_mark') NOT NULL,
  feedback_data JSON NOT NULL COMMENT '反馈数据',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_evaluation (evaluation_id),
  INDEX idx_score (score_id),
  INDEX idx_user (user_phone),
  FOREIGN KEY (evaluation_id) REFERENCES evaluations(id),
  FOREIGN KEY (score_id) REFERENCES scores(id),
  FOREIGN KEY (user_phone) REFERENCES users(phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

### 3.2 数据库初始化数据

#### 3.2.1 年级初始化数据
```sql
INSERT INTO grades (grade_name, grade_level, sort_order) VALUES
('小学一年级', '小学', 1),
('小学二年级', '小学', 2),
('小学三年级', '小学', 3),
('小学四年级', '小学', 4),
('小学五年级', '小学', 5),
('小学六年级', '小学', 6),
('初中七年级', '初中', 7),
('初中八年级', '初中', 8),
('初中九年级', '初中', 9),
('高中一年级', '高中', 10),
('高中二年级', '高中', 11),
('高中三年级', '高中', 12);
```

#### 3.2.2 文体初始化数据
```sql
INSERT INTO genres (genre_name, genre_code, description, sort_order) VALUES
('记叙文', 'narrative', '以记人、叙事、写景、状物为主的文章', 1),
('议论文', 'argumentative', '以议论为主要表达方式的文章', 2),
('说明文', 'expository', '以说明为主要表达方式的文章', 3),
('应用文', 'practical', '书信、演讲稿、通知等实用文体', 4),
('其他', 'other', '其他类型文体', 99);
```

---

## 四、API接口设计

### 4.1 用户相关接口

#### 4.1.1 用户登录
```
POST /api/user/login
Request: {
  "phone": "13800138000"
}
Response: {
  "success": true,
  "user": {
    "phone": "13800138000",
    "is_new": false,
    "last_login_at": "2025-12-18T10:00:00"
  }
}
```

#### 4.1.2 获取当前用户信息
```
GET /api/user/profile
Headers: {
  "X-User-Phone": "13800138000"
}
Response: {
  "phone": "13800138000",
  "first_login_at": "2025-12-01T10:00:00",
  "login_count": 15
}
```

---

### 4.2 提示词相关接口

#### 4.2.1 获取年级列表
```
GET /api/grades
Response: {
  "grades": [
    {"id": 1, "name": "小学一年级", "level": "小学"},
    {"id": 5, "name": "小学五年级", "level": "小学"}
  ]
}
```

#### 4.2.2 获取文体列表
```
GET /api/genres
Response: {
  "genres": [
    {"id": 1, "name": "记叙文", "code": "narrative"},
    {"id": 2, "name": "议论文", "code": "argumentative"}
  ]
}
```

#### 4.2.3 获取提示词列表(按年级+文体筛选)
```
GET /api/prompts?grade_id=5&genre_id=1&type=score
Response: {
  "prompts": [
    {
      "id": 123,
      "grade_name": "小学五年级",
      "genre_name": "记叙文",
      "version_name": "v1.0标准版",
      "is_default": true,
      "created_at": "2025-12-01T10:00:00"
    }
  ]
}
```

#### 4.2.4 创建新提示词
```
POST /api/prompts
Request: {
  "grade_id": 5,
  "genre_id": 1,
  "prompt_type": "score",
  "version_name": "v3.0严格版",
  "prompt_content": "提示词内容..."
}
Response: {
  "success": true,
  "prompt_id": 124
}
```

---

### 4.3 作文评价评分接口

#### 4.3.1 步骤1: 作文评价
```
POST /api/evaluations/analyze
Request: {
  "essay_id": 100,
  "analyze_prompt_id": 50,
  "user_phone": "13800138000"
}
Response: {
  "success": true,
  "evaluation_id": 200,
  "evaluation_result": {
    "综合评价": {...},
    "错别字": [...],
    "语病": [...],
    "优点亮点": [...],
    "改进建议": [...]
  }
}
```

#### 4.3.2 步骤2: 文体判断
```
POST /api/evaluations/detect-genre
Request: {
  "essay_id": 100,
  "essay_requirement": "作文要求内容",
  "essay_content": "学生作文内容"
}
Response: {
  "success": true,
  "detected_genre": {
    "genre_id": 1,
    "genre_name": "记叙文",
    "confidence": 0.92
  },
  "detected_grade": {
    "grade_id": 5,
    "grade_name": "小学五年级"
  },
  "suggestion": "根据作文要求,建议使用记叙文提示词"
}
```

#### 4.3.3 步骤3: 作文评分
```
POST /api/scores/create
Request: {
  "evaluation_id": 200,
  "score_prompt_id": 60,
  "user_phone": "13800138000",
  "confirmed_genre_id": 1,
  "confirmed_grade_id": 5
}
Response: {
  "success": true,
  "score_id": 300,
  "score_data": {
    "total_score": 75,
    "dimensions": {
      "中心立意": {"score": 15, "max_score": 20},
      "语言表达": {"score": 18, "max_score": 25},
      ...
    }
  }
}
```

---

### 4.4 历史记录接口

#### 4.4.1 获取作文的所有评价记录
```
GET /api/essays/100/evaluations
Response: {
  "evaluations": [
    {
      "evaluation_id": 200,
      "user_phone": "13800138000",
      "created_at": "2025-12-18T10:00:00",
      "is_latest": true,
      "genre_name": "记叙文",
      "grade_name": "小学五年级",
      "analyze_prompt_version": "v1.0"
    }
  ]
}
```

#### 4.4.2 获取某次评价的所有评分记录
```
GET /api/evaluations/200/scores
Response: {
  "scores": [
    {
      "score_id": 300,
      "user_phone": "system",
      "score_type": "ai",
      "total_score": 75,
      "is_default": true,
      "created_at": "2025-12-18T10:05:00",
      "score_prompt_version": "v2.0"
    },
    {
      "score_id": 301,
      "user_phone": "13900139000",
      "score_type": "user",
      "total_score": 78,
      "created_at": "2025-12-18T11:00:00"
    }
  ]
}
```

#### 4.4.3 获取评价和评分详情
```
GET /api/evaluations/200/detail
Response: {
  "evaluation": {
    "id": 200,
    "user_phone": "13800138000",
    "evaluation_result": {...},
    "created_at": "2025-12-18T10:00:00"
  },
  "scores": [...]
}
```

---

### 4.5 用户反馈接口

#### 4.5.1 提交评分对比反馈
```
POST /api/feedbacks/comparison
Request: {
  "evaluation_id": 200,
  "score_id": 300,
  "user_phone": "13800138000",
  "preferred_score": "ai"
}
Response: {
  "success": true,
  "feedback_id": 400
}
```

#### 4.5.2 提交自定义评分
```
POST /api/feedbacks/custom-score
Request: {
  "evaluation_id": 200,
  "user_phone": "13800138000",
  "custom_scores": {
    "中心立意": 16,
    "语言表达": 20,
    "篇章结构": 12,
    "文章选材": 11,
    "内容情感": 19
  }
}
Response: {
  "success": true,
  "feedback_id": 401,
  "total_score": 78
}
```

#### 4.5.3 提交文字点评
```
POST /api/feedbacks/comment
Request: {
  "evaluation_id": 200,
  "user_phone": "13800138000",
  "comment_text": "评价整体准确,但语病标注有误..."
}
Response: {
  "success": true,
  "feedback_id": 402
}
```

#### 4.5.4 标注问题
```
POST /api/feedbacks/mark-issue
Request: {
  "evaluation_id": 200,
  "user_phone": "13800138000",
  "marked_issues": [
    {
      "type": "错别字",
      "position": "第2段第3句",
      "reason": "这不是错别字,是方言用法"
    }
  ]
}
Response: {
  "success": true,
  "feedback_id": 403
}
```

---

## 五、前端界面调整

### 5.1 新增页面

#### 5.1.1 登录页面(login.html)
- 输入框: 手机号输入(11位数字)
- 按钮: 登录按钮
- 校验: 前端校验手机号格式
- 跳转: 登录成功后跳转到主页面

#### 5.1.2 提示词管理页面(prompts-management.html)
- 年级选择器
- 文体选择器
- 提示词类型切换(评价/评分)
- 提示词列表(显示所有版本)
- 新增提示词按钮
- 设置默认提示词功能
- 删除提示词功能

---

### 5.2 修改现有页面

#### 5.2.1 AI评分页面(ai-scoring.html)

**新增元素**:
1. **文体判断区域**:
   - AI判断结果展示(文体名称+置信度)
   - 年级判断结果展示
   - 文体确认/修改下拉框
   - 年级确认/修改下拉框
   - 确认按钮

2. **提示词选择区域**:
   - 评价提示词选择器(根据年级+文体筛选)
   - 评分提示词选择器(根据年级+文体筛选)
   - 显示当前选中的提示词版本

3. **历史记录区域**:
   - 评价历史列表
   - 评分历史列表(点击评价后展开)
   - 每条记录显示: 时间、操作人、使用的提示词

4. **用户反馈区域**:
   - 评分对比按钮(AI评分 vs 原始评分)
   - 自定义评分输入框(5个维度)
   - 文字点评文本框
   - 问题标注功能

**修改流程**:
```
原流程: 评价 → 评分
新流程: 评价 → 文体判断(用户确认) → 评分
```

#### 5.2.2 主页面(index.html)

**新增元素**:
- 顶部导航栏显示当前登录用户(手机号)
- 退出登录按钮

---

## 六、数据迁移方案

### 6.1 迁移脚本设计

#### 6.1.1 迁移范围
- essays_data.json → essays表
- analyze_prompts.json → prompts表(type='analyze')
- score_prompts.json → prompts表(type='score')
- essays_require.json → essay_requirements表

#### 6.1.2 迁移步骤
```python
# migrate.py
1. 读取JSON文件
2. 解析数据结构
3. 转换数据格式(JSON → MySQL格式)
4. 批量插入数据库
5. 数据验证(对比迁移前后数量)
6. 生成迁移报告
```

#### 6.1.3 数据映射规则

**提示词迁移**:
- 从version字段提取年级和文体信息
- 默认年级: "通用"
- 默认文体: 从提示词内容分析判断
- 保留原有is_default标记

**作文数据迁移**:
- 保留所有原始字段
- 添加创建时间(使用迁移时间)
- original_score_data字段直接存储JSON

#### 6.1.4 迁移验证
- 记录总数对比
- 关键字段检查
- JSON数据完整性验证
- 提示词内容校验

---

## 七、实施计划

### 7.1 开发阶段

#### 阶段1: 数据库设计与迁移(3天)
- [ ] 创建数据库配置文件
- [ ] 编写数据库初始化脚本(建表+初始数据)
- [ ] 编写数据迁移脚本
- [ ] 执行迁移并验证

#### 阶段2: 后端API开发(5天)
- [ ] 用户登录接口
- [ ] 提示词管理接口(CRUD)
- [ ] 文体判断接口
- [ ] 评价评分接口(重构)
- [ ] 历史记录接口
- [ ] 用户反馈接口

#### 阶段3: 前端界面开发(5天)
- [ ] 登录页面
- [ ] 提示词管理页面
- [ ] AI评分页面重构(增加文体判断步骤)
- [ ] 历史记录展示功能
- [ ] 用户反馈功能界面

#### 阶段4: 集成测试(2天)
- [ ] 完整流程测试
- [ ] 多用户并发测试
- [ ] 数据一致性测试
- [ ] 边界条件测试

#### 阶段5: 优化与部署(2天)
- [ ] 性能优化
- [ ] 代码审查
- [ ] 文档编写
- [ ] 部署上线

---

## 八、关键技术点

### 8.1 数据库连接池
```python
# 使用SQLAlchemy + PyMySQL
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine(
    f"mysql+pymysql://{user}:{password}@{host}:{port}/{database}",
    pool_size=10,
    max_overflow=20,
    pool_recycle=3600
)
SessionLocal = sessionmaker(bind=engine)
```

### 8.2 年级文体提取
```python
# 从作文要求中提取年级
import re

def extract_grade(requirement_text):
    # 匹配: 五年级、初二、高一等
    patterns = [
        r'[一二三四五六]年级',
        r'初[一二三]',
        r'高[一二三]'
    ]
    # 返回匹配的年级ID
```

### 8.3 文体AI判断
```python
def detect_genre(essay_requirement, essay_content):
    prompt = f"""
    根据以下作文要求和学生作文,判断文体类型。

    作文要求:
    {essay_requirement}

    学生作文:
    {essay_content[:500]}

    请输出JSON格式:
    {{
      "genre": "记叙文|议论文|说明文|应用文|其他",
      "confidence": 0.92,
      "reason": "判断依据"
    }}
    """
    # 调用OpenAI API
    # 返回判断结果
```

### 8.4 评价评分关联
```python
# 创建评分时关联评价
def create_score(evaluation_id, score_prompt_id, user_phone):
    # 1. 获取评价结果
    evaluation = db.query(Evaluation).get(evaluation_id)

    # 2. 调用AI评分(基于评价结果)
    score_result = call_ai_score(
        evaluation.evaluation_result,
        score_prompt_content
    )

    # 3. 保存评分记录
    score = Score(
        evaluation_id=evaluation_id,
        user_phone=user_phone,
        score_prompt_id=score_prompt_id,
        total_score=score_result['total_score'],
        dimension_scores=score_result['dimensions']
    )
    db.add(score)
    db.commit()
```

---

## 九、风险点与注意事项

### 9.1 数据迁移风险
- **风险**: JSON数据结构不一致导致迁移失败
- **应对**: 迁移前数据格式校验,异常数据记录到日志

### 9.2 AI判断准确性
- **风险**: 文体判断错误率较高
- **应对**: 提供用户确认/修改机制,不完全依赖AI判断

### 9.3 多用户并发
- **风险**: 同一作文多用户同时评价评分时的数据一致性
- **应对**: 使用数据库事务,is_latest字段控制

### 9.4 提示词版本管理
- **风险**: 提示词过多导致选择困难
- **应对**:
  - 合理设置默认提示词
  - 提供版本说明和创建时间
  - 支持提示词搜索和筛选

### 9.5 性能优化
- **风险**: 历史记录查询慢
- **应对**:
  - 添加合理的数据库索引
  - 分页查询
  - 缓存常用数据(年级/文体列表)

---

## 十、后续优化方向

### 10.1 短期优化(1-2个月)
1. 评分趋势分析(同一作文多次评分的分数变化)
2. 提示词效果统计(哪个提示词评分更合理)
3. 用户反馈统计分析
4. 错别字/语病智能纠正建议

### 10.2 中期优化(3-6个月)
1. 作文对比功能(对比多篇作文)
2. 评分报告导出(PDF/Word)
3. 批量评分功能
4. 评分模板管理

### 10.3 长期规划(6个月以上)
1. 机器学习模型优化(基于用户反馈训练模型)
2. 多维度数据分析看板
3. 移动端支持
4. 多角色权限管理(教师/学生/管理员)

---

## 十一、附录

### 11.1 配置文件示例

#### config.json
```json
{
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "your_password",
    "database": "essay_scoring",
    "charset": "utf8mb4"
  },
  "openai": {
    "base_url": "https://api.chatanywhere.tech/v1",
    "api_key": "your_api_key",
    "model": "gpt-4"
  },
  "system": {
    "page_size": 20,
    "max_history": 100,
    "session_timeout": 3600
  }
}
```

### 11.2 迁移脚本示例

```python
# migrate_data.py
import json
from sqlalchemy.orm import Session
from models import Essay, Prompt, Grade, Genre

def migrate_prompts(db: Session):
    with open('score_prompts.json', 'r', encoding='utf-8') as f:
        data = json.load(f)

    for prompt_data in data['prompts']:
        # 提取年级和文体(默认通用)
        grade = db.query(Grade).filter_by(grade_name='通用').first()
        genre = db.query(Genre).filter_by(genre_code='narrative').first()

        prompt = Prompt(
            grade_id=grade.id,
            genre_id=genre.id,
            prompt_type='score',
            version_name=prompt_data['version'],
            prompt_content=prompt_data['prompt'],
            is_default=prompt_data.get('is_default', False)
        )
        db.add(prompt)

    db.commit()
    print(f"迁移了 {len(data['prompts'])} 条提示词数据")

if __name__ == '__main__':
    # 执行迁移
    migrate_prompts(db_session)
```

---

## 十二、总结

本次重构涉及:
- **数据存储**: JSON → MySQL(9张表)
- **功能增强**: 提示词分层管理、文体判断、多用户评分、用户反馈
- **流程优化**: 评价 → 文体判断 → 评分(三步流程)
- **用户体验**: 历史记录、评分对比、自定义评分

预计开发周期: **17个工作日**

关键成功因素:
1. 数据库设计合理,索引优化到位
2. 数据迁移脚本稳定可靠
3. AI判断准确性+用户确认机制
4. 前后端联调充分测试

---

**文档版本**: v1.0
**编写日期**: 2025-12-18
**最后更新**: 2025-12-18
