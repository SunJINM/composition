<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‡ªåŠ¨è¯„åˆ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5em;
        }

        .back-btn {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .student-info {
            padding: 20px 30px;
            background: #fff9e6;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info h2 {
            color: #764ba2;
            font-size: 1.5em;
        }

        /* ä½œæ–‡å±•ç¤ºåŒºåŸŸ - æ¨ªå‘å¸ƒå±€ */
        .essay-display {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px 20px 0;
            align-items: stretch;
        }

        .essay-content-section,
        .essay-requirement-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .essay-content-section h3,
        .essay-requirement-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .essay-requirement-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .essay-requirement-section .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .essay-requirement-section .form-group textarea {
            flex: 1;
            min-height: 0;
            resize: none;
        }

        /* åˆ†æå’Œè¯„åˆ†åŒºåŸŸ - ç«–å‘å·¦å³åˆ†æ  */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .text-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 300px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .version-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .version-control label {
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }

        .version-control select {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        .version-control button {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .version-control button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .score-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .score-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .score-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .scores-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .score-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .score-column {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .score-column h4 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1em;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .score-column.original h4 {
            color: #ff9800;
        }

        .score-column.ai h4 {
            color: #4caf50;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .score-item.total {
            background: #fff9e6;
            border-left-color: #ff9800;
            font-weight: bold;
            font-size: 1.05em;
        }

        .score-item.ai-total {
            background: #e8f5e9;
            border-left-color: #4caf50;
            font-weight: bold;
            font-size: 1.05em;
        }

        .score-label {
            color: #333;
            font-size: 14px;
        }

        .score-value {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        .score-item.total .score-value {
            color: #ff9800;
        }

        .score-item.ai-total .score-value {
            color: #4caf50;
        }

        .empty-result {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 15px;
        }

        .empty-result .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .pagination {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .pagination button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination .page-info {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #667eea;
            min-width: 150px;
            text-align: center;
        }

        .pagination .jump-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination .jump-input {
            width: 80px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .pagination .jump-btn {
            min-width: 80px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .analysis-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .analysis-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-title {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-badge {
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .analysis-list {
            list-style: none;
            padding-left: 0;
        }

        .analysis-list li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: 14px;
        }

        .error-item {
            border-left-color: #f44336;
        }

        .highlight-item {
            border-left-color: #4caf50;
        }

        .suggestion-item {
            border-left-color: #ff9800;
        }

        .overall-quality {
            display: inline-block;
            padding: 6px 16px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        @media (max-width: 1400px) {
            .essay-display {
                grid-template-columns: 1fr;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .score-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIè‡ªåŠ¨è¯„åˆ†</h1>
            <button class="back-btn" onclick="goBack()">â† è¿”å›ä¸»é¡µ</button>
        </div>

        <div class="student-info" id="studentInfo">
            <h2 id="studentName">å­¦ç”Ÿå§“å</h2>
            <span id="directoryName" style="color: #666;"></span>
        </div>

        <!-- ä½œæ–‡å±•ç¤ºåŒºåŸŸ(æ¨ªå‘å¸ƒå±€) -->
        <div class="essay-display">
            <!-- ä½œæ–‡å†…å®¹ (2/3å®½åº¦) -->
            <div class="section essay-content-section">
                <h3>ğŸ“– ä½œæ–‡å†…å®¹ <span id="wordCount" style="color: #ff9800; font-size: 0.9em; font-weight: normal;"></span></h3>
                <div class="text-content" id="essayContent"></div>
            </div>

            <!-- ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚ (1/3å®½åº¦) -->
            <div class="section essay-requirement-section">
                <h3>ğŸ“ ä½œæ–‡é¢˜ç›®ä¸è¦æ±‚</h3>
                <div class="form-group">
                    <label>ä½œæ–‡é¢˜ç›®ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="essayTitle" placeholder="è¾“å…¥ä½œæ–‡é¢˜ç›®ï¼ˆå¯é€‰ï¼‰&#10;ä¾‹å¦‚ï¼šç§‹å¤©çš„æ•…äº‹"></textarea>
                </div>
                <div class="form-group">
                    <label>ä½œæ–‡è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="essayRequirement" placeholder="è¾“å…¥ä½œæ–‡è¦æ±‚ï¼ˆå¯é€‰ï¼‰&#10;ä¾‹å¦‚ï¼š&#10;1. æ–‡ä½“è‡ªé€‰ï¼ˆè¯—æ­Œé™¤å¤–ï¼‰ï¼Œä¸å°‘äº500å­—&#10;2. æ–‡ä¸­ä¸å¾—å‡ºç°çœŸå®çš„äººåã€æ ¡åã€åœ°å&#10;3. å·é¢æ¸…æ¥šï¼Œå­—è¿¹æ¸…æ™°"></textarea>
                </div>
            </div>
        </div>

        <!-- åˆ†æå’Œè¯„åˆ†åŒºåŸŸ(ç«–å‘å·¦å³åˆ†æ ) -->
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šåˆ†æåŒºåŸŸ -->
            <div class="left-column">
                <!-- åˆ†ææç¤ºè¯ç®¡ç† -->
                <div class="section">
                    <h3>ğŸ” åˆ†ææç¤ºè¯</h3>
                    <div class="version-control">
                        <label>ç‰ˆæœ¬é€‰æ‹©:</label>
                        <select id="analyzePromptSelect" onchange="onAnalyzeVersionChange()">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <button onclick="saveAnalyzeVersion()">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="setAnalyzeDefault()">â­ è®¾ä¸ºé»˜è®¤</button>
                    </div>
                    <div class="form-group">
                        <textarea id="analyzePromptContent" placeholder="åˆ†ææç¤ºè¯å†…å®¹"></textarea>
                    </div>
                    <button class="score-btn" id="analyzeBtn" onclick="performAnalysis()">
                        ğŸ” ç¬¬ä¸€æ­¥:åˆ†æä½œæ–‡
                    </button>
                </div>

                <!-- ä½œæ–‡åˆ†æç»“æœ -->
                <div class="section" id="analysisSection" style="display: none;">
                    <h3>ğŸ“‹ ä½œæ–‡åˆ†æç»“æœ</h3>
                    <div class="analysis-content" id="analysisContent">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯„åˆ†åŒºåŸŸ -->
            <div class="right-column">
                <!-- è¯„åˆ†æç¤ºè¯ç®¡ç† -->
                <div class="section">
                    <h3>ğŸ¯ è¯„åˆ†æç¤ºè¯</h3>
                    <div class="version-control">
                        <label>ç‰ˆæœ¬é€‰æ‹©:</label>
                        <select id="scorePromptSelect" onchange="onScoreVersionChange()">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <button onclick="saveScoreVersion()">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="setScoreDefault()">â­ è®¾ä¸ºé»˜è®¤</button>
                    </div>
                    <div class="form-group">
                        <textarea id="scorePromptContent" placeholder="è¯„åˆ†æç¤ºè¯å†…å®¹"></textarea>
                    </div>
                    <button class="score-btn" id="scoreBtn" onclick="performScoring()" disabled>
                        ğŸ¯ ç¬¬äºŒæ­¥:AIè¯„åˆ†
                    </button>
                </div>

                <!-- è¯„åˆ†ç»“æœå¯¹æ¯” -->
                <div class="section">
                    <h3>ğŸ“Š è¯„åˆ†ç»“æœå¯¹æ¯”</h3>
                    <div class="scores-section">
                        <div class="score-comparison">
                            <!-- åŸå§‹è¯„åˆ† -->
                            <div class="score-column original">
                                <h4>ğŸ“‹ åŸå§‹è¯„åˆ†</h4>
                                <div id="originalScores">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <!-- AIè¯„åˆ† -->
                            <div class="score-column ai">
                                <h4>ğŸ¤– AIè¯„åˆ†</h4>
                                <div id="aiScores">
                                    <div class="empty-result">
                                        <div class="icon">ğŸ¯</div>
                                        <div>å®Œæˆåˆ†æå<br>ç‚¹å‡»è¯„åˆ†æŒ‰é’®</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div class="pagination">
            <button id="prevBtn" onclick="previousEssay()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <div class="page-info">
                <span id="pageInfo">0 / 0</span>
            </div>
            <button id="nextBtn" onclick="nextEssay()">ä¸‹ä¸€é¡µ â¡ï¸</button>
            <div class="jump-group">
                <label>è·³è½¬åˆ°:</label>
                <input type="number" class="jump-input" id="jumpInput" min="1" placeholder="é¡µç ">
                <button class="jump-btn" onclick="jumpToPage()">è·³è½¬</button>
            </div>
        </div>
    </div>

    <div class="message" id="message"></div>

    <script>
        const API_BASE = 'http://localhost:8008/api';
        // const API_BASE = 'http://192.168.3.88:8008/api';
        let essaysData = [];
        let currentIndex = -1;
        let analyzePromptsData = [];  // åˆ†ææç¤ºè¯
        let scorePromptsData = [];     // è¯„åˆ†æç¤ºè¯
        let essaysRequireData = [];    // ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚æ•°æ®
        let selectedAnalyzeVersion = null;
        let selectedScoreVersion = null;
        let currentAnalysis = null;  // å­˜å‚¨å½“å‰ä½œæ–‡çš„åˆ†æç»“æœ

        // ä»URLè·å–ä½œæ–‡ç´¢å¼•
        function getEssayIndexFromURL() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('index')) || 0;
        }

        // æ›´æ–°URLä¸­çš„ç´¢å¼•
        function updateURL() {
            const newURL = `${window.location.pathname}?index=${currentIndex}`;
            window.history.pushState({}, '', newURL);
        }

        // åŠ è½½æ‰€æœ‰ä½œæ–‡æ•°æ®
        async function loadAllEssays() {
            try {
                const response = await fetch(`${API_BASE}/essays`);
                const data = await response.json();
                essaysData = data.essays;

                // ä»URLè·å–åˆå§‹ç´¢å¼•
                currentIndex = getEssayIndexFromURL();
                if (currentIndex >= essaysData.length) {
                    currentIndex = 0;
                }

                // åŠ è½½å½“å‰ä½œæ–‡
                loadCurrentEssay();
                updatePagination();

            } catch (error) {
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½å½“å‰ä½œæ–‡
        // æ£€æµ‹è¯„åˆ†åˆ†åˆ¶(æ ¹æ®åŸå§‹è¯„åˆ†åˆ¤æ–­)
        function detectScoreScale(scoreData) {
            // æ£€æŸ¥æ‰€æœ‰ç»´åº¦çš„æœ€å¤§åˆ†å€¼
            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                if (dimData.max_score < 10) {
                    return '10'; // 10åˆ†åˆ¶
                }
            }
            return '40'; // 40åˆ†åˆ¶(é»˜è®¤)
        }

        // è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¯„åˆ†æç¤ºè¯
        function autoSelectScorePrompt(scale) {
            if (!scorePromptsData || scorePromptsData.length === 0) {
                return;
            }

            // æŸ¥æ‰¾åŒ…å«å¯¹åº”åˆ†åˆ¶çš„æç¤ºè¯ç‰ˆæœ¬
            const appropriatePrompts = scorePromptsData.filter(p =>
                p.version.includes(scale + 'åˆ†åˆ¶')
            );

            if (appropriatePrompts.length > 0) {
                // ä¼˜å…ˆé€‰æ‹©é»˜è®¤ç‰ˆæœ¬,å¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
                const selectedPrompt = appropriatePrompts.find(p => p.is_default) || appropriatePrompts[0];
                document.getElementById('scorePromptSelect').value = selectedPrompt.version;
                onScoreVersionChange();
                console.log(`è‡ªåŠ¨é€‰æ‹© ${scale}åˆ†åˆ¶ æç¤ºè¯: ${selectedPrompt.version}`);
            }
        }

        function loadCurrentEssay() {
            if (currentIndex < 0 || currentIndex >= essaysData.length) {
                return;
            }

            const essay = essaysData[currentIndex];

            // æ˜¾ç¤ºå­¦ç”Ÿä¿¡æ¯
            document.getElementById('studentName').textContent = `å­¦ç”Ÿ: ${essay.student_name}`;
            document.getElementById('directoryName').textContent = essay.directory_name;

            // æ˜¾ç¤ºä½œæ–‡å†…å®¹
            document.getElementById('essayContent').textContent = essay.essay_content;

            // ç»Ÿè®¡å¹¶æ˜¾ç¤ºå­—æ•°
            const wordCount = essay.essay_content.replace(/\s/g, '').length;
            document.getElementById('wordCount').textContent = `(å…± ${wordCount} å­—)`;

            // æ˜¾ç¤ºåŸå§‹è¯„åˆ†
            displayOriginalScores(essay.score_data);

            // è‡ªåŠ¨æ£€æµ‹å¹¶é€‰æ‹©åˆé€‚çš„è¯„åˆ†æç¤ºè¯
            const scale = detectScoreScale(essay.score_data);
            autoSelectScorePrompt(scale);

            // æ ¹æ®directory_nameè‡ªåŠ¨å¡«å……ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚
            loadEssayRequire(essay.directory_name);

            // æ¸…ç©ºAIè¯„åˆ†ç»“æœ
            resetAIScores();

            // æ›´æ–°URL
            updateURL();
        }

        // æ ¹æ®directory_nameåŠ è½½ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚
        function loadEssayRequire(directoryName) {
            // åœ¨essaysRequireDataä¸­æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®
            const requireData = essaysRequireData.find(item => item.directory_name === directoryName);

            if (requireData) {
                // è‡ªåŠ¨å¡«å……ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚
                document.getElementById('essayTitle').value = requireData.essay_title || '';
                document.getElementById('essayRequirement').value = requireData.essay_requirement || '';
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°,æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('essayTitle').value = '';
                document.getElementById('essayRequirement').value = '';
            }
        }

        // æ˜¾ç¤ºåŸå§‹è¯„åˆ†
        function displayOriginalScores(scoreData) {
            const container = document.getElementById('originalScores');
            let html = `
                <div class="score-item total">
                    <span class="score-label">æ€»åˆ†</span>
                    <span class="score-value">${scoreData.total_score}</span>
                </div>
            `;

            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                html += `
                    <div class="score-item">
                        <span class="score-label">${dimName}</span>
                        <span class="score-value">${dimData.score} / ${dimData.max_score}</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // é‡ç½®AIè¯„åˆ†åŒºåŸŸ
        function resetAIScores() {
            document.getElementById('aiScores').innerHTML = `
                <div class="empty-result">
                    <div class="icon">ğŸ¯</div>
                    <div>ç‚¹å‡»"ç¬¬äºŒæ­¥:AIè¯„åˆ†"æŒ‰é’®<br>è·å–AIè¯„åˆ†ç»“æœ</div>
                </div>
            `;
            // éšè—åˆ†æç»“æœ
            document.getElementById('analysisSection').style.display = 'none';
            currentAnalysis = null;
            // ç¦ç”¨è¯„åˆ†æŒ‰é’®
            document.getElementById('scoreBtn').disabled = true;
        }

        // ä¸Šä¸€é¡µ
        function previousEssay() {
            if (currentIndex > 0) {
                currentIndex--;
                loadCurrentEssay();
                updatePagination();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextEssay() {
            if (currentIndex < essaysData.length - 1) {
                currentIndex++;
                loadCurrentEssay();
                updatePagination();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function jumpToPage() {
            const input = document.getElementById('jumpInput');
            const pageNum = parseInt(input.value);

            if (isNaN(pageNum)) {
                showMessage('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ', 'error');
                return;
            }

            if (pageNum < 1 || pageNum > essaysData.length) {
                showMessage(`âš ï¸ é¡µç èŒƒå›´: 1-${essaysData.length}`, 'error');
                return;
            }

            currentIndex = pageNum - 1;
            loadCurrentEssay();
            updatePagination();
            input.value = '';
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            if (essaysData.length === 0) return;

            document.getElementById('pageInfo').textContent = `${currentIndex + 1} / ${essaysData.length}`;
            document.getElementById('prevBtn').disabled = currentIndex <= 0;
            document.getElementById('nextBtn').disabled = currentIndex >= essaysData.length - 1;
        }

        // æ”¯æŒå›è½¦é”®è·³è½¬
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jumpInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });
        });

        // åŠ è½½æç¤ºè¯åˆ—è¡¨
        async function loadPrompts() {
            try {
                // åŠ è½½åˆ†ææç¤ºè¯
                const analyzeResponse = await fetch(`${API_BASE}/prompts?type=analyze`);
                const analyzeData = await analyzeResponse.json();
                analyzePromptsData = analyzeData.prompts;

                // åŠ è½½è¯„åˆ†æç¤ºè¯
                const scoreResponse = await fetch(`${API_BASE}/prompts?type=score`);
                const scoreData = await scoreResponse.json();
                scorePromptsData = scoreData.prompts;

                // å¡«å……åˆ†ææç¤ºè¯é€‰æ‹©å™¨
                const analyzeSelect = document.getElementById('analyzePromptSelect');
                analyzeSelect.innerHTML = analyzePromptsData.map(p => {
                    const label = p.version + (p.is_default ? ' (é»˜è®¤)' : '');
                    return `<option value="${p.version}">${label}</option>`;
                }).join('');

                // é€‰æ‹©é»˜è®¤åˆ†æç‰ˆæœ¬
                if (analyzePromptsData.length > 0) {
                    const defaultAnalyze = analyzePromptsData.find(p => p.is_default) || analyzePromptsData[0];
                    analyzeSelect.value = defaultAnalyze.version;
                    onAnalyzeVersionChange();
                }

                // å¡«å……è¯„åˆ†æç¤ºè¯é€‰æ‹©å™¨
                const scoreSelect = document.getElementById('scorePromptSelect');
                scoreSelect.innerHTML = scorePromptsData.map(p => {
                    const label = p.version + (p.is_default ? ' (é»˜è®¤)' : '');
                    return `<option value="${p.version}">${label}</option>`;
                }).join('');

                // é€‰æ‹©é»˜è®¤è¯„åˆ†ç‰ˆæœ¬
                if (scorePromptsData.length > 0) {
                    const defaultScore = scorePromptsData.find(p => p.is_default) || scorePromptsData[0];
                    scoreSelect.value = defaultScore.version;
                    onScoreVersionChange();
                }

            } catch (error) {
                console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', error);
            }
        }

        // åˆ†ææç¤ºè¯ç‰ˆæœ¬å˜æ›´
        function onAnalyzeVersionChange() {
            const version = document.getElementById('analyzePromptSelect').value;
            const prompt = analyzePromptsData.find(p => p.version === version);
            if (prompt) {
                selectedAnalyzeVersion = version;
                document.getElementById('analyzePromptContent').value = prompt.prompt;
            }
        }

        // è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬å˜æ›´
        function onScoreVersionChange() {
            const version = document.getElementById('scorePromptSelect').value;
            const prompt = scorePromptsData.find(p => p.version === version);
            if (prompt) {
                selectedScoreVersion = version;
                document.getElementById('scorePromptContent').value = prompt.prompt;
            }
        }

        // ä¿å­˜åˆ†ææç¤ºè¯ç‰ˆæœ¬
        async function saveAnalyzeVersion() {
            const content = document.getElementById('analyzePromptContent').value.trim();
            if (!content) {
                showMessage('âš ï¸ è¯·è¾“å…¥åˆ†ææç¤ºè¯å†…å®¹', 'error');
                return;
            }

            const versionName = prompt('è¯·è¾“å…¥åˆ†ææç¤ºè¯ç‰ˆæœ¬åç§°:');
            if (!versionName) return;

            try {
                const response = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: content,
                        version_name: versionName,
                        type: 'analyze'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('âœ… åˆ†ææç¤ºè¯ä¿å­˜æˆåŠŸ!', 'success');
                    await loadPrompts();
                    document.getElementById('analyzePromptSelect').value = result.prompt.version;
                    onAnalyzeVersionChange();
                } else {
                    const error = await response.json();
                    showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®åˆ†ææç¤ºè¯ä¸ºé»˜è®¤
        async function setAnalyzeDefault() {
            const version = document.getElementById('analyzePromptSelect').value;
            if (!version) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${encodeURIComponent(version)}/default?type=analyze`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showMessage('âœ… å·²è®¾ç½®ä¸ºé»˜è®¤åˆ†ææç¤ºè¯', 'success');
                    await loadPrompts();
                } else {
                    const error = await response.json();
                    showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬
        async function saveScoreVersion() {
            const content = document.getElementById('scorePromptContent').value.trim();
            if (!content) {
                showMessage('âš ï¸ è¯·è¾“å…¥è¯„åˆ†æç¤ºè¯å†…å®¹', 'error');
                return;
            }

            const versionName = prompt('è¯·è¾“å…¥è¯„åˆ†æç¤ºè¯ç‰ˆæœ¬åç§°:');
            if (!versionName) return;

            try {
                const response = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: content,
                        version_name: versionName,
                        type: 'score'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('âœ… è¯„åˆ†æç¤ºè¯ä¿å­˜æˆåŠŸ!', 'success');
                    await loadPrompts();
                    document.getElementById('scorePromptSelect').value = result.prompt.version;
                    onScoreVersionChange();
                } else {
                    const error = await response.json();
                    showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®è¯„åˆ†æç¤ºè¯ä¸ºé»˜è®¤
        async function setScoreDefault() {
            const version = document.getElementById('scorePromptSelect').value;
            if (!version) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯ç‰ˆæœ¬', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${encodeURIComponent(version)}/default?type=score`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showMessage('âœ… å·²è®¾ç½®ä¸ºé»˜è®¤è¯„åˆ†æç¤ºè¯', 'success');
                    await loadPrompts();
                } else {
                    const error = await response.json();
                    showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('âŒ è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡Œä½œæ–‡åˆ†æ(ç¬¬ä¸€æ­¥)
        async function performAnalysis() {
            if (currentIndex < 0 || currentIndex >= essaysData.length) {
                showMessage('âš ï¸ æ•°æ®æœªåŠ è½½', 'error');
                return;
            }

            const essay = essaysData[currentIndex];
            const title = document.getElementById('essayTitle').value.trim();
            const requirement = document.getElementById('essayRequirement').value.trim();

            // ä½¿ç”¨åˆ†ææç¤ºè¯è¾“å…¥æ¡†çš„å†…å®¹
            const promptContent = document.getElementById('analyzePromptContent').value.trim();
            if (!promptContent) {
                showMessage('âš ï¸ è¯·è¾“å…¥åˆ†ææç¤ºè¯', 'error');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> AIåˆ†æä¸­...';

            try {
                const response = await fetch(`${API_BASE}/ai-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        essay_content: essay.essay_content,
                        essay_title: title,
                        essay_requirement: requirement,
                        prompt: promptContent
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentAnalysis = result.analysis;
                    displayAnalysis(result.analysis);
                    // å¯ç”¨è¯„åˆ†æŒ‰é’®
                    document.getElementById('scoreBtn').disabled = false;
                    showMessage('âœ… ä½œæ–‡åˆ†æå®Œæˆ! ç°åœ¨å¯ä»¥è¿›è¡Œè¯„åˆ†äº†', 'success');
                } else {
                    showMessage('âŒ AIåˆ†æå¤±è´¥: ' + result.error, 'error');
                    console.error('AIè¿”å›:', result.raw_response);
                }
            } catch (error) {
                showMessage('âŒ AIåˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysis(analysis) {
            const section = document.getElementById('analysisSection');
            const container = document.getElementById('analysisContent');

            let html = '';

            // ç»¼åˆè¯„ä»·
            if (analysis.ç»¼åˆè¯„ä»·) {
                const overall = analysis.ç»¼åˆè¯„ä»·;
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ“Š ç»¼åˆè¯„ä»·
                            <span class="overall-quality">${overall.æ•´ä½“è´¨é‡ || ''}</span>
                        </div>
                        ${overall.æ€»è¯„ ? `<p style="line-height: 1.8; margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">${overall.æ€»è¯„}</p>` : ''}
                        <p style="margin-bottom: 8px;"><strong>ä¸»è¦ä¼˜ç‚¹:</strong></p>
                        <ul class="analysis-list">
                            ${(overall.ä¸»è¦ä¼˜ç‚¹ || []).map(item => `<li class="highlight-item">${item}</li>`).join('')}
                        </ul>
                        <p style="margin-bottom: 8px; margin-top: 12px;"><strong>ä¸»è¦é—®é¢˜:</strong></p>
                        <ul class="analysis-list">
                            ${(overall.ä¸»è¦é—®é¢˜ || []).map(item => `<li class="error-item">${item}</li>`).join('')}
                        </ul>
                        <p style="margin-top: 12px;"><strong>æ€»ä½“å»ºè®®:</strong> ${overall.æ€»ä½“å»ºè®® || ''}</p>
                    </div>
                `;
            }

            // ä½œæ–‡è¦æ±‚è¯„ä»·
            if (analysis.ä½œæ–‡è¦æ±‚è¯„ä»· && analysis.ä½œæ–‡è¦æ±‚è¯„ä»·.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ“‹ ä½œæ–‡è¦æ±‚è¯„ä»·
                        </div>
                        ${analysis.ä½œæ–‡è¦æ±‚è¯„ä»·.map(item => `
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-weight: bold; color: #333;">${item.è¦æ±‚}</span>
                                    <span style="color: #667eea; font-weight: bold; font-size: 16px;">${item.è¯„åˆ†} / ${item.æ»¡åˆ†}åˆ†</span>
                                </div>
                                <div style="background: #e0e0e0; height: 6px; border-radius: 3px; margin-bottom: 6px;">
                                    <div style="background: linear-gradient(90deg, #4caf50, #667eea); height: 100%; width: ${(item.è¯„åˆ† / item.æ»¡åˆ†) * 100}%; border-radius: 3px;"></div>
                                </div>
                                <p style="color: #666; font-size: 13px;">${item.è¯„ä»·}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // æ—æ‰¹ç‚¹è¯„
            if (analysis.æ—æ‰¹ç‚¹è¯„) {
                const pangpi = analysis.æ—æ‰¹ç‚¹è¯„;
                let pangpiHtml = '';

                // äº®ç‚¹å¥å­
                if (pangpi.äº®ç‚¹å¥å­ && pangpi.äº®ç‚¹å¥å­.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #ffd700; margin-bottom: 8px;">ğŸŒŸ äº®ç‚¹å¥å­ (${pangpi.äº®ç‚¹å¥å­.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.äº®ç‚¹å¥å­.map(item =>
                                    `<li class="highlight-item">
                                        <span style="color: #666; font-style: italic;">"${item.å†…å®¹}"</span><br>
                                        <span style="color: #4caf50;">${item.è¯„ä»·}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }

                // æ­é…æå‡
                if (pangpi.æ­é…æå‡ && pangpi.æ­é…æå‡.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px;">ğŸ”§ æ­é…æå‡ (${pangpi.æ­é…æå‡.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.æ­é…æå‡.map(item =>
                                    `<li class="suggestion-item">
                                        "${item.åŸæ–‡}" â†’ "${item.å»ºè®®}"<br>
                                        <span style="color: #666; font-size: 13px;">${item.ç†ç”±}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }

                // å­—è¯çº é”™
                if (pangpi.å­—è¯çº é”™ && pangpi.å­—è¯çº é”™.length > 0) {
                    pangpiHtml += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #2196f3; margin-bottom: 8px;">âœï¸ å­—è¯çº é”™ (${pangpi.å­—è¯çº é”™.length}å¤„)</div>
                            <ul class="analysis-list">
                                ${pangpi.å­—è¯çº é”™.map(item =>
                                    `<li class="error-item">
                                        ${item.é—®é¢˜}: åº”æ”¹ä¸º "${item.åº”æ”¹ä¸º}"
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (pangpiHtml) {
                    html += `
                        <div class="analysis-item">
                            <div class="analysis-title">
                                ğŸ“Œ æ—æ‰¹ç‚¹è¯„
                            </div>
                            ${pangpiHtml}
                        </div>
                    `;
                }
            }

            // é”™åˆ«å­—ç»Ÿè®¡
            if (analysis.é”™åˆ«å­—æ€»æ•° !== undefined) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âŒ é”™åˆ«å­—ç»Ÿè®¡
                            <span class="analysis-badge">${analysis.é”™åˆ«å­—æ€»æ•°} ä¸ª</span>
                        </div>
                        <ul class="analysis-list">
                            ${(analysis.é”™åˆ«å­— || []).map(item =>
                                `<li class="error-item">${item.ä½ç½®}: "${item.é”™è¯¯}" â†’ "${item.æ­£ç¡®}"</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            // è¯­ç—…æ ‡æ³¨
            if (analysis.è¯­ç—…æ€»æ•° !== undefined) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âš ï¸ è¯­ç—…æ ‡æ³¨
                            <span class="analysis-badge">${analysis.è¯­ç—…æ€»æ•°} å¤„</span>
                        </div>
                        <ul class="analysis-list">
                            ${(analysis.è¯­ç—… || []).map(item =>
                                `<li class="error-item">
                                    <strong>${item.ä½ç½®}:</strong> ${item.é—®é¢˜æè¿°}<br>
                                    <span style="color: #999;">åŸå¥: ${item.åŸå¥}</span><br>
                                    <span style="color: #4caf50;">å»ºè®®: ${item.ä¿®æ”¹å»ºè®®}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            // ä¼˜ç‚¹äº®ç‚¹
            if (analysis.ä¼˜ç‚¹äº®ç‚¹ && analysis.ä¼˜ç‚¹äº®ç‚¹.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            âœ¨ ä¼˜ç‚¹äº®ç‚¹
                            <span class="analysis-badge">${analysis.ä¼˜ç‚¹äº®ç‚¹.length} å¤„</span>
                        </div>
                        <ul class="analysis-list">
                            ${analysis.ä¼˜ç‚¹äº®ç‚¹.map(item =>
                                `<li class="highlight-item">
                                    <strong>${item.ä½ç½®}:</strong> ${item.è¯„ä»·}<br>
                                    <span style="color: #666; font-style: italic;">"${item.å†…å®¹}"</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            // æ”¹è¿›å»ºè®®
            if (analysis.æ”¹è¿›å»ºè®® && analysis.æ”¹è¿›å»ºè®®.length > 0) {
                html += `
                    <div class="analysis-item">
                        <div class="analysis-title">
                            ğŸ’¡ æ”¹è¿›å»ºè®®
                            <span class="analysis-badge">${analysis.æ”¹è¿›å»ºè®®.length} æ¡</span>
                        </div>
                        <ul class="analysis-list">
                            ${analysis.æ”¹è¿›å»ºè®®.map(item =>
                                `<li class="suggestion-item">
                                    <strong>${item.æ–¹é¢}:</strong> ${item.å…·ä½“å»ºè®®}
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            container.innerHTML = html || '<p style="color: #999; text-align: center;">æš‚æ— åˆ†æç»“æœ</p>';
            section.style.display = 'block';
        }

        // æ‰§è¡ŒAIè¯„åˆ†(ç¬¬äºŒæ­¥)
        async function performScoring() {
            if (currentIndex < 0 || currentIndex >= essaysData.length) {
                showMessage('âš ï¸ æ•°æ®æœªåŠ è½½', 'error');
                return;
            }

            const essay = essaysData[currentIndex];
            const title = document.getElementById('essayTitle').value.trim();
            const requirement = document.getElementById('essayRequirement').value.trim();

            // ä½¿ç”¨è¯„åˆ†æç¤ºè¯è¾“å…¥æ¡†çš„å†…å®¹
            const promptContent = document.getElementById('scorePromptContent').value.trim();

            if (!promptContent) {
                showMessage('âš ï¸ è¯·è¾“å…¥è¯„åˆ†æç¤ºè¯', 'error');
                return;
            }

            const btn = document.getElementById('scoreBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> AIè¯„åˆ†ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/ai-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        essay_content: essay.essay_content,
                        essay_title: title,
                        essay_requirement: requirement,
                        prompt: promptContent,
                        analysis: currentAnalysis,  // ä¼ é€’åˆ†æç»“æœ
                        original_score_data: essay.score_data  // ä¼ é€’åŸå§‹è¯„åˆ†æ•°æ®,ç”¨äºåˆ¤æ–­åˆ†åˆ¶
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayAIScores(result.score_data);
                    showMessage('âœ… AIè¯„åˆ†å®Œæˆ!', 'success');
                } else {
                    showMessage('âŒ AIè¯„åˆ†å¤±è´¥: ' + result.error, 'error');
                    console.error('AIè¿”å›:', result.raw_response);
                }
            } catch (error) {
                showMessage('âŒ AIè¯„åˆ†å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // æ˜¾ç¤ºAIè¯„åˆ†ç»“æœ
        function displayAIScores(scoreData) {
            const container = document.getElementById('aiScores');
            let html = `
                <div class="score-item ai-total">
                    <span class="score-label">æ€»åˆ†</span>
                    <span class="score-value">${scoreData.total_score}</span>
                </div>
            `;

            for (const [dimName, dimData] of Object.entries(scoreData.dimensions)) {
                html += `
                    <div class="score-item">
                        <span class="score-label">${dimName}</span>
                        <span class="score-value">${dimData.score} / ${dimData.max_score}</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = `index.html?index=${currentIndex}`;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.background = type === 'success' ? '#4caf50' : '#f44336';
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // åŠ è½½ä½œæ–‡é¢˜ç›®å’Œè¦æ±‚æ•°æ®
        async function loadEssaysRequire() {
            try {
                const response = await fetch(`${API_BASE}/essays-require`);
                const result = await response.json();
                essaysRequireData = result.data || [];
                console.log('ä½œæ–‡è¦æ±‚æ•°æ®åŠ è½½æˆåŠŸ:', essaysRequireData.length, 'æ¡');
            } catch (error) {
                console.error('åŠ è½½ä½œæ–‡è¦æ±‚æ•°æ®å¤±è´¥:', error);
                essaysRequireData = [];
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadEssaysRequire();  // å…ˆåŠ è½½ä½œæ–‡è¦æ±‚æ•°æ®
            loadAllEssays();
            loadPrompts();
        });
    </script>
</body>
</html>
