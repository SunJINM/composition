<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ–‡åˆ—è¡¨ - ä½œæ–‡è¯„åˆ†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .user-info {
            text-align: right;
        }

        .user-info .phone {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .filters {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        .filter-group select, .filter-group input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            min-width: 200px;
        }

        .filter-group input {
            min-width: 250px;
        }

        .search-btn {
            padding: 10px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .search-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .reset-btn {
            padding: 10px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            background: #5a6268;
        }

        .essay-list {
            padding: 30px;
            min-height: 500px;
        }

        .essay-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border-left: 5px solid #667eea;
        }

        .essay-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .essay-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 20px;
        }

        .essay-title-wrap {
            flex: 1;
        }

        .essay-title {
            font-size: 1.3em;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* ç­”å·å›¾ç‰‡æ ·å¼ */
        .essay-image-container {
            margin-bottom: 10px;
        }

        .essay-thumbnail {
            width: 140px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .essay-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .thumbnail-placeholder {
            width: 140px;
            height: 90px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.9em;
            text-align: center;
            padding: 5px;
        }

        /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .preview-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .close-preview {
            position: absolute;
            top: -20px;
            right: -20px;
            width: 40px;
            height: 40px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        .close-preview:hover {
            background: #d32f2f;
        }

        .essay-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-label {
            color: #666;
            font-size: 0.9em;
        }

        .meta-value {
            color: #333;
            font-weight: bold;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-radius: 20px;
            font-weight: bold;
        }

        .score-system-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #2196f3;
            color: white;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .eval-count {
            color: #ff9800;
            font-weight: bold;
        }

        .enter-btn {
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            white-space: nowrap;
        }

        .enter-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pagination {
            padding: 25px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .page-info {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
            color: #667eea;
            min-width: 200px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
            font-size: 1.3em;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 1.2em;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                text-align: center;
                margin-top: 15px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group select, .filter-group input {
                width: 100%;
                min-width: auto;
            }

            .essay-meta {
                grid-template-columns: 1fr;
            }

            .essay-card-header {
                flex-direction: column;
                gap: 15px;
            }

            /* å“åº”å¼å›¾ç‰‡æ ·å¼ */
            .essay-thumbnail, .thumbnail-placeholder {
                width: 100%;
                height: auto;
                min-height: 120px;
            }

            .close-preview {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“ ä½œæ–‡è¯„åˆ†ç³»ç»Ÿ</h1>
                <p>ä½œæ–‡æ‰¹æ”¹ä¸åˆ†æ•°ç®¡ç†å¹³å°</p>
            </div>
            <div class="user-info">
                <div class="phone">ç”¨æˆ·: <span id="userPhone">æœªç™»å½•</span></div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>ğŸ“š æ‰¹æ¬¡ç­›é€‰:</label>
                <select id="batchFilter">
                    <option value="">å…¨éƒ¨æ‰¹æ¬¡</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ğŸ“ å¹´çº§ç­›é€‰:</label>
                <select id="gradeFilter">
                    <option value="">å…¨éƒ¨å¹´çº§</option>
                    <option value="1">7å¹´çº§</option>
                    <option value="2">8å¹´çº§</option>
                    <option value="3">9å¹´çº§</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ğŸ” å­¦ç”Ÿå§“å:</label>
                <input type="text" id="studentSearch" placeholder="è¾“å…¥å­¦ç”Ÿå§“åæœç´¢">
            </div>
            <button class="search-btn" onclick="searchEssays()">æœç´¢</button>
            <button class="reset-btn" onclick="resetFilters()">é‡ç½®</button>
        </div>

        <div class="essay-list" id="essayList">
            <div class="loading">æ­£åœ¨åŠ è½½ä½œæ–‡åˆ—è¡¨...</div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevBtn" onclick="previousPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <div class="page-info">
                <span id="pageInfo">ç¬¬ 0 é¡µ / å…± 0 é¡µ (å…± 0 ç¯‡)</span>
            </div>
            <button id="nextBtn" onclick="nextPage()">ä¸‹ä¸€é¡µ â¡ï¸</button>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <div class="image-preview-content">
            <button class="close-preview" onclick="closeImagePreview()">Ã—</button>
            <img src="" alt="ä½œæ–‡ç­”å·é¢„è§ˆ" class="preview-image" id="previewImage">
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        const pageSize = 20;
        let totalPages = 0;
        let totalCount = 0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadBatches();
            loadEssays();

            // æ”¯æŒå›è½¦æœç´¢
            document.getElementById('studentSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchEssays();
                }
            });
        });

        // å­—ç¬¦ä¸²æˆªæ–­å·¥å…·å‡½æ•° (æœ€å¤š15ä¸ªå­—)
        function truncateString(str, maxLength = 15) {
            if (!str || str.trim() === '') return 'æ— æ ‡é¢˜';
            str = str.trim();
            return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const phone = localStorage.getItem('userPhone');
                if (phone) {
                    document.getElementById('userPhone').textContent = phone;
                } else {
                    // æœªç™»å½•,è·³è½¬åˆ°ç™»å½•é¡µ
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ‰¹æ¬¡åˆ—è¡¨
        async function loadBatches() {
            try {
                const response = await fetch(`${API_BASE}/batches`);
                const data = await response.json();

                const select = document.getElementById('batchFilter');
                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.id;
                    option.textContent = truncateString(batch.essay_title, 30);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æ‰¹æ¬¡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä½œæ–‡åˆ—è¡¨
        async function loadEssays() {
            try {
                const batchId = document.getElementById('batchFilter').value;
                const gradeId = document.getElementById('gradeFilter').value;
                const studentName = document.getElementById('studentSearch').value.trim();

                let url = `${API_BASE}/essays?page=${currentPage}&page_size=${pageSize}`;
                if (batchId) url += `&batch_id=${batchId}`;
                if (gradeId) url += `&grade_id=${gradeId}`;
                if (studentName) url += `&student_name=${encodeURIComponent(studentName)}`;

                const response = await fetch(url);
                const data = await response.json();

                totalCount = data.total;
                totalPages = data.total_pages;

                renderEssayList(data.essays);
                updatePagination();
            } catch (error) {
                console.error('åŠ è½½ä½œæ–‡åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('essayList').innerHTML = `
                    <div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // æ¸²æŸ“ä½œæ–‡åˆ—è¡¨
        function renderEssayList(essays) {
            const container = document.getElementById('essayList');

            if (essays.length === 0) {
                container.innerHTML = '<div class="empty">æš‚æ— ä½œæ–‡æ•°æ®</div>';
                return;
            }

            let html = '';
            essays.forEach(essay => {
                const evalDate = essay.latest_evaluation_date
                    ? new Date(essay.latest_evaluation_date).toLocaleDateString()
                    : 'æœªè¯„ä»·';
                const truncatedTitle = truncateString(essay.batch_title);
                
                // æ„å»ºå›¾ç‰‡HTML
                let imageHtml = '';
                if (essay.essay_image_path) {
                    imageHtml = `
                        <div class="essay-image-container">
                            <img src="${essay.essay_image_path}" 
                                 alt="${truncatedTitle} - ${essay.student_name}çš„ç­”å·" 
                                 class="essay-thumbnail" 
                                 onclick="openImagePreview('${essay.essay_image_path}')">
                        </div>
                    `;
                } else {
                    imageHtml = `
                        <div class="essay-image-container">
                            <div class="thumbnail-placeholder">æš‚æ— ç­”å·å›¾ç‰‡</div>
                        </div>
                    `;
                }

                html += `
                    <div class="essay-card">
                        <div class="essay-card-header">
                            <div class="essay-title-wrap">
                                <div class="essay-title">ğŸ“„ ${truncatedTitle}</div>
                                ${imageHtml}
                            </div>
                            <button class="enter-btn" onclick="enterScoring(${essay.id})">
                                è¿›å…¥è¯„åˆ† â†’
                            </button>
                        </div>
                        <div class="essay-meta">
                            <div class="meta-item">
                                <span class="meta-label">ğŸ‘¤ å­¦ç”Ÿ:</span>
                                <span class="meta-value">${essay.student_name || 'æœªçŸ¥'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ“ å­—æ•°:</span>
                                <span class="meta-value">${essay.word_count || 0} å­—</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ“ åˆ†åˆ¶:</span>
                                <span class="score-system-badge">${essay.score_system}åˆ†åˆ¶</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ“Š åŸå§‹åˆ†:</span>
                                <span class="score-badge">${essay.original_score || 'æœªè¯„åˆ†'} / ${essay.score_system}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ”„ è¯„ä»·æ¬¡æ•°:</span>
                                <span class="eval-count">${essay.evaluation_count || 0} æ¬¡</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ• æœ€æ–°è¯„ä»·:</span>
                                <span class="meta-value">${evalDate}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (totalPages > 0) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ (å…± ${totalCount} ç¯‡)`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // ä¸Šä¸€é¡µ
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadEssays();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadEssays();
            }
        }

        // æœç´¢
        function searchEssays() {
            currentPage = 1;
            loadEssays();
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('batchFilter').value = '';
            document.getElementById('gradeFilter').value = '';
            document.getElementById('studentSearch').value = '';
            currentPage = 1;
            loadEssays();
        }

        // è¿›å…¥è¯„åˆ†é¡µé¢
        function enterScoring(essayId) {
            window.location.href = `ai-scoring.html?essay_id=${essayId}`;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('userPhone');
            window.location.href = 'login.html';
        }

        // æ‰“å¼€å›¾ç‰‡é¢„è§ˆ
        function openImagePreview(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const previewImg = document.getElementById('previewImage');
            
            // æ¸…ç©ºåŸæœ‰å›¾ç‰‡ï¼Œé¿å…åŠ è½½é—ªçƒ
            previewImg.src = '';
            previewImg.onload = function() {
                modal.style.display = 'flex';
            };
            previewImg.src = imageUrl;
            
            // ç‚¹å‡»ç©ºç™½å¤„å…³é—­
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeImagePreview();
                }
            };
        }

        // å…³é—­å›¾ç‰‡é¢„è§ˆ
        function closeImagePreview() {
            const modal = document.getElementById('imagePreviewModal');
            modal.style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        // æŒ‰ESCé”®å…³é—­é¢„è§ˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImagePreview();
            }
        });
    </script>
</body>
</html>